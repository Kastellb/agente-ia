<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>St. Mary’s College — English Leveler v3.0</title>
    <style>
        :root {
            --brand: #0b3b71;
            --bg: #eef2f7;
            --bot: #0b88e6;
            --user: #12b886;
            --accent: #ff6b6b;
            --light: #f8f9fa;
            --dark: #343a40;
            --correct: #22c55e;
            --incorrect: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: #0f172a;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--brand) 0%, #1e5799 100%);
            color: #fff;
            padding: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 800;
        }

        .badge {
            font-size: 12px;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 10px;
            border-radius: 12px;
        }

        main {
            flex: 1;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .toolbar {
            background: #fff;
            border-radius: 14px;
            padding: 12px 16px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.08);
        }

        .label {
            font-weight: 700;
            color: var(--dark);
        }

        #lesson {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            background: #f8fafc;
            min-width: 200px;
        }

        .status {
            font-size: 13px;
            color: #334155;
            background: #0b3b7112;
            border: 1px dashed #0b3b7130;
            padding: 8px 12px;
            border-radius: 10px;
            min-height: 38px;
            display: flex;
            align-items: center;
            flex: 1;
        }

        .voice-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .voice-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
        }

        .voice-slider {
            width: 100px;
        }

        .chat-container {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(2, 6, 23, 0.12);
            min-height: 60vh;
            display: flex;
            flex-direction: column;
        }

        #chat {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 10px;
            max-height: 50vh;
        }

        .msg {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            line-height: 1.5;
            white-space: pre-wrap;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg.bot {
            background: var(--bot);
            color: #fff;
            border-bottom-left-radius: 6px;
            align-self: flex-start;
        }

        .msg.user {
            background: var(--user);
            color: #fff;
            border-bottom-right-radius: 6px;
            align-self: flex-end;
        }

        .msg.welcome {
            background: linear-gradient(135deg, #8a2387 0%, #e94057 50%, #f27121 100%);
            color: white;
            text-align: center;
            padding: 20px;
            align-self: center;
            max-width: 90%;
        }

        .bot-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bot);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .msg-controls {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .msg-control {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            color: #fff;
            cursor: pointer;
        }

        .inline-btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 8px 0 4px;
        }

        .inline-btn {
            border: 0;
            border-radius: 12px;
            padding: 10px 16px;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            background: var(--bot);
        }

        .inline-btn.secondary {
            background: #6b7280;
        }

        .composer {
            background: #fff;
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 8px 24px rgba(2, 6, 23, 0.08);
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        #text {
            width: 100%;
            border: 0;
            outline: 0;
            font-size: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            background: #f7f9fc;
        }

        .btnrow {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            border: 0;
            border-radius: 12px;
            padding: 10px 16px;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #send { background: #22c55e; } 
        #mic { background: #0ea5e9; } 
        #stop { background: #ef4444; }

        .quiz-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }

        .quiz-question {
            font-weight: 600;
            margin-bottom: 15px;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quiz-option {
            padding: 12px;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quiz-option:hover {
            background: #f1f5f9;
        }

        .quiz-option.correct {
            background: var(--correct);
            color: white;
        }

        .quiz-option.incorrect {
            background: var(--incorrect);
            color: white;
        }

        .quiz-result {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        .quiz-pass {
            background: var(--correct);
            color: white;
        }

        .quiz-fail {
            background: var(--incorrect);
            color: white;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 14px;
            background: #fff;
            border-top: 1px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .voice-controls {
                margin-left: 0;
                width: 100%;
            }
            
            .voice-slider {
                flex-grow: 1;
            }
            
            .msg {
                max-width: 90%;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .badge {
                margin-top: 8px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 18px;
            }
            
            .container {
                gap: 12px;
            }
            
            .chat-container {
                padding: 16px;
            }
            
            .composer {
                padding: 10px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            #text {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>St. Mary’s College — English Leveler v3.0</h1>
        <span class="badge">Enhanced Voice • EN only • Adaptive Learning</span>
    </header>

    <main>
        <div class="container">
            <div class="toolbar">
                <span class="label">Select lesson:</span>
                <select id="lesson" aria-label="Select lesson">
                    <option value="">-- Select a lesson --</option>
                    <option value="1">Lesson 1: Greetings and Introductions</option>
                    <option value="2">Lesson 2: Everyday Conversations</option>
                    <option value="3">Lesson 3: Present Simple Tense</option>
                    <option value="4">Lesson 4: Past Simple Tense</option>
                    <option value="5">Lesson 5: Future Tenses</option>
                    <option value="6">Lesson 6: Adjectives and Adverbs</option>
                    <option value="7">Lesson 7: Prepositions of Place</option>
                    <option value="8">Lesson 8: Prepositions of Time</option>
                    <option value="9">Lesson 9: Modal Verbs</option>
                    <option value="10">Lesson 10: Conditionals</option>
                    <option value="11">Lesson 11: Vocabulary Expansion</option>
                    <option value="12">Lesson 12: Pronunciation Practice</option>
                </select>
                <div class="voice-controls">
                    <span class="voice-label">Speed:</span>
                    <input type="range" id="voiceSpeed" class="voice-slider" min="0.5" max="2" step="0.1" value="1">
                    <span id="speedValue">1.0x</span>
                </div>
                <span id="status" class="status">Please select a lesson to begin.</span>
            </div>

            <div class="chat-container">
                <div id="chat" aria-live="polite">
                    <div class="msg welcome">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">Welcome to English Leveler!</div>
                        <div>I'm your English learning assistant. Please select a lesson to begin.</div>
                    </div>
                </div>

                <div class="composer">
                    <input id="text" placeholder="Type your message or ask a question..." autocomplete="off">
                    <div class="btnrow">
                        <button id="send" class="btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                            </svg>
                            Send
                        </button>
                        <button id="mic" class="btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 14C13.66 14 15 12.66 15 11V5C15 3.34 13.66 2 12 2C10.34 2 9 3.34 9 5V11C9 12.66 10.34 14 12 14Z" fill="currentColor"/>
                                <path d="M17 11C17 14.31 14.31 17 11 17C7.69 17 5 14.31 5 11H3C3 15.42 6.58 19 11 19C15.42 19 19 15.42 19 11H17Z" fill="currentColor"/>
                            </svg>
                            Speak
                        </button>
                        <button id="stop" class="btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 6H18V18H6V6Z" fill="currentColor"/>
                            </svg>
                            Stop
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>St. Mary's College English Leveler v3.0 • © 2023 All rights reserved</p>
    </footer>

    <script>
        // Configuración
        const PASS_MARK = 90;
        const MAX_QUESTIONS = 5;
        
        // Elementos DOM
        const chat = document.getElementById('chat');
        const input = document.getElementById('text');
        const sendBtn = document.getElementById('send');
        const micBtn = document.getElementById('mic');
        const stopBtn = document.getElementById('stop');
        const lessonSel = document.getElementById('lesson');
        const statusEl = document.getElementById('status');
        const voiceSpeed = document.getElementById('voiceSpeed');
        const speedValue = document.getElementById('speedValue');
        
        // Estado de la aplicación
        let currentLesson = null;
        let quizState = null;
        let isSpeaking = false;
        let speechRate = parseFloat(voiceSpeed.value);
        let isListening = false;
        
        // Datos de ejemplo para lecciones y preguntas
        const lessonData = {
            1: {
                title: "Greetings and Introductions",
                theory: "In this lesson, you will learn how to greet people, introduce yourself, and ask basic questions in English.",
                objectives: [
                    "Learn formal and informal greetings",
                    "Practice introducing yourself and others",
                    "Understand appropriate responses to greetings"
                ],
                topics: [
                    "Hello, Hi, Hey variations",
                    "Formal vs informal greetings",
                    "Asking 'How are you?' and responding appropriately",
                    "Introducing yourself and others"
                ]
            },
            2: {
                title: "Everyday Conversations",
                theory: "This lesson focuses on common everyday conversations you might encounter in English-speaking environments.",
                objectives: [
                    "Master common conversational phrases",
                    "Practice asking for information and assistance",
                    "Develop confidence in everyday interactions"
                ],
                topics: [
                    "Asking for directions",
                    "Ordering food and drinks",
                    "Shopping vocabulary and phrases",
                    "Making small talk about weather and hobbies"
                ]
            },
            3: {
                title: "Present Simple Tense",
                theory: "The Present Simple tense is used to describe habits, unchanging situations, general truths, and fixed arrangements.",
                objectives: [
                    "Understand when to use Present Simple",
                    "Learn the structure of affirmative, negative and interrogative forms",
                    "Practice using third person singular correctly"
                ],
                topics: [
                    "Forming Present Simple statements",
                    "Creating questions and negatives",
                    "Third person singular rules",
                    "Adverbs of frequency with Present Simple"
                ]
            },
            4: {
                title: "Past Simple Tense",
                theory: "The Past Simple tense is used to talk about completed actions or events in the past.",
                objectives: [
                    "Understand when to use Past Simple",
                    "Learn regular and irregular verb forms",
                    "Practice forming questions and negatives"
                ],
                topics: [
                    "Regular verbs: adding -ed",
                    "Common irregular verbs",
                    "Time expressions with past simple",
                    "Forming questions and negatives"
                ]
            },
            5: {
                title: "Future Tenses",
                theory: "English has several ways to talk about the future, each with different meanings and uses.",
                objectives: [
                    "Learn different future forms: will, going to, present continuous",
                    "Understand when to use each future form",
                    "Practice making predictions and plans"
                ],
                topics: [
                    "Will for predictions and spontaneous decisions",
                    "Going to for plans and intentions",
                    "Present continuous for arrangements",
                    "Future time expressions"
                ]
            },
            6: {
                title: "Adjectives and Adverbs",
                theory: "Adjectives describe nouns, while adverbs describe verbs, adjectives, or other adverbs.",
                objectives: [
                    "Understand the difference between adjectives and adverbs",
                    "Learn comparative and superlative forms",
                    "Practice correct placement in sentences"
                ],
                topics: [
                    "Adjective order in English",
                    "Forming adverbs from adjectives",
                    "Comparative and superlative forms",
                    "Irregular comparatives and superlatives"
                ]
            },
            7: {
                title: "Prepositions of Place",
                theory: "Prepositions of place describe the position or location of something.",
                objectives: [
                    "Learn common prepositions of place",
                    "Understand subtle differences between similar prepositions",
                    "Practice using prepositions in context"
                ],
                topics: [
                    "Basic prepositions: in, on, at",
                    "Directional prepositions: to, into, onto",
                    "Position prepositions: under, over, between",
                    "Prepositions with transportation"
                ]
            },
            8: {
                title: "Prepositions of Time",
                theory: "Prepositions of time help indicate when something happens.",
                objectives: [
                    "Learn common prepositions of time",
                    "Understand the differences between in, on, at for time",
                    "Practice using time expressions correctly"
                ],
                topics: [
                    "In for months, years, seasons",
                    "On for days and dates",
                    "At for specific times",
                    "Time expressions: for, since, during, until"
                ]
            },
            9: {
                title: "Modal Verbs",
                theory: "Modal verbs are auxiliary verbs that express ability, possibility, permission, or obligation.",
                objectives: [
                    "Learn the main modal verbs: can, could, may, might, must, should",
                    "Understand different uses of modal verbs",
                    "Practice using modals in different contexts"
                ],
                topics: [
                    "Ability: can, could, be able to",
                    "Permission: may, can, could",
                    "Obligation: must, have to, should",
                    "Possibility: might, may, could"
                ]
            },
            10: {
                title: "Conditionals",
                theory: "Conditionals are sentences with 'if' clauses that describe hypothetical situations and their consequences.",
                objectives: [
                    "Learn the four main conditional types",
                    "Understand when to use each conditional",
                    "Practice forming conditional sentences correctly"
                ],
                topics: [
                    "Zero conditional for general truths",
                    "First conditional for real future possibilities",
                    "Second conditional for unreal present or future",
                    "Third conditional for unreal past situations"
                ]
            },
            11: {
                title: "Vocabulary Expansion",
                theory: "Building a strong vocabulary is essential for effective communication in English.",
                objectives: [
                    "Learn strategies for vocabulary acquisition",
                    "Expand topic-specific vocabulary",
                    "Practice using new words in context"
                ],
                topics: [
                    "Word families and word formation",
                    "Collocations and common word pairs",
                    "Idioms and phrasal verbs",
                    "Topic vocabulary: work, travel, education"
                ]
            },
            12: {
                title: "Pronunciation Practice",
                theory: "Good pronunciation helps ensure you're understood and improves your confidence when speaking English.",
                objectives: [
                    "Learn key aspects of English pronunciation",
                    "Practice difficult sounds for your language background",
                    "Improve stress and intonation patterns"
                ],
                topics: [
                    "Vowel sounds and minimal pairs",
                    "Consonant clusters and difficult sounds",
                    "Word stress and sentence stress",
                    "Intonation patterns for questions and statements"
                ]
            }
        };
        
        // Preguntas de evaluación por lección
        const quizQuestions = {
            1: [
                {
                    question: "Which greeting is most formal?",
                    options: ["Hey", "Hi", "Hello", "What's up"],
                    answer: 2
                },
                {
                    question: "How would you respond to 'How are you?' in a formal setting?",
                    options: ["I'm good", "Fine, thanks", "I'm well, thank you. And you?", "Not bad"],
                    answer: 2
                },
                {
                    question: "Which is a proper introduction?",
                    options: ["Me John", "This is John", "Him John", "John is here"],
                    answer: 1
                },
                {
                    question: "What's an appropriate response to 'Nice to meet you'?",
                    options: ["Me too", "Same here", "Nice to meet you too", "Also"],
                    answer: 2
                },
                {
                    question: "Which phrase would you use to say goodbye formally?",
                    options: ["See ya!", "Bye", "Goodbye", "Catch you later"],
                    answer: 2
                }
            ],
            2: [
                {
                    question: "How would you ask for directions to the library?",
                    options: [
                        "Where library?",
                        "How to get library?",
                        "Could you tell me how to get to the library?",
                        "Library where?"
                    ],
                    answer: 2
                },
                {
                    question: "What would you say to order a coffee?",
                    options: [
                        "Give me coffee",
                        "I want coffee",
                        "I'll have a coffee, please",
                        "Coffee now"
                    ],
                    answer: 2
                },
                {
                    question: "How would you ask for the price of something in a shop?",
                    options: [
                        "How much cost?",
                        "What is the price?",
                        "How much is this?",
                        "Money for this?"
                    ],
                    answer: 2
                },
                {
                    question: "Which is the best way to ask for help in a store?",
                    options: [
                        "Help me!",
                        "Excuse me, could you help me?",
                        "I need help",
                        "You, help"
                    ],
                    answer: 1
                },
                {
                    question: "What would you say to decline an offer politely?",
                    options: [
                        "No",
                        "No, thanks",
                        "I don't want",
                        "Not for me"
                    ],
                    answer: 1
                }
            ],
            3: [
                {
                    question: "Which sentence is in the present simple tense?",
                    options: [
                        "I am going to school",
                        "I go to school every day",
                        "I went to school yesterday",
                        "I will go to school tomorrow"
                    ],
                    answer: 1
                },
                {
                    question: "How do you form the third person singular in present simple?",
                    options: [
                        "Always add -s",
                        "Add -s to most verbs",
                        "Add -es to all verbs",
                        "No change needed"
                    ],
                    answer: 1
                },
                {
                    question: "Which sentence is correct?",
                    options: [
                        "She don't like apples",
                        "She doesn't like apples",
                        "She doesn't likes apples",
                        "She not like apples"
                    ],
                    answer: 1
                },
                {
                    question: "Which time expression is typically used with present simple?",
                    options: [
                        "now",
                        "at the moment",
                        "every day",
                        "yesterday"
                    ],
                    answer: 2
                },
                {
                    question: "How do you form a question in present simple?",
                    options: [
                        "Do/Does + subject + base verb",
                        "Subject + do/does + base verb",
                        "Am/Is/Are + subject + verb",
                        "Subject + verb + -ing"
                    ],
                    answer: 0
                }
            ],
            4: [
                {
                    question: "Which sentence is in the past simple tense?",
                    options: [
                        "I have finished my homework",
                        "I am finishing my homework",
                        "I finished my homework",
                        "I will finish my homework"
                    ],
                    answer: 2
                },
                {
                    question: "What is the past simple form of 'go'?",
                    options: [
                        "goed",
                        "went",
                        "gone",
                        "goes"
                    ],
                    answer: 1
                },
                {
                    question: "How do you form the negative in past simple?",
                    options: [
                        "didn't + base verb",
                        "wasn't/weren't + base verb",
                        "haven't + base verb",
                        "not + past verb"
                    ],
                    answer: 0
                },
                {
                    question: "Which time expression is typically used with past simple?",
                    options: [
                        "now",
                        "already",
                        "yesterday",
                        "for two years"
                    ],
                    answer: 2
                },
                {
                    question: "What is the past simple form of 'study'?",
                    options: [
                        "studyed",
                        "studied",
                        "studying",
                        "studieded"
                    ],
                    answer: 1
                }
            ],
            5: [
                {
                    question: "Which sentence expresses a future plan?",
                    options: [
                        "I will probably go to the party",
                        "I'm going to visit my parents next weekend",
                        "The train leaves at 5 PM",
                        "I think it will rain tomorrow"
                    ],
                    answer: 1
                },
                {
                    question: "Which future form is used for predictions based on evidence?",
                    options: [
                        "will",
                        "going to",
                        "present continuous",
                        "present simple"
                    ],
                    answer: 1
                },
                {
                    question: "Which sentence uses the present continuous for future?",
                    options: [
                        "I'm meeting friends tonight",
                        "I meet friends every week",
                        "I'll meet you later",
                        "I'm going to meet you later"
                    ],
                    answer: 0
                },
                {
                    question: "Which future form is used for scheduled events?",
                    options: [
                        "will",
                        "going to",
                        "present continuous",
                        "present simple"
                    ],
                    answer: 3
                },
                {
                    question: "Which sentence offers to help?",
                    options: [
                        "I'll help you with that",
                        "I'm helping you",
                        "I help you",
                        "I'm going to help you"
                    ],
                    answer: 0
                }
            ]
            // Más preguntas para las lecciones restantes...
        };
        
        // Función para añadir mensaje al chat
        function addMsg(text, who = "bot") {
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg ${who}`;
            
            if (who === "bot") {
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.alignItems = 'flex-start';
                
                const avatar = document.createElement('div');
                avatar.className = 'bot-avatar';
                avatar.textContent = 'SMC';
                avatar.setAttribute('aria-label', 'St. Mary\'s College assistant');
                
                const content = document.createElement('div');
                content.textContent = text;
                
                container.appendChild(avatar);
                container.appendChild(content);
                msgDiv.appendChild(container);
                
                // Controles de voz
                const controls = document.createElement('div');
                controls.className = 'msg-controls';
                const speakButton = document.createElement('button');
                speakButton.className = 'msg-control';
                speakButton.setAttribute('aria-label', 'Read message aloud');
                speakButton.innerHTML = `
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9V15H7L12 20V4L7 9H3Z" fill="currentColor"/>
                    </svg>
                    Speak
                `;
                speakButton.onclick = function() {
                    speakMessage(text);
                };
                controls.appendChild(speakButton);
                msgDiv.appendChild(controls);
            } else {
                msgDiv.textContent = text;
            }
            
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
            return msgDiv;
        }
        
        // Función para sintetizar voz
        function speak(text, rate = speechRate) {
            if ('speechSynthesis' in window) {
                try {
                    window.speechSynthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = rate;
                    
                    // Buscar voz en inglés
                    const voices = window.speechSynthesis.getVoices();
                    const englishVoice = voices.find(voice => 
                        voice.lang.startsWith('en-') || voice.lang.startsWith('en_')
                    );
                    
                    if (englishVoice) {
                        utterance.voice = englishVoice;
                    }
                    
                    utterance.onstart = () => {
                        isSpeaking = true;
                        stopBtn.disabled = false;
                    };
                    
                    utterance.onend = () => {
                        isSpeaking = false;
                        stopBtn.disabled = true;
                    };
                    
                    utterance.onerror = (event) => {
                        console.error('Speech synthesis error:', event);
                        isSpeaking = false;
                        stopBtn.disabled = true;
                    };
                    
                    window.speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error('Error with speech synthesis:', error);
                }
            }
        }
        
        // Función para hablar mensaje (corregida)
        function speakMessage(text) {
            speak(text);
        }
        
        // Función para detener voz
        function stopSpeech() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                stopBtn.disabled = true;
            }
            
            if (isListening && recognition) {
                recognition.stop();
                isListening = false;
                micBtn.textContent = 'Speak';
            }
        }
        
        // Función para cargar lección
        function loadLesson(lessonNum) {
            currentLesson = lessonNum;
            
            // Limpiar chat
            chat.innerHTML = '';
            
            // Verificar si necesita evaluación previa
            if (lessonNum > 1) {
                const previousLesson = lessonNum - 1;
                statusEl.textContent = `Before starting Lesson ${lessonNum}, you need to pass a review of Lesson ${previousLesson}.`;
                
                addMsg(`Before we begin Lesson ${lessonNum}, you need to complete a short review of Lesson ${previousLesson}. You must score at least ${PASS_MARK}% to proceed.`, "bot");
                
                // Mostrar botones para comenzar evaluación
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'inline-btns';
                
                const startBtn = document.createElement('button');
                startBtn.className = 'inline-btn';
                startBtn.textContent = 'Start Review';
                startBtn.onclick = () => startQuiz(previousLesson);
                
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'inline-btn secondary';
                cancelBtn.textContent = 'Not Now';
                cancelBtn.onclick = () => {
                    addMsg(`No problem. When you're ready, select Lesson ${lessonNum} again to start the review.`, "bot");
                };
                
                buttonsDiv.appendChild(startBtn);
                buttonsDiv.appendChild(cancelBtn);
                chat.appendChild(buttonsDiv);
                
                return;
            }
            
            // Si es la lección 1 o ya pasó la evaluación
            statusEl.textContent = `Lesson ${lessonNum} - ${lessonData[lessonNum].title}`;
            
            // Mostrar contenido de la lección
            addMsg(`Lesson ${lessonNum}: ${lessonData[lessonNum].title}`, "bot");
            addMsg(lessonData[lessonNum].theory, "bot");
            
            // Objetivos
            addMsg("Objectives:", "bot");
            lessonData[lessonNum].objectives.forEach((obj, i) => {
                addMsg(`${i+1}. ${obj}`, "bot");
            });
            
            // Temas
            addMsg("Topics:", "bot");
            lessonData[lessonNum].topics.forEach((topic, i) => {
                addMsg(`${i+1}. ${topic}`, "bot");
            });
            
            addMsg("What would you like to know or practice from this lesson?", "bot");
            speak("Welcome to Lesson " + lessonNum + ". " + lessonData[lessonNum].theory);
        }
        
        // Función para iniciar evaluación
        function startQuiz(lessonNum) {
            quizState = {
                lesson: lessonNum,
                questions: quizQuestions[lessonNum] || [],
                currentQuestion: 0,
                score: 0
            };
            
            if (quizState.questions.length === 0) {
                addMsg("No review questions available for this lesson. You can proceed to the next lesson.", "bot");
                loadLesson(currentLesson);
                return;
            }
            
            // Limitar a máximo de preguntas
            if (quizState.questions.length > MAX_QUESTIONS) {
                quizState.questions = quizState.questions.slice(0, MAX_QUESTIONS);
            }
            
            chat.innerHTML = '';
            addMsg(`Review of Lesson ${lessonNum} - Answer the following questions:`, "bot");
            displayQuestion();
        }
        
        // Función para mostrar pregunta
        function displayQuestion() {
            const question = quizState.questions[quizState.currentQuestion];
            
            const quizDiv = document.createElement('div');
            quizDiv.className = 'quiz-container';
            
            const questionEl = document.createElement('div');
            questionEl.className = 'quiz-question';
            questionEl.textContent = `Question ${quizState.currentQuestion + 1}/${quizState.questions.length}: ${question.question}`;
            
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'quiz-options';
            
            question.options.forEach((option, index) => {
                const optionBtn = document.createElement('div');
                optionBtn.className = 'quiz-option';
                optionBtn.textContent = option;
                optionBtn.setAttribute('role', 'button');
                optionBtn.setAttribute('tabindex', '0');
                optionBtn.onclick = () => checkAnswer(index);
                optionBtn.onkeypress = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        checkAnswer(index);
                    }
                };
                optionsDiv.appendChild(optionBtn);
            });
            
            quizDiv.appendChild(questionEl);
            quizDiv.appendChild(optionsDiv);
            chat.appendChild(quizDiv);
            
            speak(`Question ${quizState.currentQuestion + 1}. ${question.question}`);
        }
        
        // Función para verificar respuesta
        function checkAnswer(selectedIndex) {
            const question = quizState.questions[quizState.currentQuestion];
            const options = document.querySelectorAll('.quiz-option');
            
            // Deshabilitar opciones
            options.forEach(opt => {
                opt.onclick = null;
                opt.onkeypress = null;
                opt.style.cursor = 'default';
                opt.setAttribute('tabindex', '-1');
            });
            
            // Marcar respuesta correcta/incorrecta
            if (selectedIndex === question.answer) {
                options[selectedIndex].classList.add('correct');
                quizState.score++;
                speak("Correct!");
            } else {
                options[selectedIndex].classList.add('incorrect');
                options[question.answer].classList.add('correct');
                speak("Incorrect. The right answer is: " + question.options[question.answer]);
            }
            
            // Esperar y mostrar siguiente pregunta o resultados
            setTimeout(() => {
                quizState.currentQuestion++;
                
                if (quizState.currentQuestion < quizState.questions.length) {
                    chat.innerHTML = '';
                    displayQuestion();
                } else {
                    showQuizResults();
                }
            }, 2000);
        }
        
        // Función para mostrar resultados del quiz
        function showQuizResults() {
            const scorePercent = Math.round((quizState.score / quizState.questions.length) * 100);
            
            chat.innerHTML = '';
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `quiz-result ${scorePercent >= PASS_MARK ? 'quiz-pass' : 'quiz-fail'}`;
            resultDiv.textContent = `Your score: ${quizState.score}/${quizState.questions.length} (${scorePercent}%)`;
            
            chat.appendChild(resultDiv);
            
            if (scorePercent >= PASS_MARK) {
                addMsg(`Congratulations! You passed the review with ${scorePercent}%. Now let's start Lesson ${currentLesson}.`, "bot");
                speak(`Congratulations! You passed with ${scorePercent} percent. Now let's start Lesson ${currentLesson}.`);
                
                // Cargar lección actual después de pasar la evaluación
                setTimeout(() => loadLesson(currentLesson), 3000);
            } else {
                addMsg(`You scored ${scorePercent}%, but you need at least ${PASS_MARK}% to proceed. Please review Lesson ${quizState.lesson} and try again.`, "bot");
                speak(`You scored ${scorePercent} percent, but you need at least ${PASS_MARK} percent to proceed. Please review the previous lesson and try again.`);
                
                // Botón para reintentar
                const retryBtn = document.createElement('button');
                retryBtn.className = 'inline-btn';
                retryBtn.textContent = 'Try Again';
                retryBtn.onclick = () => startQuiz(quizState.lesson);
                chat.appendChild(retryBtn);
            }
        }
        
        // Función para enviar mensaje
        function sendMessage() {
            const text = input.value.trim();
            if (!text) return;
            
            input.value = '';
            addMsg(text, "user");
            
            // Mostrar indicador de escritura
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'msg bot';
            typingIndicator.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <div class="bot-avatar">SMC</div>
                    <div class="loading"></div>
                </div>
            `;
            chat.appendChild(typingIndicator);
            chat.scrollTop = chat.scrollHeight;
            
            // Aquí se integraría con Groq API para obtener respuesta
            // Por ahora simulamos una respuesta después de un breve retraso
            setTimeout(() => {
                chat.removeChild(typingIndicator);
                
                const responses = [
                    "That's a great question! In English, we usually say...",
                    "I understand what you're asking. The correct way to say that is...",
                    "Good question! The answer is...",
                    "Let me explain that concept to you...",
                    "Here's how we typically express that in English..."
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addMsg(randomResponse, "bot");
                speak(randomResponse);
            }, 1500);
        }
        
        // Inicializar reconocimiento de voz (si está disponible)
        let recognition = null;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                input.value = transcript;
                isListening = false;
                micBtn.textContent = 'Speak';
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error', event.error);
                isListening = false;
                micBtn.textContent = 'Speak';
                addMsg("Sorry, I didn't catch that. Could you try again?", "bot");
            };
            
            recognition.onend = function() {
                if (isListening) {
                    isListening = false;
                    micBtn.textContent = 'Speak';
                }
            };
        } else {
            micBtn.disabled = true;
            micBtn.title = "Speech recognition not supported";
        }
        
        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        micBtn.addEventListener('click', () => {
            if (recognition && !isListening) {
                try {
                    recognition.start();
                    isListening = true;
                    micBtn.textContent = 'Listening...';
                } catch (error) {
                    console.error('Speech recognition start error:', error);
                    addMsg("Speech recognition is not available right now. Please type your message instead.", "bot");
                }
            }
        });
        
        stopBtn.addEventListener('click', stopSpeech);
        stopBtn.disabled = true;
        
        lessonSel.addEventListener('change', () => {
            const lessonNum = parseInt(lessonSel.value);
            if (lessonNum) {
                loadLesson(lessonNum);
            } else {
                chat.innerHTML = '';
                addMsg("Please select a lesson to begin.", "bot");
                statusEl.textContent = "Please select a lesson to begin.";
            }
        });
        
        voiceSpeed.addEventListener('input', () => {
            speechRate = parseFloat(voiceSpeed.value);
            speedValue.textContent = speechRate.toFixed(1) + 'x';
        });
        
        // Inicializar voces
        if ('speechSynthesis' in window) {
            // Forzar la carga de voces en algunos navegadores
            window.speechSynthesis.getVoices();
            
            window.speechSynthesis.onvoiceschanged = function() {
                // Voces cargadas
                console.log('Voices loaded');
            };
        }
        
        // Mejorar accesibilidad
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                stopSpeech();
            }
        });
    </script>
</body>
</html>
