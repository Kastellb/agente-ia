<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>St. Mary‚Äôs College</title>
  <style>
    :root{
      --bg:#f5f7fa; --ink:#0f172a; --bot:#0ea5e9; --user:#22c55e; --muted:#64748b;
      --focus:#2563eb; --overlay: rgba(15,23,42,.55);
      --chip:#ffffff; --chip-border:#cbd5e1; --chip-ink:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);
         display:flex;flex-direction:column;min-height:100vh}
    header{background:#0b3b71;color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;
           font-weight:700;gap:8px;flex-wrap:wrap}
    .btn{border:0;padding:12px 14px;font-weight:700;cursor:pointer;border-radius:12px;color:#fff;min-height:48px}
    .btn-lessons{background:#7c3aed}
    #chat{flex:1;max-width:900px;width:100%;margin:16px auto;padding:0 12px}
    .bubble{max-width:75%;padding:12px 14px;margin:8px 0;border-radius:14px;line-height:1.45;box-shadow:0 4px 12px rgba(2,8,23,.08)}
    .bot{background:var(--bot);color:#fff;border-bottom-left-radius:4px}
    .user{background:var(--user);color:#fff;margin-left:auto;border-bottom-right-radius:4px}
    .sys{background:#e2e8f0;color:#0f172a;margin:16px auto;border-radius:10px}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#e2e8f0;padding:1px 6px;border-radius:6px}
    .bot .kbd{background:#fff;color:#0f172a}

    #controls{position:sticky;bottom:0;background:#fff;border-top:1px solid #e2e8f0;
      padding:10px clamp(10px,3vw,16px) calc(10px + env(safe-area-inset-bottom)) clamp(10px,3vw,16px);
      display:grid;grid-template-columns:1fr;gap:10px}
    #textInput{width:100%;padding:12px 14px;font-size:16px;border:1px solid #cbd5e1;border-radius:12px;outline:0;min-height:48px}
    #textInput:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(37,99,235,.2)}
    .buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    #sendBtn{background:#22c55e} #speakBtn{background:#0ea5e9} #stopBtn{background:#ef4444}
    @media (min-width:720px){#controls{display:flex;align-items:center;gap:10px;padding-bottom:12px}
      #textInput{flex:1}.buttons{display:flex;gap:10px}}

    /* Lessons overlay */
    #lessonsOverlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:50}
    #lessonsCard{width:min(820px,94vw);background:#fff;border-radius:16px;padding:16px;box-shadow:0 16px 40px rgba(2,8,23,.35);
      display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row input{flex:1;min-width:220px;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px}
    .btn-go{background:#0ea5e9;color:#fff;border:0;padding:10px 12px;border-radius:10px}
    .btn-close{background:#334155;color:#fff;border:0;padding:10px 12px;border-radius:10px}
    .pager{display:flex;gap:8px;flex-wrap:wrap}
    .page-btn{background:#fff;color:#0f172a;border:1px solid #cbd5e1;padding:6px 10px;border-radius:999px;cursor:pointer}
    .page-btn.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px;max-height:340px;overflow:auto;padding:4px}
    .chip{background:var(--chip);border:1px solid var(--chip-border);color:var(--chip-ink);padding:8px 10px;border-radius:999px;
      box-shadow:0 2px 4px rgba(2,8,23,.06);cursor:pointer;font-weight:700;text-align:center}
    .note{font-size:14px;color:#64748b}
  </style>
</head>
<body>
  <header>
    <div>St. Mary‚Äôs College</div>
    <div class="right">
      <button class="btn btn-lessons" id="openLessonsBtn">üìö Lessons</button>
    </div>
  </header>

  <main id="chat"></main>

  <div id="controls">
    <input id="textInput" type="text" placeholder='Type or say your message‚Ä¶ e.g., "Lesson 7"' autocomplete="off"/>
    <div class="buttons">
      <button id="sendBtn"  class="btn">Send</button>
      <button id="speakBtn" class="btn">üé§ Speak</button>
      <button id="stopBtn"  class="btn">‚èπ Stop</button>
    </div>
  </div>

  <!-- Lessons overlay -->
  <div id="lessonsOverlay" role="dialog" aria-modal="true">
    <div id="lessonsCard">
      <h3>Select a lesson</h3>
      <div class="note" id="rangeNote">Loading available lessons‚Ä¶</div>
      <div class="row">
        <input id="numInput" type="number" min="1" max="270" placeholder="Go to lesson # (e.g., 12)"/>
        <input id="wordsInput" type="text" placeholder="Or type in words (e.g., twenty three)"/>
        <button class="btn-go" id="goBtn">Go</button>
        <button class="btn-close" id="closeLessonsBtn">Close</button>
      </div>
      <div class="pager" id="pager"></div>
      <div class="grid"  id="grid"></div>
      <div class="note">Tip: you can also type <span class="kbd">Lesson 12</span> in the chat.</div>
    </div>
  </div>

<script>
/* =================== Utilities =================== */
const chat = document.getElementById("chat");
function addMessage(html, role="bot"){
  const el=document.createElement("div");
  el.className=`bubble ${role}`;
  el.innerHTML=html;
  chat.appendChild(el);
  chat.scrollTop=chat.scrollHeight;
}
function addSystem(text){
  const el=document.createElement("div");
  el.className="bubble sys";
  el.textContent=text;
  chat.appendChild(el);
  chat.scrollTop=chat.scrollHeight;
}

/* English-only quick guard (suave, no bloquea input) */
const SPAN_RE=/[√°√©√≠√≥√∫√±√º¬ø¬°]/i;
function looksSpanish(s){ return SPAN_RE.test(s||""); }

/* TTS limpio y seguro */
function sanitizeForSpeech(t){
  t=String(t||"");
  t=t.replace(/<[^>]*>/g," ");
  t=t.replace(/\bhttps?:\/\/\S+/gi," ");
  try{ t=t.replace(/\p{Extended_Pictographic}/gu,""); }catch{ t=t.replace(/[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}]/gu,""); }
  t=t.replace(/&[a-z]+;/gi," ").replace(/\s{2,}/g," ").trim();
  return t;
}
function speakSafe(text){
  try{
    const msg=sanitizeForSpeech(text);
    if(!msg || looksSpanish(msg)) return;
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(msg);
    u.lang="en-US";
    speechSynthesis.speak(u);
  }catch{}
}

/* =================== Lessons (overlay + fetch) =================== */
const lessonsOverlay = document.getElementById("lessonsOverlay");
const openLessonsBtn = document.getElementById("openLessonsBtn");
const closeLessonsBtn = document.getElementById("closeLessonsBtn");
const rangeNote = document.getElementById("rangeNote");
const pager = document.getElementById("pager");
const grid = document.getElementById("grid");
const numInput = document.getElementById("numInput");
const wordsInput = document.getElementById("wordsInput");
const goBtn = document.getElementById("goBtn");

let availableLessons = [];
const PAGE_SIZE = 30; let pages=[]; let currentPage=0;

async function fetchAvailableLessons(){
  try{
    const r = await fetch("https://www.leccion.datafast.pw/lessons/index.json", {cache:"no-store"});
    if(!r.ok) throw 0;
    const idx = await r.json();
    const arr = Array.isArray(idx.available)? idx.available : [];
    availableLessons = arr.map(n=>parseInt(n,10)).filter(n=>!isNaN(n)).sort((a,b)=>a-b);
  }catch{
    availableLessons = []; // sin √≠ndice -> mostramos todo 1‚Äì270
  }
}
function makePages(list){ const out=[]; for(let i=0;i<list.length;i+=PAGE_SIZE) out.push(list.slice(i,i+PAGE_SIZE)); return out; }
function renderPager(){
  pager.innerHTML=""; if(pages.length<=1) return;
  pages.forEach((_,i)=>{
    const start=pages[i][0], end=pages[i][pages[i].length-1];
    const b=document.createElement("button");
    b.className="page-btn"+(i===currentPage?" active":"");
    b.textContent=`${start}‚Äì${end}`;
    b.onclick=()=>{ currentPage=i; renderGrid(); renderPager(); };
    pager.appendChild(b);
  });
}
function renderGrid(){
  grid.innerHTML="";
  if(!pages.length){ grid.innerHTML="<div class='note'>No lessons found.</div>"; return; }
  pages[currentPage].forEach(n=>{
    const c=document.createElement("div");
    c.className="chip"; c.textContent=`Lesson ${n}`;
    c.onclick=()=> beginLessonSelection(n);
    grid.appendChild(c);
  });
}
async function prepareLessonsOverlay(){
  await fetchAvailableLessons();
  const list = availableLessons.length ? availableLessons : Array.from({length:270},(_,i)=>i+1);
  pages=makePages(list); currentPage=0; renderPager(); renderGrid();
  if(availableLessons.length){
    rangeNote.textContent=`Available range: Lesson ${availableLessons[0]} to Lesson ${availableLessons[availableLessons.length-1]}.`;
  }else{
    rangeNote.textContent=`No index found. Showing 1‚Äì270 (full range).`;
  }
}
function openLessons(){ lessonsOverlay.style.display="flex"; numInput.focus(); }
function closeLessons(){ lessonsOverlay.style.display="none"; numInput.value=""; wordsInput.value=""; }
openLessonsBtn.onclick=()=>{ prepareLessonsOverlay().then(openLessons); };
closeLessonsBtn.onclick=closeLessons;
lessonsOverlay.addEventListener("click", e=>{ if(e.target===lessonsOverlay) closeLessons(); });

function wordsToNumber(phrase){
  const ones={zero:0,one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9};
  const teens={ten:10,eleven:11,twelve:12,thirteen:13,fourteen:14,fifteen:15,sixteen:16,seventeen:17,eighteen:18,nineteen:19};
  const tens={twenty:20,thirty:30,forty:40,fifty:50,sixty:60,seventy:70,eighty:80,ninety:90};
  let s=(phrase||"").toLowerCase().replace(/-/g," ").replace(/[^a-z\s]/g," ").replace(/\s+/g," ").trim();
  if(ones[s]!=null) return ones[s]; if(teens[s]!=null) return teens[s]; if(tens[s]!=null) return tens[s];
  const t=s.split(" "); let total=0,cur=0;
  for(const w of t){
    if(ones[w]!=null){ cur+=ones[w]; continue; }
    if(teens[w]!=null){ cur+=teens[w]; continue; }
    if(tens[w]!=null){ cur+=tens[w]; continue; }
    if(w==="hundred"){ if(cur===0) cur=1; cur*=100; total+=cur; cur=0; continue; }
    if(w==="and"){ continue; }
    return null;
  }
  total+=cur; return total||null;
}
function parseLessonNumberFromText(text){
  const s=(text||"").toLowerCase();
  const m=s.match(/lesson\s+(\d{1,3})\b/); if(m){ const n=parseInt(m[1],10); if(n>=1 && n<=270) return n; }
  const m2=s.match(/lesson\s+([a-z\s-]+)/); if(m2){ const n=wordsToNumber(m2[1]); if(n && n>=1 && n<=270) return n; }
  return null;
}

/* =================== Lesson + quiz (simple gate) =================== */
let currentLesson=null, lessonData=null;
const QUIZ_MIN=5, QUIZ_PASS=0.90;
let quizActive=false, quizIndex=0, quizCorrect=0, quizQuestions=[];
let pendingLesson=null, pendingData=null;
let sessionLocked=false;

async function fetchLessonJSON(num){
  try{
    const res=await fetch(`https://www.leccion.datafast.pw/lessons/lesson${num}.json`, {cache:"no-store"});
    if(!res.ok) return {ok:false};
    const data=await res.json();
    // suavizamos filtro: mostramos pero TTS no leer√° espa√±ol
    return {ok:true, data};
  }catch{ return {ok:false}; }
}
function normalize(s){ return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim(); }
function isAnswerCorrect(user, expected){
  const U=normalize(user), E=normalize(expected);
  if(!E) return false;
  if(U.includes(E)) return true;
  const et=E.split(" "), ut=new Set(U.split(" ")); const hits=et.filter(w=>ut.has(w)).length;
  if(et.length>=3 && hits/et.length>=0.8) return true;
  if(et.length<=2 && hits===et.length) return true;
  return false;
}
function askNextQuiz(){
  if(quizIndex>=quizQuestions.length){
    const total=quizQuestions.length, score=Math.round((quizCorrect/total)*100);
    const pass=score>=Math.ceil(QUIZ_PASS*100);
    addMessage(`Quiz finished. Score: <b>${quizCorrect}/${total}</b> = <b>${score}%</b>.`,"bot");
    if(pass){
      addMessage("‚úÖ Passed. Access granted to the selected lesson. Opening now‚Ä¶","bot");
      lessonData=pendingData; currentLesson=pendingLesson;
      const intro = `
        <b>Welcome to Lesson ${currentLesson}: ${lessonData.title||""}</b><br><br>
        <b>Theory:</b> ${lessonData.theory||"This lesson will guide you through the basics."}<br><br>
        <b>Objectives:</b><br>- ${(lessonData.objectives||[]).join("<br>- ")}<br><br>
        <b>Topics:</b><br>- ${(lessonData.topics||[]).join("<br>- ")}<br><br>
        Ask me anything about this lesson and I will explain, correct, and reinforce.
      `;
      addMessage(intro,"bot"); speakSafe("Lesson opened.");
      quizActive=false; quizQuestions=[]; quizIndex=0; quizCorrect=0;
    }else{
      addMessage("‚ùå You did not reach 90%. Please review the previous lesson. Session ended.","bot");
      speakSafe("You did not reach ninety percent. Please review the previous lesson. This session has ended.");
      quizActive=false; sessionLocked=true;
      input.disabled=true; sendBtn.disabled=true; speakBtn.disabled=true;
    }
    return;
  }
  const q=quizQuestions[quizIndex].q;
  addMessage(`(${quizIndex+1}/${quizQuestions.length}) <b>${q}</b>`,"bot");
  speakSafe(q);
}
async function startQuizGate(targetNum, targetData){
  if(targetNum===1){
    sessionLocked=false; input.disabled=false; sendBtn.disabled=false; speakBtn.disabled=false;
    lessonData=targetData; currentLesson=1;
    const intro=`
      <b>Welcome to Lesson 1: ${lessonData.title||""}</b><br><br>
      <b>Theory:</b> ${lessonData.theory||"This lesson will guide you through the basics."}<br><br>
      <b>Objectives:</b><br>- ${(lessonData.objectives||[]).join("<br>- ")}<br><br>
      <b>Topics:</b><br>- ${(lessonData.topics||[]).join("<br>- ")}<br><br>
      Ask me anything about this lesson and I will explain, correct, and reinforce.
    `;
    addMessage(intro,"bot"); speakSafe("Lesson one is open."); return;
  }
  const prev=await fetchLessonJSON(targetNum-1);
  if(!prev.ok){ addMessage(`Previous lesson (${targetNum-1}) is unavailable.`, "bot"); return; }
  const items=(prev.data.content||[]).filter(c=>c&&c.question&&c.answer);
  if(items.length<QUIZ_MIN){ addMessage(`Not enough questions in Lesson ${targetNum-1} to build a quiz.`, "bot"); return; }
  const shuffled=[...items].sort(()=>Math.random()-0.5).slice(0,Math.max(QUIZ_MIN, Math.min(10, items.length)));
  quizQuestions=shuffled.map(c=>({q:c.question,a:c.answer}));
  quizActive=true; quizIndex=0; quizCorrect=0; pendingLesson=targetNum; pendingData=targetData;
  addMessage(`To access <b>Lesson ${targetNum}: ${targetData.title||""}</b>, please answer these questions from <b>Lesson ${targetNum-1}</b>. You must score <b>‚â• 90%</b>.`,"bot");
  askNextQuiz();
}
async function beginLessonSelection(n){
  const r=await fetchLessonJSON(n);
  if(!r.ok){ addMessage(`Could not load Lesson ${n}.`, "bot"); return; }
  addMessage(`Lesson ${n} selected: <b>${r.data.title||""}</b>.`, "bot");
  if(n>1) addMessage(`Before we begin, I will ask you some questions from Lesson ${n-1}.`, "bot");
  await startQuizGate(n, r.data);
}

/* =================== Teacher =================== */
async function teacherResponse(userText){
  // Corrige y explica en ingl√©s (si el proxy falla, da una respuesta local corta)
  let answer="";
  try{
    const resp=await fetch("https://bot-maestro-proxy.kast-mercadeo.workers.dev/",{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({text:`ROLE: English teacher (English only). Keep answers concise and on-topic to the current lesson.
If the student writes in Spanish, reply in English and ask them to switch to English.
If you detect a grammar issue, first provide a corrected version, then explain briefly (1‚Äì2 lines), and give 1‚Äì2 examples.
Student says: "${userText}"`})
    });
    const data=await resp.json(); answer=data.reply||"";
  }catch{
    answer="Let's keep it short: could you rephrase your question about this lesson?";
  }
  if(looksSpanish(answer)) answer="(English only) Please keep the conversation in English.";
  addMessage(answer.replace(/\n/g,"<br>"),"bot"); speakSafe(answer);
}

/* =================== Input & speech =================== */
const input = document.getElementById("textInput");
const sendBtn = document.getElementById("sendBtn");
const speakBtn = document.getElementById("speakBtn");
const stopBtn = document.getElementById("stopBtn");

function parseLessonNumberFromUser(text){
  const n = parseLessonNumberFromText(text);
  return n;
}
async function handleUserMessage(text){
  if(!text) return;
  addMessage(text,"user");
  if(sessionLocked){ addMessage("This session has ended. Please start again later.", "bot"); return; }

  if(quizActive){
    const expected=quizQuestions[quizIndex].a;
    if(isAnswerCorrect(text, expected)){ quizCorrect++; addMessage("‚úÖ Correct.","bot"); }
    else{ addMessage(`‚ùå Incorrect. Expected: <b>${expected}</b>`, "bot"); }
    quizIndex++; askNextQuiz(); return;
  }

  const n = parseLessonNumberFromUser(text);
  if(n){ await beginLessonSelection(n); return; }

  if(lessonData){ await teacherResponse(text); }
  else{ addMessage(`Please choose a lesson first (e.g., <span class="kbd">Lesson 1</span>).`, "bot"); }
}
function sendMessage(){ const t=input.value.trim(); input.value=""; handleUserMessage(t); }
sendBtn.onclick = sendMessage;
input.addEventListener("keydown", e=>{ if(e.key==="Enter") sendMessage(); });

let recognition=null;
if("webkitSpeechRecognition" in window){
  recognition = new webkitSpeechRecognition();
  recognition.lang="en-US"; recognition.interimResults=false; recognition.maxAlternatives=1;
  recognition.onresult = e => { const t=e.results[0][0].transcript; handleUserMessage(t); };
}
speakBtn.onclick = ()=>{ if(recognition) recognition.start(); };
stopBtn.onclick  = ()=>{ try{ if(recognition) recognition.stop(); speechSynthesis.cancel(); }catch{} };

/* =================== Overlay actions =================== */
function goFromOverlay(){
  let n = parseInt(numInput.value,10);
  if(!n && wordsInput.value.trim()){ const w=wordsToNumber(wordsInput.value.trim()); if(w) n=w; }
  if(!n || n<1 || n>270){ addSystem("Please type a valid lesson number (1‚Äì270)."); return; }
  beginLessonSelection(n);
}
goBtn.onclick=goFromOverlay;
numInput.addEventListener("keydown", e=>{ if(e.key==="Enter") goFromOverlay(); });
wordsInput.addEventListener("keydown", e=>{ if(e.key==="Enter") goFromOverlay(); });

/* =================== Boot =================== */
(async function init(){
  // saludo SIEMPRE visible (sin depender de fetch)
  addMessage(`Welcome! Tell me which lesson you want to review (e.g., <span class="kbd">Lesson 1</span>).`,"bot");
  // luego intentamos el rango disponible (si falla, no afecta UI)
  try{
    await fetchAvailableLessons();
    if(availableLessons.length){
      addSystem(`Available range: Lesson ${availableLessons[0]} to Lesson ${availableLessons[availableLessons.length-1]}. Tap ‚Äúüìö Lessons‚Äù.`);
    }else{
      addSystem(`Tip: create <index.json> to control available lessons. Showing full range 1‚Äì270.`);
    }
  }catch{}
})();
</script>
</body>
</html>
