<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>St. Maryâ€™s College â€“ English Instructor (v1.5)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #1e3c72; margin:0; display:flex; flex-direction:column; height:100vh; }
    header { text-align:center; color:white; padding:10px; font-size:18px; background:#0d2b57; }
    #chat { flex:1; background:#f9f9f9; padding:10px; overflow-y:auto; display:flex; flex-direction:column; }
    .bubble { padding:10px; margin:5px; border-radius:10px; max-width:75%; line-height:1.4; }
    .user { background:#4CAF50; color:#fff; align-self:flex-end; }
    .bot { background:#2196F3; color:#fff; align-self:flex-start; white-space:pre-line; }
    #controls { display:flex; background:#fff; padding:10px; }
    #textInput { flex:1; padding:10px; border:1px solid #ccc; border-radius:5px; }
    button { margin-left:5px; padding:10px; border:none; border-radius:5px; cursor:pointer; }
    #sendBtn { background:#4CAF50; color:white; }
    #talkBtn { background:#2196F3; color:white; }
    #stopBtn { background:#f44336; color:white; }
  </style>
</head>
<body>
  <header>ðŸŽ“ St. Maryâ€™s College â€“ English Instructor (v1.5)</header>
  <div id="chat"></div>
  <div id="controls">
    <input type="text" id="textInput" placeholder="Type your answer here...">
    <button id="sendBtn">Send</button>
    <button id="talkBtn">Speak</button>
    <button id="stopBtn">Stop</button>
  </div>

  <script>
    const BASE_URL = "https://www.leccion.datafast.pw/lessons"; 
    const chat = document.getElementById("chat");
    const textInput = document.getElementById("textInput");
    const synth = window.speechSynthesis;
    let currentLesson = null;
    let lessonData = null;

    // ðŸŽ“ Welcome
    window.onload = () => {
      addMessage("ðŸ‘‹ Welcome to St. Maryâ€™s College! Please tell me which lesson you want to review (e.g., 'Lesson 1' or 'Lesson one').", "bot");
      speak("Welcome to St. Maryâ€™s College! Please tell me which lesson you want to review, for example Lesson 1.", "en-US");
    };

    function addMessage(text, sender) {
      const div = document.createElement("div");
      div.className = `bubble ${sender}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage(text) {
      if (!text) return;
      addMessage(text, "user");
      textInput.value = "";

      let normalized = text.toLowerCase().trim();

      // ðŸ”¹ Diccionario de nÃºmeros escritos en inglÃ©s
      const numbers = {
        "one": 1, "two": 2, "three": 3, "four": 4, "five": 5,
        "six": 6, "seven": 7, "eight": 8, "nine": 9, "ten": 10
      };

      // ðŸ”¹ Buscar "lesson" + nÃºmero o palabra
      let lessonMatch = normalized.match(/lesson\s+(\d+|one|two|three|four|five|six|seven|eight|nine|ten)/i);

      if (lessonMatch) {
        let lessonKey = lessonMatch[1];
        if (isNaN(lessonKey)) {
          currentLesson = numbers[lessonKey];  // palabra â†’ nÃºmero
        } else {
          currentLesson = parseInt(lessonKey); // nÃºmero directo
        }
        await loadLesson(currentLesson);
        return;
      }

      // Si ya hay lecciÃ³n cargada â†’ responder como profesor
      if (lessonData) {
        await teacherResponse(text);
        return;
      }

      addMessage("Please choose a lesson first (e.g., Lesson 1).", "bot");
      speak("Please choose a lesson first, for example Lesson 1.", "en-US");
    }

    async function loadLesson(num) {
      const url = `${BASE_URL}/lesson${num}.json`;
      try {
        const res = await fetch(url);
        lessonData = await res.json();

        addMessage(`ðŸ“˜ Welcome to Lesson ${num}: ${lessonData.title}`, "bot");
        speak(`Welcome to Lesson ${num}: ${lessonData.title}`, "en-US");

        addMessage(`ðŸ“– Theory:\n${lessonData.theory}`, "bot");
        speak("Here is the main theory of this lesson.", "en-US");

        addMessage(`ðŸŽ¯ Objectives:\n- ${lessonData.objectives.join("\n- ")}`, "bot");
        addMessage(`ðŸ“‘ Topics:\n- ${lessonData.topics.join("\n- ")}`, "bot");

        addMessage("Now you can ask me anything about this lesson. I will explain and help you reinforce the content.", "bot");
        speak("Now you can ask me anything about this lesson. I will explain and help you reinforce the content.", "en-US");

      } catch {
        addMessage("âš ï¸ Lesson not found or not uploaded yet.", "bot");
      }
    }

    async function teacherResponse(userText) {
      let answer = "";

      if (/why/i.test(userText) && /greet/i.test(userText)) {
        answer = "In English, greetings are polite ways to start communication. For example, 'Good morning' shows respect and sets a friendly tone.";
      } else if (/informal/i.test(userText)) {
        answer = "Informal greetings are used with friends or people you know well. Examples: 'Hi', 'Hello', 'Whatâ€™s up?'.";
      } else if (/formal/i.test(userText)) {
        answer = "Formal greetings are used in professional or respectful contexts. Examples: 'Good morning', 'Good afternoon', 'Good evening'.";
      } else {
        answer = `This is related to the lesson: ${lessonData.title}. Let me explain: ${lessonData.theory}`;
      }

      addMessage(answer, "bot");
      speak(answer, "en-US");
    }

    function speak(text, lang) {
      synth.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = lang;
      synth.speak(utter);
    }

    function startListening() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "en-US";
      recognition.start();
      recognition.onresult = (e) => sendMessage(e.results[0][0].transcript);
      recognition.onerror = () => addMessage("âš ï¸ Speech not detected.", "bot");
    }

    document.getElementById("sendBtn").onclick = () => sendMessage(textInput.value);
    document.getElementById("talkBtn").onclick = () => startListening();
    document.getElementById("stopBtn").onclick = () => synth.cancel();
  </script>
</body>
</html>
