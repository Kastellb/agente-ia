<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bot Maestro - St. Mary’s College</title>
  <style>
    body { font-family: Arial, sans-serif; background: #1e3c72; margin:0; display:flex; flex-direction:column; height:100vh; }
    #chat { flex:1; background:#f1f1f1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; }
    .bubble { padding:10px; margin:5px; border-radius:10px; max-width:70%; }
    .user { background:#4CAF50; color:#fff; align-self:flex-end; }
    .bot { background:#2196F3; color:#fff; align-self:flex-start; }
    #controls { display:flex; background:#fff; padding:10px; }
    #textInput { flex:1; padding:10px; border:1px solid #ccc; border-radius:5px; }
    button { margin-left:5px; padding:10px; border:none; border-radius:5px; cursor:pointer; }
    #sendBtn { background:#4CAF50; color:white; }
    #talkBtn { background:#2196F3; color:white; }
    #stopBtn { background:#f44336; color:white; }
  </style>
</head>
<body>
  <h2 style="text-align:center; color:white; padding:10px;">🤖 Bot Maestro - St. Mary’s College</h2>
  <div id="chat"></div>
  <div id="controls">
    <input type="text" id="textInput" placeholder="Escribe tu mensaje...">
    <button id="sendBtn">Enviar</button>
    <button id="talkBtn">Hablar</button>
    <button id="stopBtn">Detener</button>
  </div>

  <script>
    // ⚡ URL de tu Worker REAL
    const WORKER_URL = "https://bot-maestro-proxy.kast-mercadeo.workers.dev/";

    const chat = document.getElementById("chat");
    const textInput = document.getElementById("textInput");
    const synth = window.speechSynthesis;

    // Saludo inicial
    window.onload = () => {
      addMessage("👋 Hola, soy el Bot Maestro. ¿Quieres hablar en inglés o en español?", "bot");
      speak("Hola, soy el Bot Maestro. ¿Quieres hablar en inglés o en español?", "es-ES");
    };

    function addMessage(text, sender) {
      const div = document.createElement("div");
      div.className = `bubble ${sender}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage(text) {
      if (!text) return;
      addMessage(text, "user");
      textInput.value = "";

      try {
        const res = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });
        const data = await res.json();
        const reply = data.reply || "❌ Error en la respuesta";
        addMessage(reply, "bot");
        speak(reply, reply.match(/[a-zA-Z]/) ? "en-US" : "es-ES");
      } catch (err) {
        addMessage("⚠️ Error de conexión con el servidor", "bot");
      }
    }

    function speak(text, lang) {
      synth.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = lang;
      synth.speak(utter);
    }

    function startListening() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "es-ES";
      recognition.start();
      recognition.onresult = (e) => {
        const text = e.results[0][0].transcript;
        sendMessage(text);
      };
      recognition.onerror = () => addMessage("⚠️ No se detectó audio", "bot");
    }

    document.getElementById("sendBtn").onclick = () => sendMessage(textInput.value);
    document.getElementById("talkBtn").onclick = () => startListening();
    document.getElementById("stopBtn").onclick = () => synth.cancel();
  </script>
</body>
</html>
