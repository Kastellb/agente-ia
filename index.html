<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>St. Mary's College - English Leveler v1.1</title>
    <style>
        :root {
            --primary: #0b3b71;
            --secondary: #64748b;
            --background: #eef2f7;
            --card: #ffffff;
            --text: #1e293b;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .version {
            font-size: 14px;
            opacity: 0.9;
        }

        .voice-search-btn {
            position: absolute;
            right: 20px;
            top: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .voice-search-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .search-section {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #lessonInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 16px;
        }

        #searchBtn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 20px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #searchBtn:hover {
            background: #0a3260;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .audio-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, background-color 0.2s;
        }

        .audio-btn:hover {
            transform: scale(1.05);
        }

        .audio-btn:active {
            transform: scale(0.95);
        }

        .audio-btn.stop {
            background: var(--error);
        }

        .audio-btn:disabled {
            background: var(--secondary);
            cursor: not-allowed;
            transform: none;
        }

        .voice-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lesson-content {
            padding: 0 20px 20px;
            display: none;
        }

        .lesson-header {
            margin: 20px 0 15px;
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        .theory-content {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            line-height: 1.8;
            white-space: pre-line;
        }

        .practice-section {
            margin-top: 25px;
        }

        .practice-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: block;
            width: 100%;
            transition: background-color 0.2s;
        }

        .practice-btn:hover {
            background: #1da750;
        }

        .practice-btn:disabled {
            background: var(--secondary);
            cursor: not-allowed;
        }

        .quiz-container {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .quiz-question {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quiz-option {
            padding: 12px;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quiz-option:hover {
            background: #f1f5f9;
        }

        .quiz-option.selected {
            background: #dbeafe;
            border-color: var(--primary);
        }

        .quiz-option.correct {
            background: #dcfce7;
            border-color: var(--success);
        }

        .quiz-option.incorrect {
            background: #fee2e2;
            border-color: var(--error);
        }

        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .quiz-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .quiz-next {
            background: var(--primary);
            color: white;
        }

        .quiz-submit {
            background: var(--success);
            color: white;
        }

        .quiz-result {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 600;
        }

        .quiz-pass {
            background: #dcfce7;
            color: #166534;
        }

        .quiz-fail {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-indicator {
            text-align: center;
            padding: 10px;
            font-style: italic;
            color: var(--secondary);
        }

        .voice-commands {
            margin-top: 15px;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        footer {
            text-align: center;
            padding: 20px;
            color: var(--secondary);
            font-size: 14px;
            border-top: 1px solid #e2e8f0;
        }

        .pulse {
            animation: pulse-animation 1.5s infinite;
        }

        @keyframes pulse-animation {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @media (max-width: 600px) {
            .search-box {
                flex-direction: column;
            }
            
            #searchBtn {
                padding: 12px;
            }
            
            .audio-controls {
                flex-wrap: wrap;
            }
            
            .voice-search-btn {
                position: relative;
                right: auto;
                top: auto;
                margin-top: 10px;
                align-self: center;
            }
            
            .voice-selector {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>St. Mary's College - English Leveler</h1>
            <div class="version">v1.1</div>
            <button class="voice-search-btn" id="voiceSearchBtn" title="Voice Search">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
            </button>
        </header>

        <div class="search-section">
            <div class="search-box">
                <input type="text" id="lessonInput" placeholder="Enter lesson number or name (e.g. 'Lesson 45' or 'Past Perfect')">
                <button id="searchBtn">Load Lesson</button>
            </div>
            
            <div class="audio-controls">
                <button class="audio-btn" id="playBtn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                </button>
                <button class="audio-btn stop" id="stopBtn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                </button>
                
                <div class="voice-selector">
                    <label for="voiceSelect">Voice:</label>
                    <select id="voiceSelect">
                        <option value="">Default English</option>
                    </select>
                </div>
                
                <div class="voice-selector">
                    <label for="speedSelect">Speed:</label>
                    <select id="speedSelect">
                        <option value="0.8">Slow</option>
                        <option value="1" selected>Normal</option>
                        <option value="1.2">Fast</option>
                    </select>
                </div>
            </div>
            
            <div class="voice-commands">
                <p>Try saying: <strong>"Lesson 45"</strong>, <strong>"Future Continuous"</strong>, or <strong>"Practice"</strong></p>
            </div>
            
            <div class="status-indicator" id="statusText">Select a lesson to begin</div>
        </div>

        <div class="lesson-content" id="lessonContent">
            <h2 class="lesson-header" id="lessonTitle"></h2>
            <div class="theory-content" id="theoryContent"></div>
            
            <div class="practice-section">
                <button class="practice-btn" id="practiceBtn">Start Practice</button>
            </div>
            
            <div class="quiz-container" id="quizContainer">
                <div class="quiz-question" id="quizQuestion"></div>
                <div class="quiz-options" id="quizOptions"></div>
                <div class="quiz-navigation">
                    <button class="quiz-btn" id="prevQuestionBtn" style="visibility: hidden;">Previous</button>
                    <button class="quiz-btn quiz-next" id="nextQuestionBtn">Next</button>
                    <button class="quiz-btn quiz-submit" id="submitQuizBtn" style="display: none;">Submit</button>
                </div>
                <div class="quiz-result" id="quizResult" style="display: none;"></div>
            </div>
        </div>

        <footer>
            <p>St. Mary's College English Leveler v1.1 • © 2023</p>
        </footer>
    </div>

    <script>
        // Elementos DOM
        const lessonInput = document.getElementById('lessonInput');
        const searchBtn = document.getElementById('searchBtn');
        const lessonContent = document.getElementById('lessonContent');
        const lessonTitle = document.getElementById('lessonTitle');
        const theoryContent = document.getElementById('theoryContent');
        const practiceBtn = document.getElementById('practiceBtn');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const voiceSelect = document.getElementById('voiceSelect');
        const speedSelect = document.getElementById('speedSelect');
        const statusText = document.getElementById('statusText');
        const voiceSearchBtn = document.getElementById('voiceSearchBtn');
        const quizContainer = document.getElementById('quizContainer');
        const quizQuestion = document.getElementById('quizQuestion');
        const quizOptions = document.getElementById('quizOptions');
        const prevQuestionBtn = document.getElementById('prevQuestionBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const submitQuizBtn = document.getElementById('submitQuizBtn');
        const quizResult = document.getElementById('quizResult');

        // Variables de estado
        let currentUtterance = null;
        let currentLessonText = "";
        let currentLessonNumber = 0;
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let availableVoices = [];
        let recognition = null;

        // Configuración de Groq API (reemplaza con tu API key real)
        const GROQ_API_KEY = "your-groq-api-key-here"; // Reemplazar con tu API key real
        const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";

        // Inicializar reconocimiento de voz si está disponible
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    lessonInput.value = transcript;
                    processVoiceInput(transcript);
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error', event.error);
                    statusText.textContent = "Error with voice recognition. Please try typing instead.";
                };
            } else {
                voiceSearchBtn.disabled = true;
                voiceSearchBtn.title = "Voice recognition not supported";
            }
        }

        // Procesar entrada de voz
        function processVoiceInput(transcript) {
            transcript = transcript.toLowerCase().trim();
            
            // Detectar si es un número de lección
            const lessonMatch = transcript.match(/lesson\s+(\d+)|lecture\s+(\d+)|module\s+(\d+)|(\d+)/);
            if (lessonMatch) {
                const lessonNum = lessonMatch[1] || lessonMatch[2] || lessonMatch[3] || lessonMatch[4];
                lessonInput.value = `Lesson ${lessonNum}`;
                loadLesson();
                return;
            }
            
            // Detectar si es una solicitud de práctica
            if (transcript.includes('practice') || transcript.includes('exercise') || transcript.includes('quiz')) {
                if (currentLessonNumber > 0) {
                    startPractice();
                } else {
                    statusText.textContent = "Please select a lesson first";
                }
                return;
            }
            
            // Búsqueda por nombre de lección
            lessonInput.value = transcript;
            loadLesson();
        }

        // Cargar solo voces en inglés
        function loadEnglishVoices() {
            availableVoices = speechSynthesis.getVoices().filter(voice => 
                voice.lang.startsWith('en') && !voice.localService // Prefer cloud-based voices for better quality
            );
            
            // Limpiar selector de voces
            voiceSelect.innerHTML = '<option value="">Default English</option>';
            
            // Añadir solo voces en inglés
            availableVoices.forEach(voice => {
                // Filtrar para obtener solo las mejores voces en inglés
                if (voice.lang.includes('en-') && (voice.name.includes('Google') || voice.name.includes('Microsoft') || voice.name.includes('Alex') || voice.name.includes('Samantha'))) {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                }
            });
            
            // Si no hay voces premium, usar las disponibles
            if (voiceSelect.options.length <= 1) {
                availableVoices.forEach(voice => {
                    if (voice.lang.startsWith('en-')) {
                        const option = document.createElement('option');
                        option.value = voice.name;
                        option.textContent = `${voice.name} (${voice.lang})`;
                        voiceSelect.appendChild(option);
                    }
                });
            }
        }

        // Función para obtener contenido de la lección desde Groq
        async function getLessonContent(lessonQuery) {
            statusText.innerHTML = "Loading lesson content... <span class='loading'></span>";
            
            try {
                // Extraer número de lección si es posible
                const lessonNumMatch = lessonQuery.match(/\d+/);
                const lessonNumber = lessonNumMatch ? parseInt(lessonNumMatch[0]) : 0;
                
                const response = await fetch(GROQ_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "llama-3.1-8b-instant",
                        messages: [
                            {
                                role: "system",
                                content: "You are an English teaching assistant at St. Mary's College. Provide comprehensive, engaging lesson content with unique examples. Structure your response with clear sections for theory. Always generate fresh content, never repeating the same examples. Focus on proper English grammar and pronunciation."
                            },
                            {
                                role: "user",
                                content: `Create English lesson content for: ${lessonQuery}. If this is lesson ${lessonNumber} and lesson number is greater than 1, assume the student has completed previous lessons.`
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                return {
                    content: data.choices[0].message.content,
                    number: lessonNumber
                };
            } catch (error) {
                console.error("Error fetching from Groq API:", error);
                // Fallback content if API fails
                return {
                    content: `# ${lessonQuery}\n\n## Theory\nThis lesson covers ${lessonQuery}. Please try again later if the content doesn't load properly.`,
                    number: 0
                };
            }
        }

        // Función para obtener ejercicios de práctica desde Groq
        async function getPracticeContent(lessonQuery, lessonNumber, previousScore = 0) {
            statusText.innerHTML = "Generating practice exercises... <span class='loading'></span>";
            
            try {
                const response = await fetch(GROQ_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "llama-3.1-8b-instant",
                        messages: [
                            {
                                role: "system",
                                content: `You are an English teaching assistant. Create unique, engaging practice exercises that test comprehension of the lesson topic. 
                                Include 5 multiple-choice questions with 4 options each. Format your response as JSON with this structure: 
                                {
                                  "questions": [
                                    {
                                      "question": "question text",
                                      "options": ["option1", "option2", "option3", "option4"],
                                      "correctIndex": 0
                                    }
                                  ]
                                }
                                The questions must be completely different from any previous questions. Focus on proper English grammar.`
                            },
                            {
                                role: "user",
                                content: `Create practice exercises for the English lesson: ${lessonQuery}. 
                                This is lesson number ${lessonNumber}. 
                                The student's previous score was ${previousScore}%. 
                                Generate completely new questions that are different from any previous exercises.`
                            }
                        ],
                        temperature: 0.9, // Higher temperature for more variety
                        response_format: { type: "json_object" },
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                return JSON.parse(data.choices[0].message.content);
            } catch (error) {
                console.error("Error fetching practice from Groq API:", error);
                // Fallback practice content
                return {
                    questions: [
                        {
                            question: "Based on what you've learned, which option best demonstrates proper English usage?",
                            options: ["I is going to the store", "She are studying English", "They have completed the lesson", "He don't understand"],
                            correctIndex: 2
                        }
                    ]
                };
            }
        }

        // Cargar lección
        async function loadLesson() {
            const input = lessonInput.value.trim();
            
            if (!input) {
                alert("Please enter a lesson number or name");
                return;
            }
            
            // Obtener contenido de la lección desde Groq
            const lessonData = await getLessonContent(input);
            
            // Mostrar contenido
            lessonTitle.textContent = input;
            theoryContent.textContent = lessonData.content;
            lessonContent.style.display = 'block';
            quizContainer.style.display = 'none';
            
            // Guardar texto para lectura (sin caracteres especiales)
            currentLessonText = `${input}. ${lessonData.content.replace(/[#*_\-\[\]()]/g, '')}`;
            currentLessonNumber = lessonData.number;
            
            // Habilitar controles
            playBtn.disabled = false;
            stopBtn.disabled = false;
            practiceBtn.disabled = false;
            
            // Actualizar estado
            statusText.textContent = "Lesson loaded. Click play to listen";
            
            // Desplazar a la lección
            lessonContent.scrollIntoView({ behavior: 'smooth' });
        }

        // Reproducir audio con voz de alta calidad en inglés
        function playAudio() {
            if (!currentLessonText) return;
            
            // Detener audio actual si está reproduciendo
            stopAudio();
            
            // Crear nueva utterance
            currentUtterance = new SpeechSynthesisUtterance(currentLessonText);
            
            // Configurar voz seleccionada o la mejor voz disponible en inglés
            const selectedVoiceName = voiceSelect.value;
            if (selectedVoiceName) {
                const selectedVoice = availableVoices.find(voice => voice.name === selectedVoiceName);
                if (selectedVoice) {
                    currentUtterance.voice = selectedVoice;
                }
            } else {
                // Seleccionar la mejor voz disponible en inglés
                const preferredVoices = availableVoices.filter(voice => 
                    voice.lang.includes('en-US') || voice.lang.includes('en-GB')
                );
                
                if (preferredVoices.length > 0) {
                    // Preferir voces de alta calidad
                    const qualityVoice = preferredVoices.find(voice => 
                        voice.name.includes('Google') || voice.name.includes('Microsoft') || 
                        voice.name.includes('Samantha') || voice.name.includes('Alex')
                    ) || preferredVoices[0];
                    
                    currentUtterance.voice = qualityVoice;
                }
            }
            
            // Configurar parámetros para mejor calidad de voz
            currentUtterance.rate = parseFloat(speedSelect.value);
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 1.0;
            
            // Eventos
            currentUtterance.onstart = () => {
                statusText.textContent = "Playing...";
                playBtn.disabled = true;
            };
            
            currentUtterance.onend = () => {
                statusText.textContent = "Playback finished";
                playBtn.disabled = false;
                currentUtterance = null;
            };
            
            currentUtterance.onerror = (event) => {
                console.error('Speech synthesis error:', event);
                statusText.textContent = "Error playing audio";
                playBtn.disabled = false;
                currentUtterance = null;
            };
            
            // Reproducir
            speechSynthesis.speak(currentUtterance);
        }

        // Detener audio
        function stopAudio() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                statusText.textContent = "Playback stopped";
                playBtn.disabled = false;
            }
        }

        // Iniciar práctica
        async function startPractice() {
            if (!currentLessonNumber) return;
            
            // Obtener el puntaje anterior del localStorage
            const previousScore = localStorage.getItem(`lesson-${currentLessonNumber-1}-score`) || 0;
            
            // Obtener ejercicios de práctica desde Groq
            currentQuiz = await getPracticeContent(lessonInput.value, currentLessonNumber, previousScore);
            
            // Inicializar quiz
            userAnswers = new Array(currentQuiz.questions.length).fill(null);
            currentQuestionIndex = 0;
            
            // Mostrar quiz y ocultar teoría
            theoryContent.style.display = 'none';
            quizContainer.style.display = 'block';
            practiceBtn.disabled = true;
            
            // Mostrar primera pregunta
            showQuestion(0);
            
            // Actualizar estado
            statusText.textContent = "Practice session started. Good luck!";
        }

        // Mostrar pregunta del quiz
        function showQuestion(index) {
            const question = currentQuiz.questions[index];
            quizQuestion.textContent = question.question;
            
            // Limpiar opciones anteriores
            quizOptions.innerHTML = '';
            
            // Añadir nuevas opciones
            question.options.forEach((option, optionIndex) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'quiz-option';
                if (userAnswers[index] === optionIndex) {
                    optionElement.classList.add('selected');
                }
                optionElement.textContent = option;
                optionElement.addEventListener('click', () => selectAnswer(optionIndex));
                quizOptions.appendChild(optionElement);
            });
            
            // Actualizar navegación
            prevQuestionBtn.style.visibility = index > 0 ? 'visible' : 'hidden';
            nextQuestionBtn.style.display = index < currentQuiz.questions.length - 1 ? 'block' : 'none';
            submitQuizBtn.style.display = index === currentQuiz.questions.length - 1 ? 'block' : 'none';
        }

        // Seleccionar respuesta
        function selectAnswer(optionIndex) {
            userAnswers[currentQuestionIndex] = optionIndex;
            
            // Actualizar visualización de opciones
            const options = quizOptions.querySelectorAll('.quiz-option');
            options.forEach((option, idx) => {
                option.classList.toggle('selected', idx === optionIndex);
            });
        }

        // Navegación entre preguntas
        nextQuestionBtn.addEventListener('click', () => {
            if (currentQuestionIndex < currentQuiz.questions.length - 1) {
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
            }
        });

        prevQuestionBtn.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion(currentQuestionIndex);
            }
        });

        // Enviar quiz
        submitQuizBtn.addEventListener('click', () => {
            // Calcular puntaje
            let correctAnswers = 0;
            userAnswers.forEach((answer, index) => {
                if (answer === currentQuiz.questions[index].correctIndex) {
                    correctAnswers++;
                }
            });
            
            const score = Math.round((correctAnswers / currentQuiz.questions.length) * 100);
            
            // Guardar puntaje
            localStorage.setItem(`lesson-${currentLessonNumber}-score`, score);
            
            // Mostrar resultado
            quizResult.style.display = 'block';
            if (score >= 70) {
                quizResult.className = 'quiz-result quiz-pass';
                quizResult.textContent = `Congratulations! You scored ${score}% and passed the quiz.`;
            } else {
                quizResult.className = 'quiz-result quiz-fail';
                quizResult.textContent = `You scored ${score}%. You need at least 70% to pass. Please review the lesson and try again.`;
            }
            
            // Deshabilitar opciones
            const options = quizOptions.querySelectorAll('.quiz-option');
            options.forEach((option, index) => {
                option.style.cursor = 'default';
                if (index === currentQuiz.questions[currentQuestionIndex].correctIndex) {
                    option.classList.add('correct');
                } else if (index === userAnswers[currentQuestionIndex] && index !== currentQuiz.questions[currentQuestionIndex].correctIndex) {
                    option.classList.add('incorrect');
                }
            });
            
            submitQuizBtn.disabled = true;
        });

        // Iniciar búsqueda por voz
        function startVoiceSearch() {
            if (recognition) {
                statusText.textContent = "Listening... Speak now";
                recognition.start();
            }
        }

        // Event listeners
        searchBtn.addEventListener('click', loadLesson);
        
        lessonInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadLesson();
            }
        });
        
        playBtn.addEventListener('click', playAudio);
        stopBtn.addEventListener('click', stopAudio);
        practiceBtn.addEventListener('click', startPractice);
        voiceSearchBtn.addEventListener('click', startVoiceSearch);

        // Inicializar
        window.addEventListener('load', () => {
            // Inicializar reconocimiento de voz
            initSpeechRecognition();
            
            // Cargar voces disponibles en inglés
            loadEnglishVoices();
            speechSynthesis.onvoiceschanged = loadEnglishVoices;
            
            // Verificar compatibilidad con speech synthesis
            if (!('speechSynthesis' in window)) {
                statusText.textContent = "Speech synthesis not supported in your browser";
                playBtn.disabled = true;
                stopBtn.disabled = true;
            }
        });
    </script>
</body>
</html>
