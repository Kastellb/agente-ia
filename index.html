// ===== Bot Maestro v2.1 (estable) – Cloudflare Worker =====
export default {
  async fetch(request) {
    const cors = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type'
    };

    // Tu Apps Script /exec:
    const APPS_URL = 'https://script.google.com/macros/s/AKfycbx8iBAt27M4jO4vyxWFew6v5ili7sFBDUOWDV13bImOjW48I7g-uETeKIDWn3hPHaV0/exec';

    // Preflight CORS
    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: cors });
    }

    try {
      // Lee el JSON del cliente (texto y lang)
      const body = await request.json().catch(() => ({}));

      // Reenvía tal cual al Apps Script
      const res = await fetch(APPS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const text = await res.text(); // Apps Script devuelve JSON en texto
      return new Response(text, {
        status: 200,
        headers: { 'Content-Type': 'application/json', ...cors }
      });

    } catch (err) {
      const msg = (err && err.message) ? err.message : String(err);
      return new Response(JSON.stringify({ reply: '❌ Error en Worker: ' + msg }), {
        status: 200,
        headers: { 'Content-Type': 'application/json', ...cors }
      });
    }
  }
};
