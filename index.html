<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>St. Mary‚Äôs College ‚Äì English Instructor (v1.4)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #1e3c72; margin:0; display:flex; flex-direction:column; height:100vh; }
    header { text-align:center; color:white; padding:10px; font-size:18px; background:#0d2b57; }
    #chat { flex:1; background:#f9f9f9; padding:10px; overflow-y:auto; display:flex; flex-direction:column; }
    .bubble { padding:10px; margin:5px; border-radius:10px; max-width:75%; line-height:1.4; }
    .user { background:#4CAF50; color:#fff; align-self:flex-end; }
    .bot { background:#2196F3; color:#fff; align-self:flex-start; white-space:pre-line; }
    #controls { display:flex; background:#fff; padding:10px; }
    #textInput { flex:1; padding:10px; border:1px solid #ccc; border-radius:5px; }
    button { margin-left:5px; padding:10px; border:none; border-radius:5px; cursor:pointer; }
    #sendBtn { background:#4CAF50; color:white; }
    #talkBtn { background:#2196F3; color:white; }
    #stopBtn { background:#f44336; color:white; }
  </style>
</head>
<body>
  <header>üéì St. Mary‚Äôs College ‚Äì English Instructor (v1.4)</header>
  <div id="chat"></div>
  <div id="controls">
    <input type="text" id="textInput" placeholder="Type your answer here...">
    <button id="sendBtn">Send</button>
    <button id="talkBtn">Speak</button>
    <button id="stopBtn">Stop</button>
  </div>

  <script>
    const BASE_URL = "https://www.leccion.datafast.pw/lessons"; 
    const chat = document.getElementById("chat");
    const textInput = document.getElementById("textInput");
    const synth = window.speechSynthesis;
    let currentLesson = null;
    let currentStep = 0;
    let currentContent = [];
    let mode = "teaching"; // teaching ‚Üí practice

    const numberWords = { one:1, two:2, to:2, too:2, three:3, four:4, for:4, five:5, six:6, seven:7, eight:8, nine:9, ten:10 };

    // üéì Welcome
    window.onload = () => {
      addMessage("üëã Welcome to St. Mary‚Äôs College! Please tell me which lesson you want to review (e.g., 'Lesson 1').", "bot");
      speak("Welcome to St. Mary‚Äôs College! Please tell me which lesson you want to review, for example Lesson 1.", "en-US");
    };

    function addMessage(text, sender) {
      const div = document.createElement("div");
      div.className = `bubble ${sender}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage(text) {
      if (!text) return;
      addMessage(text, "user");
      textInput.value = "";

      // Normalize
      let normalized = text.toLowerCase().replace(/listen|lessom|leccion|lessen|play some/gi, "lesson");

      // Detect lesson request
      let lessonMatch = normalized.match(/lesson\s+(\d+|[a-z]+)/i);
      if (lessonMatch) {
        let lessonNumber = lessonMatch[1].toLowerCase();
        lessonNumber = isNaN(lessonNumber) ? numberWords[lessonNumber] : parseInt(lessonNumber);

        if (lessonNumber) {
          currentLesson = lessonNumber;
          currentStep = 0;
          mode = "teaching";
          await startLesson(lessonNumber);
          return;
        }
      }

      // Teaching phase ‚Üí wait for "continue" or "practice"
      if (mode === "teaching" && /continue|practice/i.test(normalized)) {
        mode = "practice";
        askNextQuestion();
        return;
      }

      // Practice phase
      if (mode === "practice" && currentContent.length > 0 && currentStep > 0) {
        checkAnswer(text);
        return;
      }

      if (!currentLesson) {
        addMessage("Please choose a lesson first (e.g., Lesson 1).", "bot");
        speak("Please choose a lesson first, for example Lesson 1.", "en-US");
      }
    }

    async function startLesson(lessonNumber) {
      const attempts = [
        `${BASE_URL}/lesson${lessonNumber}.json`,
        `${BASE_URL}/lesson${lessonNumber.toString().padStart(2,"0")}.json`,
        `${BASE_URL}/lesson${lessonNumber.toString().padStart(3,"0")}.json`
      ];

      for (const url of attempts) {
        try {
          const res = await fetch(url);
          if (!res.ok) continue;
          const lesson = await res.json();

          // Teaching phase
          addMessage(`üìò Welcome to Lesson ${lessonNumber}: ${lesson.title}`, "bot");
          speak(`Welcome to Lesson ${lessonNumber}: ${lesson.title}`, "en-US");

          if (lesson.theory) {
            addMessage(`üìñ Theory:\n${lesson.theory}`, "bot");
            speak(lesson.theory, "en-US");
          }

          addMessage(`üéØ Objectives:\n- ${lesson.objectives.join("\n- ")}`, "bot");
          speak("Here are the objectives of this lesson.", "en-US");

          addMessage(`üìë Topics:\n- ${lesson.topics.join("\n- ")}`, "bot");
          speak("Here are the topics of this lesson.", "en-US");

          addMessage("When you are ready, type or say 'continue' and we will start the practice.", "bot");
          speak("When you are ready, say continue and we will start the practice.", "en-US");

          currentContent = lesson.content;
          currentStep = 0;
          return;
        } catch {}
      }

      addMessage("‚ö†Ô∏è Lesson not found or not uploaded yet.", "bot");
    }

    // Practice: ask next
    function askNextQuestion() {
      if (currentStep < currentContent.length) {
        const q = currentContent[currentStep].question;
        addMessage(`‚ùì ${q}`, "bot");
        speak(q, "en-US");
      } else {
        addMessage("‚úÖ Great job! You have completed this lesson's practice.", "bot");
        speak("Great job! You have completed this lesson's practice.", "en-US");
        mode = "done";
      }
    }

    // Check answer
    function checkAnswer(userAnswer) {
      const expected = currentContent[currentStep].answer.toLowerCase();
      const user = userAnswer.toLowerCase();

      if (user.includes(expected.split(" ")[0])) {
        addMessage("üëç Correct! Well done.", "bot");
        speak("Correct! Well done.", "en-US");
      } else {
        addMessage(`‚ö†Ô∏è Not quite. The correct answer is: "${currentContent[currentStep].answer}"`, "bot");
        speak(`Not quite. The correct answer is: ${currentContent[currentStep].answer}`, "en-US");
      }

      currentStep++;
      askNextQuestion();
    }

    // Voice
    function speak(text, lang) {
      synth.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = lang;
      synth.speak(utter);
    }

    function startListening() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "en-US";
      recognition.start();
      recognition.onresult = (e) => sendMessage(e.results[0][0].transcript);
      recognition.onerror = () => addMessage("‚ö†Ô∏è Speech not detected.", "bot");
    }

    // Buttons
    document.getElementById("sendBtn").onclick = () => sendMessage(textInput.value);
    document.getElementById("talkBtn").onclick = () => startListening();
    document.getElementById("stopBtn").onclick = () => synth.cancel();
  </script>
</body>
</html>
