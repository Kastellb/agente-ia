<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>St. Maryâ€™s College â€” English Leveler v3.1</title>
<style>
:root{ --brand:#0b3b71; --bg:#eef2f7; --bot:#0b88e6; --user:#12b886; }
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:#0f172a; display:flex; flex-direction:column;
}
header{
  background:var(--brand); color:#fff; padding:12px 16px;
  display:flex; flex-wrap:wrap; gap:12px; align-items:center;
}
h1{margin:0;font-size:16px;font-weight:800}
.badge{font-size:12px;opacity:.9}
main{flex:1;display:flex;justify-content:center}
.wrap{width:min(1000px,100%);padding:16px;display:flex;flex-direction:column;gap:12px}

/* Top toolbar */
.toolbar{
  background:#fff; border-radius:14px; padding:10px;
  display:flex; gap:12px; align-items:center; flex-wrap:wrap;
  box-shadow:0 12px 28px rgba(2,6,23,.08)
}
.label{font-weight:800}
select,button{font:600 14px/1 system-ui}
#lesson{
  padding:8px 10px; border-radius:10px; border:1px solid #cbd5e1;
  background:#f8fafc; min-width:280px;
}
.status{
  font-size:13px; color:#334155; background:#0b3b7112; border:1px dashed #0b3b7130;
  padding:6px 10px; border-radius:10px; min-height:34px; display:flex; align-items:center;
}

/* Chat area */
#chat{
  background:#fff; border-radius:16px; padding:12px 12px 4px;
  min-height:58vh; overflow:auto; box-shadow:0 12px 28px rgba(2,6,23,.12)
}
.msg{
  max-width:min(720px,92%); padding:10px 12px; border-radius:12px;
  margin:10px 0; line-height:1.45; white-space:pre-wrap
}
.msg.bot{background:var(--bot);color:#fff;border-bottom-left-radius:4px}
.msg.user{background:var(--user);color:#fff;border-bottom-right-radius:4px;margin-left:auto}

/* Composer */
.composer{
  background:#fff; border-radius:14px; padding:10px;
  box-shadow:0 12px 28px rgba(2,6,23,.08);
  display:flex; flex-direction:column; gap:10px;
}
#text{
  width:100%; border:0; outline:0; font-size:16px; padding:12px;
  border-radius:10px; background:#f7f9fc
}
.btnrow{ display:flex; gap:10px; flex-wrap:wrap; }
.btn{
  border:0; border-radius:12px; padding:10px 14px; font-weight:800; color:#fff; cursor:pointer
}
#send{background:#22c55e} #mic{background:#0ea5e9} #stop{background:#ef4444}

/* Mobile tweaks */
@media (max-width:640px){
  h1{font-size:14px}
  .msg{max-width:96%}
  #lesson{min-width:unset}
}
</style>
</head>
<body>
<header>
  <h1>St. Maryâ€™s College â€” English Leveler v3.1</h1>
  <span class="badge">Voice + Text â€¢ EN only â€¢ JSON-driven (1â€“270)</span>
</header>

<main>
  <div class="wrap">

    <div class="toolbar">
      <span class="label">Select lesson:</span>
      <select id="lesson" aria-label="Select lesson"></select>
      <span id="status" class="status">Please select a lesson to begin.</span>
    </div>

    <div id="chat" aria-live="polite"></div>

    <div class="composer">
      <input id="text" placeholder="Type your message and press Enterâ€¦" autocomplete="off">
      <div class="btnrow">
        <button id="send" class="btn">Send</button>
        <button id="mic"  class="btn">Speak</button>
        <button id="stop" class="btn">Stop</button>
      </div>
    </div>

  </div>
</main>

<script>
/* ===== CONFIG ===== */
const WORKER_URL = "https://bot-maestro-proxy.kast-mercadeo.workers.dev/";
const JSON_BASE  = "https://leccion.datafast.pw/lessons/";
const JSON_COUNT = 270;

/* ===== Estado ===== */
const chat   = document.getElementById('chat');
const input  = document.getElementById('text');
const send   = document.getElementById('send');
const mic    = document.getElementById('mic');
const stopBtn= document.getElementById('stop');
const lessonSel = document.getElementById('lesson');
const statusEl  = document.getElementById('status');

let currentLesson = null;
let lessonData = null;

/* ===== Utilidades visuales ===== */
function addMsg(text, who="bot"){
  const clean = (String(text||'')).trim();
  const d=document.createElement('div');
  d.className = `msg ${who}`;
  d.textContent = clean;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
  return d;
}
function speak(text){ 
  try{ 
    const u=new SpeechSynthesisUtterance(text); 
    window.speechSynthesis.speak(u);
  }catch(e){} 
}
function stopAll(){ try{speechSynthesis.cancel()}catch(e){} }

/* ===== Carga de JSON ===== */
async function fetchJSON(url){
  const r = await fetch(url, { cache:'no-store' });
  if(!r.ok) throw new Error(r.status+" "+r.statusText);
  return await r.json();
}
async function loadLesson(n){
  currentLesson = n;
  lessonData = null;

  addMsg(`Lesson ${n} selected. Preparing materialsâ€¦`, "bot");

  try{ 
    if(n <= JSON_COUNT){ 
      lessonData = await fetchJSON(`${JSON_BASE}lesson${n}.json`); 
    } 
  }catch(e){ }

  const titleTxt = lessonData?.title ? `Lesson ${n} â€” ${lessonData.title}` : `Lesson ${n}`;
  statusEl.textContent = `${titleTxt}. You can start now.`;

  if(lessonData){ 
    addMsg(`Theory â€” ${lessonData.title}\n${lessonData.theory||""}`, "bot"); 
  }
}

/* ===== Prompt educativo y estructurado ===== */
function buildPrompt(userText){
  const n = currentLesson;
  const title = lessonData?.title || `Lesson ${n}`;
  const theory = lessonData?.theory || "";
  const objectives = Array.isArray(lessonData?.objectives) ? lessonData.objectives : [];
  const topics = Array.isArray(lessonData?.topics) ? lessonData.topics : [];

  return `
ROLE: You are an English instructor for St. Maryâ€™s College.
LANGUAGE: Reply in ENGLISH ONLY.
TONE: Clear, motivating, professional teacher.
TASK: Based on the lesson JSON, create a complete academic learning unit.
Always keep answers focused on Lesson ${n} â€” ${title}.
If the user asks off-topic, redirect politely back to this lesson.

JSON CONTEXT:
Title: ${title}
Theory: ${theory}
Objectives:
${objectives.map((x,i)=>`${i+1}. ${x}`).join('\n')}
Topics:
${topics.map((x,i)=>`${i+1}. ${x}`).join('\n')}

OUTPUT FORMAT:
1. ðŸŽ¯ Learning Objective
   - Clear statement of what the student will achieve.

2. ðŸ§© Key Content
   - Explanation of the main theory.
   - Formal vs informal expressions (if relevant).
   - Cultural notes when possible.

3. ðŸ’¬ Examples
   - At least 3 short sample dialogues or sentences.

4. ðŸŽ­ Suggested Activities
   - Interactive tasks (role-play, matching, games).

5. ðŸ§ª Practice Evaluation
   - 2â€“3 short questions or tasks the student can try.

USER REQUEST: ${userText}
  `.trim();
}

/* ===== Backend ===== */
async function askInstructor(text){
  // Construir prompt
  const prompt = buildPrompt(text);

  // ðŸ‘€ Mostrar en consola
  console.log("=== Prompt enviado a la IA ===\n", prompt);

  // Enviar al Worker
  const r = await fetch(WORKER_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ text: prompt, lang:"en-US" })
  });
  if(!r.ok) throw new Error("HTTP "+r.status);
  const data = await r.json().catch(()=>({ reply:"Connection error." }));

  // ðŸ‘€ Mostrar respuesta cruda en consola
  console.log("=== Respuesta cruda del Worker ===\n", data);

  return String(data.reply||"");
}

/* ===== EnvÃ­o ===== */
async function sendMsg(){
  const t=(input.value||"").trim();
  if(!t) return;
  input.value="";
  addMsg(t,"user");

  if(!currentLesson){ 
    addMsg("Please select a lesson first.", "bot"); 
    return; 
  }

  try{ 
    const reply = await askInstructor(t); 
    addMsg(reply,"bot"); 
    speak(reply); 
  }
  catch(e){ addMsg("Connection error with the server.", "bot"); }
}

/* ===== Eventos UI ===== */
send.addEventListener('click', sendMsg);
input.addEventListener('keydown', e=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMsg(); }
});
mic.addEventListener('click', ()=> addMsg("ðŸŽ¤ Voice input not yet active","bot"));
stopBtn.addEventListener('click', stopAll);
lessonSel.addEventListener('change', ()=>{
  const v = lessonSel.value; 
  if(!v){ statusEl.textContent="Please select a lesson to begin."; return; } 
  loadLesson(+v);
});

/* ===== Construir combo ===== */
(function buildLessons(){
  const ph = document.createElement('option');
  ph.value=""; ph.textContent="â€” Select a lesson â€”";
  lessonSel.appendChild(ph);

  for(let i=1;i<=JSON_COUNT;i++){
    const o=document.createElement('option');
    o.value=String(i); o.textContent = `Lesson ${i}`;
    lessonSel.appendChild(o);
  }

  lessonSel.value = "";
  statusEl.textContent = "Please select a lesson to begin.";
  addMsg("Welcome! Select your lesson above.", "bot");
})();
</script>
</body>
</html>
