<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>St. Mary's College</title>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      height: 100dvh;
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f9fafb;
    }
    .chat-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      border: 3px solid #1e40af;
    }
    .chat-header {
      background: #1e40af; /* azul */
      color: #f3c344; /* dorado */
      padding: 12px;
      text-align: center;
      font-weight: bold;
      font-size: 1.3em;
      flex-shrink: 0;
    }
    .chat-messages {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      font-size: 1em;
      line-height: 1.5em;
      background: #ffffff;
      white-space: pre-line;
    }
    .message {
      margin: 6px 0;
      padding: 10px;
      border-radius: 8px;
      max-width: 85%;
      word-wrap: break-word;
    }
    .user {
      background: #1e40af;
      color: #fff;
      margin-left: auto;
    }
    .bot {
      background: #f3f4f6;
      color: #111;
      margin-right: auto;
      border: 1px solid #ddd;
    }

    .chat-input {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px;
      background: #f3f4f6;
      position: sticky;
      bottom: 0;
    }
    .chat-input input {
      flex: 1 1 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
    }
    .chat-input button {
      flex: 1;
      min-width: 50px;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      padding: 10px;
    }
    .send-button { background: #1e40af; color: white; }
    .mic-button { background: #f3c344; color: black; font-weight: bold; }
    .stop-button { background: #555; color: white; }

    @media (max-width: 600px) {
      .chat-header { font-size: 1.2em; padding: 10px; }
      .chat-input input { font-size: 1em; }
      .chat-input button { font-size: 1.1em; }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">St. Mary's College</div>
    <div class="chat-messages" id="chatMessages">
      <div class="message bot">üëã ¬°Hola! ¬øQuieres que responda en espa√±ol o en ingl√©s?</div>
    </div>
    <div class="chat-input">
      <input type="text" id="userInput" placeholder="Escribe un mensaje...">
      <button class="send-button" onclick="sendMessage()">‚û§</button>
      <button class="mic-button" onclick="startListening()">üéôÔ∏è</button>
      <button class="stop-button" onclick="stopSpeaking()">‚èπÔ∏è</button>
    </div>
  </div>

  <script>
    const API_KEY = "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";

    let userLanguage = null;
    let availableVoices = [];
    let conversationHistory = []; // ‚úÖ memoria corta

    function loadVoices() { availableVoices = speechSynthesis.getVoices(); }
    speechSynthesis.onvoiceschanged = loadVoices;

    function stopSpeaking() { speechSynthesis.cancel(); }

    function detectarIdioma(msg) {
      const lowerMsg = msg.toLowerCase();
      if (lowerMsg.includes("espa√±ol") || lowerMsg.includes("espanol") || lowerMsg.includes("spanish")) return "es";
      else if (lowerMsg.includes("ingl√©s") || lowerMsg.includes("ingles") || lowerMsg.includes("english")) return "en";
      return null;
    }

    // ‚úÖ Formateo de listas y vi√±etas
    function formatLists(text) {
      return text
        .replace(/(\d+)\.\s*/g, "\n$1. ")   // enumeraciones 1., 2., 3.
        .replace(/[-‚Ä¢]\s*/g, "\n- ");       // vi√±etas - o ‚Ä¢
    }

    async function sendMessage(userMessage = null) {
      const input = document.getElementById('userInput');
      const msg = userMessage || input.value.trim();
      if (!msg) return;

      const userDiv = document.createElement('div');
      userDiv.className = 'message user';
      userDiv.textContent = msg;
      document.getElementById('chatMessages').appendChild(userDiv);

      const botDiv = document.createElement('div');
      botDiv.className = 'message bot';
      botDiv.textContent = "ü§î pensando...";
      document.getElementById('chatMessages').appendChild(botDiv);

      if (!userLanguage) {
        const idiomaDetectado = detectarIdioma(msg);
        if (idiomaDetectado === "es") {
          userLanguage = "es";
          botDiv.textContent = "Perfecto, responder√© en espa√±ol üá™üá∏";
          return;
        } else if (idiomaDetectado === "en") {
          userLanguage = "en";
          botDiv.textContent = "Great! I will answer in English üá¨üáß";
          return;
        } else {
          botDiv.textContent = "Por favor, dime si quieres que responda en espa√±ol o en ingl√©s.";
          return;
        }
      }

      // ‚úÖ Guardar en memoria de conversaci√≥n
      conversationHistory.push({ role: "user", content: msg });
      if (conversationHistory.length > 5) conversationHistory.shift();

      try {
        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${API_KEY}`
          },
          body: JSON.stringify({
            model: "llama-3.1-8b-instant",
            messages: [
              { role: "system", content: userLanguage === "en"
                ? "You are an English coach. ALWAYS respond only in English. If the user speaks or writes in English, check for pronunciation or grammar mistakes. Show the corrected version and highlight mistakes. Encourage the student."
                : "Eres un coach de ingl√©s. Responde siempre en espa√±ol. S√© claro, natural y corrige errores cuando sea necesario." },
              ...conversationHistory
            ]
          })
        });

        const data = await response.json();
        let reply = data.choices[0].message.content;

        reply = formatLists(reply); // ‚úÖ aplica formato
        botDiv.textContent = reply;

        let cleanReply = reply.replace(/[*_`#>/\\]/g, "").replace(/\s{2,}/g, " ");
        const utterance = new SpeechSynthesisUtterance(cleanReply);

        if (userLanguage === "es") {
          utterance.lang = "es-ES";
          const vozEsp = availableVoices.find(v => v.name.includes("Google espa√±ol") || v.lang === "es-ES");
          if (vozEsp) utterance.voice = vozEsp;
        } else {
          utterance.lang = "en-US";
          let vozIng = availableVoices.find(v => v.name.includes("Google US English"));
          if (!vozIng) vozIng = availableVoices.find(v => v.lang.startsWith("en"));
          if (vozIng) utterance.voice = vozIng;
        }
        speechSynthesis.speak(utterance);

        // ‚úÖ Guardar respuesta del bot en memoria
        conversationHistory.push({ role: "assistant", content: reply });
        if (conversationHistory.length > 5) conversationHistory.shift();

      } catch (error) {
        botDiv.textContent = "‚ö†Ô∏è Error conectando con Groq";
        console.error(error);
      }

      document.getElementById('chatMessages').scrollTop =
        document.getElementById('chatMessages').scrollHeight;
      input.value = "";
    }

    function startListening() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) { alert("Tu navegador no soporta voz üò¢"); return; }
      const recognition = new SpeechRecognition();
      recognition.lang = userLanguage === "en" ? "en-US" : "es-ES";
      recognition.interimResults = false;
      recognition.start();

      recognition.onresult = e => sendMessage(e.results[0][0].transcript);
      recognition.onerror = e => console.error("‚ùå Error:", e.error);
    }
  </script>
</body>
</html>























