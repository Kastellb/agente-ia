<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>St. Mary’s College — English Leveler v2.7</title>
<style>
:root{ --brand:#0b3b71; --bg:#eef2f7; --bot:#0b88e6; --user:#12b886; }
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:#0f172a; display:flex; flex-direction:column;
}
header{
  background:var(--brand); color:#fff; padding:12px 16px;
  display:flex; flex-wrap:wrap; gap:12px; align-items:center;
}
h1{margin:0;font-size:16px;font-weight:800}
.badge{font-size:12px;opacity:.9}
main{flex:1;display:flex;justify-content:center}
.wrap{width:min(1000px,100%);padding:16px;display:flex;flex-direction:column;gap:12px}

/* Top toolbar */
.toolbar{
  background:#fff; border-radius:14px; padding:10px;
  display:flex; gap:12px; align-items:center; flex-wrap:wrap;
  box-shadow:0 12px 28px rgba(2,6,23,.08)
}
.label{font-weight:800}
select,button{font:600 14px/1 system-ui}
#lesson{
  padding:8px 10px; border-radius:10px; border:1px solid #cbd5e1;
  background:#f8fafc; min-width:280px;
}
.status{
  font-size:13px; color:#334155; background:#0b3b7112; border:1px dashed #0b3b7130;
  padding:6px 10px; border-radius:10px; min-height:34px; display:flex; align-items:center;
}

/* Voice settings panel */
.voice-settings {
  background:#f1f5f9; border-radius:10px; padding:12px;
  margin-top:8px; display:none; flex-wrap:wrap; gap:12px;
}
.voice-settings.visible { display:flex; }
.voice-control {
  display:flex; flex-direction:column; gap:6px; min-width:180px;
}
.voice-control label {
  font-size:12px; font-weight:600; color:#334155;
}
.voice-control select, .voice-control input {
  padding:6px 8px; border-radius:6px; border:1px solid #cbd5e1;
}

/* Chat area */
#chat{
  background:#fff; border-radius:16px; padding:12px 12px 4px;
  min-height:58vh; overflow:auto; box-shadow:0 12px 28px rgba(2,6,23,.12)
}
.msg{
  max-width:min(720px,92%); padding:10px 12px; border-radius:12px;
  margin:10px 0; line-height:1.45; white-space:pre-wrap;
  transition: background-color 0.2s ease;
}
.msg.bot{background:var(--bot);color:#fff;border-bottom-left-radius:4px}
.msg.user{background:var(--user);color:#fff;border-bottom-right-radius:4px;margin-left:auto}
.msg.playing { box-shadow: 0 0 0 2px #f59e0b; }

/* Message controls */
.msg-controls {
  display:flex; gap:6px; margin-top:6px;
}
.msg-control {
  background:rgba(255,255,255,0.2); border:none; border-radius:6px;
  padding:4px 8px; font-size:12px; color:#fff; cursor:pointer;
}
.msg-control:hover { background:rgba(255,255,255,0.3); }

/* Inline buttons inside chat */
.inline-btns{ display:flex; gap:10px; flex-wrap:wrap; margin:6px 0 2px }
.inline-btn{
  border:0; border-radius:10px; padding:8px 12px; font-weight:800; color:#fff; cursor:pointer; background:#0b88e6;
}
.inline-btn.secondary{ background:#6b7280 }

/* Composer: input arriba, botones debajo */
.composer{
  background:#fff; border-radius:14px; padding:10px;
  box-shadow:0 12px 28px rgba(2,6,23,.08);
  display:flex; flex-direction:column; gap:10px;
}
#text{
  width:100%; border:0; outline:0; font-size:16px; padding:12px;
  border-radius:10px; background:#f7f9fc
}
.btnrow{
  display:flex; gap:10px; flex-wrap:wrap;
}
.btn{
  border:0; border-radius:12px; padding:10px 14px; font-weight:800; color:#fff; cursor:pointer;
  display:flex; align-items:center; gap:6px;
}
#send{background:#22c55e} 
#mic{background:#0ea5e9} 
#stop{background:#ef4444}
#voiceSettings{background:#8b5cf6}

/* Voice status indicator */
.voice-status {
  display:flex; align-items:center; gap:6px; font-size:13px; color:#64748b;
}
.voice-status .indicator {
  width:12px; height:12px; border-radius:50%; background:#ddd;
}
.voice-status .speaking .indicator {
  background:#22c55e; animation: pulse 1.5s infinite;
}
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

/* Mobile tweaks */
@media (max-width:640px){
  h1{font-size:14px}
  .msg{max-width:96%}
  #lesson{min-width:unset}
  .voice-settings { flex-direction: column; }
  .voice-control { width: 100%; }
}
</style>
</head>
<body>
<header>
  <h1>St. Mary’s College — English Leveler v2.7</h1>
  <span class="badge">Enhanced Voice + Text • EN only • JSON-driven (1–13)</span>
</header>

<main>
  <div class="wrap">

    <div class="toolbar">
      <span class="label">Select lesson:</span>
      <select id="lesson" aria-label="Select lesson"></select>
      <div class="voice-status">
        <span class="indicator"></span>
        <span id="voiceStatusText">Voice: Ready</span>
      </div>
      <span id="status" class="status">Please select a lesson to begin.</span>
    </div>

    <div class="voice-settings" id="voiceSettingsPanel">
      <div class="voice-control">
        <label for="voiceSelect">Voice:</label>
        <select id="voiceSelect"></select>
      </div>
      <div class="voice-control">
        <label for="rateSelect">Speed:</label>
        <input type="range" id="rateSelect" min="0.5" max="2" step="0.1" value="1">
        <span id="rateValue">1.0</span>
      </div>
      <div class="voice-control">
        <label for="pitchSelect">Pitch:</label>
        <input type="range" id="pitchSelect" min="0.5" max="2" step="0.1" value="1">
        <span id="pitchValue">1.0</span>
      </div>
      <div class="voice-control">
        <button id="testVoice" class="btn" style="background:#6366f1; margin-top:18px">Test Voice</button>
      </div>
    </div>

    <div id="chat" aria-live="polite"></div>

    <div class="composer">
      <input id="text" placeholder="Type your message and press Enter…" autocomplete="off">
      <div class="btnrow">
        <button id="send" class="btn">Send</button>
        <button id="mic" class="btn">Speak</button>
        <button id="stop" class="btn">Stop</button>
        <button id="voiceSettings" class="btn">Voice Settings</button>
      </div>
    </div>

  </div>
</main>

<script>
/* ===== CONFIG ===== */
const WORKER_URL = "https://bot-maestro-proxy.kast-mercadeo.workers.dev/"; // tu Worker
const JSON_BASE  = "https://www.leccion.datafast.pw/lessons/";             // carpeta de JSON
const JSON_COUNT = 13;                                                      // tenemos 13 JSON
const PASS_MARK  = 90;                                                      // mínimo 90%
const MAX_QUEST  = 10;                                                      // hasta 10 preguntas

/* ===== Estado ===== */
const chat   = document.getElementById('chat');
const input  = document.getElementById('text');
const send   = document.getElementById('send');
const mic    = document.getElementById('mic');
const stopBtn= document.getElementById('stop');
const voiceSettingsBtn = document.getElementById('voiceSettings');
const voiceSettingsPanel = document.getElementById('voiceSettingsPanel');
const lessonSel = document.getElementById('lesson');
const statusEl  = document.getElementById('status');
const voiceSelect = document.getElementById('voiceSelect');
const rateSelect = document.getElementById('rateSelect');
const pitchSelect = document.getElementById('pitchSelect');
const rateValue = document.getElementById('rateValue');
const pitchValue = document.getElementById('pitchValue');
const testVoiceBtn = document.getElementById('testVoice');
const voiceStatusText = document.getElementById('voiceStatusText');
const voiceStatusIndicator = document.querySelector('.voice-status .indicator');

let currentLesson = null;
let lessonData = null;       // JSON lección actual
let prevLessonData = null;   // JSON lección anterior
let quizState = null;        // {active, items, i, correct, total, forLesson}
let lockedUntilPass = null;  // número de lección bloqueada hasta pasar quiz

// Estado de voz
let currentUtterance = null;
let isSpeaking = false;
let voices = [];
let voiceSettings = {
  voice: null,
  rate: 1,
  pitch: 1
};

/* ===== Utilidades visuales y TTS ===== */
function addMsg(text, who="bot"){
  const clean = cleanDisplay(String(text||''));
  const d=document.createElement('div');
  d.className = `msg ${who}`;
  d.textContent = clean;
  
  // Añadir controles de voz para mensajes del bot
  if (who === "bot") {
    const controls = document.createElement('div');
    controls.className = 'msg-controls';
    controls.innerHTML = `
      <button class="msg-control" onclick="speakMessage(this.parentNode.parentNode)">Speak</button>
      <button class="msg-control" onclick="stopSpeech()">Stop</button>
    `;
    d.appendChild(controls);
  }
  
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
  return d;
}

function addInlineButtons(buttons){
  const wrap = document.createElement('div');
  wrap.className = 'inline-btns';
  buttons.forEach(b=>{
    const btn = document.createElement('button');
    btn.className = 'inline-btn' + (b.secondary?' secondary':'');
    btn.textContent = b.text;
    btn.addEventListener('click', b.onClick);
    wrap.appendChild(btn);
  });
  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
  return wrap;
}

function sanitizeSpeak(s){
  return (s||"")
    .replace(/https?:\/\/\S+/g,'')
    .replace(/[`*_~#>\[\]\(\){}|\\]/g,' ')
    .replace(/[•▪︎●◦\-\u2022]\s+/g,' ')
    .replace(/[\u2190-\u21FF]/g,' ')
    .replace(/[\u2460-\u24FF]/g,' ')
    .replace(/[\u2500-\u25FF]/g,' ')
    .replace(/[\u2600-\u27BF]/g,' ')
    .replace(/[\u{1F000}-\u{1FAFF}]/gu,' ')
    .replace(/\s{2,}/g,' ').trim();
}

function cleanDisplay(s){
  return (s||"")
    .replace(/[*_~`#>|]/g,'')
    .replace(/\s{2,}/g,' ')
    .trim();
}

// Sistema de voz mejorado
function initVoices() {
  // Cargar configuraciones guardadas
  const savedSettings = localStorage.getItem('smc.voiceSettings');
  if (savedSettings) {
    voiceSettings = {...voiceSettings, ...JSON.parse(savedSettings)};
  }
  
  // Actualizar controles con valores guardados
  rateSelect.value = voiceSettings.rate;
  pitchSelect.value = voiceSettings.pitch;
  rateValue.textContent = voiceSettings.rate.toFixed(1);
  pitchValue.textContent = voiceSettings.pitch.toFixed(1);
  
  // Cargar voces disponibles
  voices = window.speechSynthesis.getVoices();
  
  // Limpiar y poblar selector de voces
  voiceSelect.innerHTML = '';
  voices.forEach((voice, index) => {
    const option = document.createElement('option');
    option.value = index;
    option.textContent = `${voice.name} (${voice.lang})`;
    voiceSelect.appendChild(option);
    
    // Seleccionar voz guardada o primera voz en inglés por defecto
    if (voiceSettings.voice === voice.name || 
        (!voiceSettings.voice && /^en(-|_)/i.test(voice.lang) && voiceSelect.selectedIndex === -1)) {
      voiceSelect.value = index;
      voiceSettings.voice = voice.name;
    }
  });
  
  // Si no hay voces, intentar cargarlas de nuevo cuando estén disponibles
  if (voices.length === 0) {
    window.speechSynthesis.onvoiceschanged = initVoices;
  }
}

function speak(text, elementToHighlight = null) {
  try {
    stopSpeech();
    
    const t = sanitizeSpeak(String(text||''));
    if(!t) return;
    
    currentUtterance = new SpeechSynthesisUtterance(t);
    
    // Aplicar configuraciones de voz
    if (voiceSelect.value) {
      currentUtterance.voice = voices[voiceSelect.value];
    }
    currentUtterance.rate = parseFloat(rateSelect.value);
    currentUtterance.pitch = parseFloat(pitchSelect.value);
    
    // Resaltar elemento mientras se habla
    if (elementToHighlight) {
      elementToHighlight.classList.add('playing');
    }
    
    // Eventos para gestionar el estado
    currentUtterance.onstart = () => {
      isSpeaking = true;
      updateVoiceStatus('Speaking...', true);
      if (elementToHighlight) {
        elementToHighlight.classList.add('playing');
      }
    };
    
    currentUtterance.onend = () => {
      isSpeaking = false;
      updateVoiceStatus('Voice: Ready', false);
      if (elementToHighlight) {
        elementToHighlight.classList.remove('playing');
      }
      currentUtterance = null;
    };
    
    currentUtterance.onerror = (event) => {
      isSpeaking = false;
      updateVoiceStatus('Voice Error: ' + event.error, false);
      if (elementToHighlight) {
        elementToHighlight.classList.remove('playing');
      }
      console.error('SpeechSynthesis error:', event.error);
      currentUtterance = null;
    };
    
    window.speechSynthesis.speak(currentUtterance);
  } catch(e) {
    console.error('Speech error:', e);
    updateVoiceStatus('Voice Error', false);
  }
}

function speakMessage(element) {
  const text = element.textContent || element.innerText;
  speak(text, element);
}

function stopSpeech() {
  if (window.speechSynthesis.speaking) {
    window.speechSynthesis.cancel();
    isSpeaking = false;
    updateVoiceStatus('Voice: Stopped', false);
    
    // Quitar resaltado de todos los mensajes
    document.querySelectorAll('.msg.playing').forEach(msg => {
      msg.classList.remove('playing');
    });
  }
}

function updateVoiceStatus(text, speaking) {
  voiceStatusText.textContent = text;
  if (speaking) {
    voiceStatusIndicator.classList.add('speaking');
  } else {
    voiceStatusIndicator.classList.remove('speaking');
  }
}

function toggleVoiceSettings() {
  voiceSettingsPanel.classList.toggle('visible');
}

function saveVoiceSettings() {
  voiceSettings.voice = voices[voiceSelect.value]?.name || null;
  voiceSettings.rate = parseFloat(rateSelect.value);
  voiceSettings.pitch = parseFloat(pitchSelect.value);
  localStorage.setItem('smc.voiceSettings', JSON.stringify(voiceSettings));
}

function testVoiceSettings() {
  speak("This is a test of the current voice settings. You can adjust the speed and pitch to your preference.");
}

// Inicializar sistema de voz cuando las voces estén disponibles
if (window.speechSynthesis) {
  window.speechSynthesis.onvoiceschanged = initVoices;
}

/* ===== STT (inglés) ===== */
let rec=null,isRec=false;
function sttStart(){
  if(isRec) return;
  const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ addMsg("Voice recognition is not supported. Please type your message.","bot"); return; }
  rec = new SR();
  rec.lang = 'en-US'; rec.continuous=false; rec.interimResults=false;
  rec.onresult = (e)=>{
    const t = e.results?.[0]?.[0]?.transcript||"";
    if(t){ input.value=t; sendMsg(); }
  };
  rec.onstart = ()=>{ isRec=true; speak("Listening"); };
  rec.onerror= ()=>{ isRec=false; };
  rec.onend  = ()=>{ isRec=false; };
  rec.start();
}
function stopAll(){ 
  stopSpeech();
  try{rec&&rec.abort()}catch(e){}
  isRec = false;
}

/* ===== Carga de JSON ===== */
async function fetchJSON(url){
  const r = await fetch(url, { cache:'no-store' });
  if(!r.ok) throw new Error(r.status+" "+r.statusText);
  return await r.json();
}
async function loadLesson(n){
  currentLesson = n;
  lessonData = null; prevLessonData = null; quizState=null;

  // Limpia mensajes previos de selección anterior (para evitar confusiones)
  addMsg(`Lesson ${n} selected. Preparing materials…`, "bot");

  // Carga JSON de la lección actual (solo para mostrar si se desbloquea)
  try{
    if(n <= JSON_COUNT){
      lessonData = await fetchJSON(`${JSON_BASE}lesson${n}.json`);
    }
  }catch(e){ /* si falla, se continúa con contexto mínimo */ }

  // Carga JSON de la lección anterior para el quiz
  try{
    if(n > 1 && (n-1) <= JSON_COUNT){
      prevLessonData = await fetchJSON(`${JSON_BASE}lesson${n-1}.json`);
    }
  }catch(e){ /* opcional */ }

  // Status visible
  const titleTxt = lessonData?.title ? `Lesson ${n} — ${lessonData.title}` : `Lesson ${n}`;

  if(n === 1){
    statusEl.textContent = `${titleTxt}. You can start now.`;
    if(lessonData){
      const theoryMsg = addMsg(`Theory — ${lessonData.title}\n${lessonData.theory||""}`, "bot");
      speak(`Theory: ${lessonData.title}. ${lessonData.theory||""}`, theoryMsg);
      
      if(Array.isArray(lessonData.objectives)&&lessonData.objectives.length){
        const objectivesMsg = addMsg("Objectives:\n" + lessonData.objectives.map((x,i)=>`${i+1}. ${x}`).join('\n'), "bot");
        speak("Objectives: " + lessonData.objectives.join('. '), objectivesMsg);
      }
      if(Array.isArray(lessonData.topics)&&lessonData.topics.length){
        const topicsMsg = addMsg("Topics:\n" + lessonData.topics.map((x,i)=>`${i+1}. ${x}`).join('\n'), "bot");
        speak("Topics: " + lessonData.topics.join('. '), topicsMsg);
      }
    }else{
      addMsg("Lesson 1 ready. Ask what you would like to reinforce.", "bot");
    }
    lockedUntilPass=null;
  } else {
    statusEl.textContent = `${titleTxt}. First, a review of Lesson ${n-1} (need ≥ ${PASS_MARK}% to unlock).`;
    addMsg(`Before we begin Lesson ${n}, you must pass a short diagnostic from Lesson ${n-1}. You need at least ${PASS_MARK}%.`, "bot");
    const quizItems = Array.isArray(prevLessonData?.quizPrevious) ? prevLessonData.quizPrevious.slice(0, MAX_QUEST) : [];
    if(!quizItems.length){
      addMsg("This review has no configured questions yet. Please ask your instructor to add 'quizPrevious' to the previous lesson.", "bot");
      lockedUntilPass = n; // bloqueo hasta que exista quiz
      return;
    }
    addMsg("Are you ready to start the review now?", "bot");
    addInlineButtons([
      { text:"Ready", onClick: ()=> startQuiz(n, quizItems) },
      { text:"Not now", onClick: ()=> {
          addMsg(`No problem. Please review Lesson ${n-1} first. When you're ready, select Lesson ${n} again to start the review.`, "bot");
          lockedUntilPass = n;
        }, secondary:true
      }
    ]);
  }
}

/* ===== Quiz local (estricto) ===== */
function normalize(s){
  return String(s||'')
    .toLowerCase()
    .replace(/[\u2018\u2019']/g,"'")
    .replace(/[^a-z0-9' ]+/g,' ')
    .replace(/\s{2,}/g,' ')
    .trim();
}
function checkAnswer(user, expected){
  const u = normalize(user);
  const e = normalize(expected).replace(/\.\.\./g,''); // quitar '...'
  if(!u || !e) return false;
  return u===e || u.includes(e); // permite respuesta más larga que contenga la clave
}
function startQuiz(forLesson, items){
  quizState = {
    active:true,
    items:[...items],
    i:0,
    correct:0,
    total: Math.min(items.length, MAX_QUEST),
    forLesson
  };
  lockedUntilPass = forLesson;
  addMsg(`Review started (${quizState.total} questions) — from Lesson ${forLesson-1}. Answer in English.`, "bot");
  askNextQuestion();
}
function askNextQuestion(){
  const q = quizState.items[quizState.i];
  const questionMsg = addMsg(`Q${quizState.i+1}/${quizState.total}: ${q.question}`, "bot");
  speak(`Question ${quizState.i+1}. ${q.question}`, questionMsg);
}
function handleQuizAnswer(userText){
  const q = quizState.items[quizState.i];
  const ok = checkAnswer(userText, q.answer);
  if(ok){
    quizState.correct++;
    addMsg("Correct.", "bot");
  }else{
    addMsg(`Not quite. Expected: ${q.answer}`, "bot");
  }
  quizState.i++;
  if(quizState.i>=quizState.total){
    finishQuiz();
  }else{
    askNextQuestion();
  }
}
function finishQuiz(){
  const pct = Math.round((quizState.correct/quizState.total)*100);
  addMsg(`Review finished. Score: ${quizState.correct}/${quizState.total} — ${pct}%`, "bot");
  if(pct>=PASS_MARK){
    addMsg(`Great! You unlocked Lesson ${quizState.forLesson}.`, "bot");
    localStorage.setItem(`smc.unlock.${quizState.forLesson}`,'1');
    lockedUntilPass=null;
    // Mostrar Lesson actual (AHORA sí)
    if(lessonData){
      const theoryMsg = addMsg(`Theory — ${lessonData.title}\n${lessonData.theory||""}`, "bot");
      speak(`Theory: ${lessonData.title}. ${lessonData.theory||""}`, theoryMsg);
      
      if(Array.isArray(lessonData.objectives)&&lessonData.objectives.length){
        const objectivesMsg = addMsg("Objectives:\n" + lessonData.objectives.map((x,i)=>`${i+1}. ${x}`).join('\n'), "bot");
        speak("Objectives: " + lessonData.objectives.join('. '), objectivesMsg);
      }
      if(Array.isArray(lessonData.topics)&&lessonData.topics.length){
        const topicsMsg = addMsg("Topics:\n" + lessonData.topics.map((x,i)=>`${i+1}. ${x}`).join('\n'), "bot");
        speak("Topics: " + lessonData.topics.join('. '), topicsMsg);
      }
    }else{
      addMsg(`Lesson ${quizState.forLesson} unlocked. Ask what you want to reinforce.`, "bot");
    }
  }else{
    addMsg(`You need at least ${PASS_MARK}% to proceed. Please review Lesson ${quizState.forLesson-1} and try again.`, "bot");
    lockedUntilPass = quizState.forLesson;
  }
  quizState=null;
}

/* ===== Prompt estricto basado en JSON (para el modelo) ===== */
function buildPrompt(userText){
  const n = currentLesson;
  const title = lessonData?.title || `Lesson ${n}`;
  const theory = lessonData?.theory || "";
  const objectives = Array.isArray(lessonData?.objectives) ? lessonData.objectives : [];
  const topics = Array.isArray(lessonData?.topics) ? lessonData.topics : [];

  const rules =
`ROLE: You are the English leveling instructor for St. Mary’s College.
LANGUAGE: Reply in ENGLISH ONLY.
FORMAT: Plain text. No markdown, no asterisks, no emojis, no decorative symbols.
TONE: Clear, concise, encouraging. Natural phrasing. Use minimal IPA or simple syllable hints only when essential.
SCOPE: Strictly about Lesson ${n} — ${title}. If the user asks off-topic, provide a SHORT helpful note and redirect to Lesson ${n}.
TEACHING: First, briefly explain the what/why/how based on the lesson JSON; then answer. Correct grammar and suggest natural phrasing.
PRONUNCIATION: Avoid characters that TTS reads awkwardly. No bullets or decorative marks.`;

  const jsonContext =
`JSON_TITLE: ${title}
JSON_THEORY: ${theory}
JSON_OBJECTIVES:
${objectives.map((x,i)=>`${i+1}. ${x}`).join('\n')}
JSON_TOPICS:
${topics.map((x,i)=>`${i+1}. ${x}`).join('\n')}`;

  return `LESSON=${n}\n${rules}\n${jsonContext}\nUSER: ${userText}`;
}

/* ===== Backend ===== */
async function askInstructor(text){
  const r = await fetch(WORKER_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ text: buildPrompt(text), lang:"en-US" })
  });
  if(!r.ok) throw new Error("HTTP "+r.status);
  const data = await r.json().catch(()=>({ reply:"Connection error." }));
  return String(data.reply||"");
}

/* ===== Envío ===== */
async function sendMsg(){
  const t=(input.value||"").trim();
  if(!t) return;
  input.value="";
  addMsg(t,"user");

  // Si hay quiz en curso, no llamamos al modelo
  if(quizState?.active){
    handleQuizAnswer(t);
    return;
  }
  // Si la lección está bloqueada por no pasar el quiz
  if(lockedUntilPass && currentLesson===lockedUntilPass){
    addMsg(`Lesson ${currentLesson} is locked. Please review Lesson ${currentLesson-1} and start the review again.`, "bot");
    return;
  }
  // Si aún no se seleccionó lección
  if(!currentLesson){
    addMsg("Please select a lesson first.", "bot");
    return;
  }

  try{
    const reply = await askInstructor(t);
    const replyMsg = addMsg(reply,"bot"); 
    speak(reply, replyMsg);
  }catch(e){
    addMsg("Connection error with the server.", "bot");
  }
}

/* ===== Eventos UI ===== */
send.addEventListener('click', sendMsg);
input.addEventListener('keydown', e=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMsg(); }
});
mic.addEventListener('click', sttStart);
stopBtn.addEventListener('click', stopAll);
voiceSettingsBtn.addEventListener('click', toggleVoiceSettings);
lessonSel.addEventListener('change', ()=>{
  const v = lessonSel.value;
  if(!v){ statusEl.textContent="Please select a lesson to begin."; return; }
  loadLesson(+v);
});

// Eventos para controles de voz
voiceSelect.addEventListener('change', saveVoiceSettings);
rateSelect.addEventListener('input', function() {
  rateValue.textContent = this.value;
  saveVoiceSettings();
});
pitchSelect.addEventListener('input', function() {
  pitchValue.textContent = this.value;
  saveVoiceSettings();
});
testVoiceBtn.addEventListener('click', testVoiceSettings);

// Pausar voz cuando la página no es visible
document.addEventListener('visibilitychange', function() {
  if (document.hidden && isSpeaking) {
    window.speechSynthesis.pause();
  } else if (!document.hidden && window.speechSynthesis.paused) {
    window.speechSynthesis.resume();
  }
});

/* ===== Construir combo (placeholder + 1–270; títulos de JSON 1–13) ===== */
(async function buildLessons(){
  // Opción placeholder
  const ph = document.createElement('option');
  ph.value=""; ph.textContent="— Select a lesson —";
  lessonSel.appendChild(ph);

  // Prellenar 1–270
  for(let i=1;i<=270;i++){
    const o=document.createElement('option');
    o.value=String(i); o.textContent = `Lesson ${i}`;
    lessonSel.appendChild(o);
  }

  // Enriquecer títulos 1–13 leyendo JSON
  for(let i=1;i<=JSON_COUNT;i++){
    try{
      const j = await fetchJSON(`${JSON_BASE}lesson${i}.json`);
      if(j?.title){
        const opt = lessonSel.options[i]; // +1 por el placeholder
        if(opt) opt.textContent = `Lesson ${i} — ${j.title}`;
      }
    }catch(e){ /* si falla, queda "Lesson i" */}
  }

  // Estado inicial
  lessonSel.value = "";
  statusEl.textContent = "Please select a lesson to begin.";
  addMsg("Welcome! Select your lesson above. If you choose Lesson 2 or higher, you must pass a short review from the previous lesson (≥ 90%) to unlock it.", "bot");
  
  // Inicializar sistema de voz
  initVoices();
})();
</script>
</body>
</html>
