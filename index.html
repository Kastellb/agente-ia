<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üéì St. Mary‚Äôs College ‚Äì English Instructor (v1.6)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; margin: 0; }
    header { background: #003366; color: #fff; text-align: center; padding: 10px; font-size: 18px; }
    #chat { max-width: 800px; margin: 20px auto; background: #fff; border-radius: 10px; padding: 15px; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    .msg { margin: 8px 0; padding: 10px; border-radius: 8px; max-width: 75%; }
    .bot { background: #0099ff; color: white; align-self: flex-start; }
    .user { background: #00cc66; color: white; align-self: flex-end; margin-left: auto; }
    #input-area { display: flex; justify-content: center; margin-top: 10px; }
    #textInput { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
    button { margin-left: 5px; padding: 10px; border: none; border-radius: 6px; cursor: pointer; }
    .send { background: #00cc66; color: white; }
    .speak { background: #0099ff; color: white; }
    .stop { background: #ff3333; color: white; }
  </style>
</head>
<body>
  <header>üéì St. Mary‚Äôs College ‚Äì English Instructor (v1.6)</header>
  <div id="chat"></div>
  <div id="input-area">
    <input type="text" id="textInput" placeholder="Type or speak your message..." />
    <button class="send" onclick="sendMessage()">Send</button>
    <button class="speak" onclick="startListening()">üé§ Speak</button>
    <button class="stop" onclick="stopListening()">‚èπ Stop</button>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("textInput");
    let currentLesson = null;

    function addMessage(text, sender) {
      const div = document.createElement("div");
      div.classList.add("msg", sender);
      div.innerHTML = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function speak(text, lang="en-US") {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang;
      speechSynthesis.speak(utterance);
    }

    async function sendMessage(msg=null) {
      let text = msg || input.value.trim();
      if (!text) return;
      addMessage(text, "user");
      input.value = "";

      let normalized = text.toLowerCase().trim();

      // Diccionario de n√∫meros en ingl√©s
      const numbers = {
        "one": 1, "two": 2, "three": 3, "four": 4, "five": 5,
        "six": 6, "seven": 7, "eight": 8, "nine": 9, "ten": 10
      };

      // Detectar lecci√≥n
      let lessonMatch = normalized.match(/lesson\s+(\d+|one|two|three|four|five|six|seven|eight|nine|ten)/i);
      if (lessonMatch) {
        let lessonKey = lessonMatch[1];
        if (isNaN(lessonKey)) {
          currentLesson = numbers[lessonKey];
        } else {
          currentLesson = parseInt(lessonKey);
        }
        await loadLesson(currentLesson);
        return;
      }

      // Si ya hay lecci√≥n activa ‚Üí modo profesor
      if (currentLesson) {
        await teacherResponse(text);
      } else {
        addMessage("Please choose a lesson first (e.g., 'Lesson 1').", "bot");
      }
    }

    async function loadLesson(num) {
      try {
        const res = await fetch(`https://www.leccion.datafast.pw/lessons/lesson${num}.json`);
        if (!res.ok) throw new Error("Lesson not found");
        const lesson = await res.json();

        let intro = `
          üìò <b>Welcome to Lesson ${num}: ${lesson.title}</b><br><br>
          üìñ <b>Theory:</b> ${lesson.theory || "This lesson will guide you through the basics."}<br><br>
          üéØ <b>Objectives:</b><br>- ${lesson.objectives.join("<br>- ")}<br><br>
          üìã <b>Topics:</b><br>- ${lesson.topics.join("<br>- ")}<br><br>
          When you are ready, type or say a question about this lesson and I will explain it to you.
        `;
        addMessage(intro, "bot");
        speak(`Welcome to Lesson ${num}: ${lesson.title}. You can now ask me questions about this lesson.`, "en-US");

      } catch {
        addMessage("‚ö†Ô∏è Lesson not found or not uploaded yet.", "bot");
      }
    }

    async function teacherResponse(userText) {
      let answer = "";

      // Si detecta fuera de tema
      if (!/greet|hello|hi|formal|informal|introduc|name/i.test(userText)) {
        answer = "‚ö†Ô∏è Let‚Äôs stay focused. Right now we are studying greetings and introductions.";
      } else {
        // Usamos Groq v√≠a proxy
        try {
          const response = await fetch("https://bot-maestro-proxy.kast-mercadeo.workers.dev/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              text: `You are an English teacher at St. Mary's College. 
              The student asked: "${userText}". 
              Please answer in English, explain clearly, give examples, 
              and vary your explanation so it is not always identical. 
              Stay strictly inside the lesson theme: Greetings and Introductions.`
            })
          });
          const data = await response.json();
          answer = data.reply;
        } catch {
          // Respuestas locales si falla Groq
          const alternatives = [
            "Formal greetings show respect, like 'Good morning'. Informal greetings are casual, like 'Hi'.",
            "We use 'Good morning' in polite or professional contexts, while 'Hi' is for friends.",
            "Both mean hello, but the tone and situation decide which one you should use."
          ];
          answer = alternatives[Math.floor(Math.random() * alternatives.length)];
        }
      }

      addMessage(answer, "bot");
      speak(answer, "en-US");
    }

    // üé§ Speech recognition
    let recognition;
    function startListening() {
      if (!('webkitSpeechRecognition' in window)) {
        alert("Your browser does not support speech recognition.");
        return;
      }
      recognition = new webkitSpeechRecognition();
      recognition.lang = "en-US";
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        sendMessage(transcript);
      };
      recognition.start();
    }
    function stopListening() {
      if (recognition) recognition.stop();
    }

    // Mensaje inicial
    addMessage("üëã Welcome to St. Mary‚Äôs College! Please tell me which lesson you want to review (e.g., 'Lesson 1' or 'Lesson one').", "bot");
  </script>
</body>
</html>
