<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>St. Mary‚Äôs College ‚Äì English Leveling Bot (v2.2)</title>
  <style>
    :root{
      --bg:#f5f7fa; --ink:#0f172a; --bot:#0ea5e9; --user:#22c55e; --muted:#64748b;
      --focus:#2563eb; --select:#fde047; --select-ink:#111827; --overlay: rgba(15,23,42,.55);
      --chip:#ffffff; --chip-border:#cbd5e1; --chip-ink:#0f172a;
    }
    *{box-sizing:border-box}
    ::selection{ background:var(--select); color:var(--select-ink); }
    ::-moz-selection{ background:var(--select); color:var(--select-ink); }

    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--ink);
      display:flex; flex-direction:column; min-height:100vh;
    }
    header{
      background:#0b3b71; color:#fff; padding:12px 16px; display:flex; align-items:center; justify-content:space-between;
      font-weight:700; gap:8px; flex-wrap:wrap;
    }
    header .right{ display:flex; gap:8px; }
    .btn{ border:0; padding:12px 14px; font-weight:700; cursor:pointer; border-radius:12px; color:#fff;
          box-shadow:0 2px 6px rgba(2,8,23,.08); min-height:48px; }
    .btn-lessons{ background:#7c3aed; }

    #chat{ flex:1; max-width:900px; width:100%; margin:16px auto; padding:0 12px; }
    .bubble{
      max-width:75%; padding:12px 14px; margin:8px 0; border-radius:14px; line-height:1.45;
      box-shadow:0 4px 12px rgba(2,8,23,.08);
    }
    .bot{ background:var(--bot); color:#fff; border-bottom-left-radius:4px; }
    .user{ background:var(--user); color:#fff; margin-left:auto; border-bottom-right-radius:4px; }
    .sys{ background:#e2e8f0; color:#0f172a; margin:16px auto; border-radius:10px; }
    .muted{ color:var(--muted); font-size:14px; }
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:#e2e8f0; padding:1px 6px; border-radius:6px;}
    .bot .kbd{ background:#ffffff; color:#0f172a; }

    /* Controls (m√≥vil/desktop) */
    #controls{
      position:sticky; bottom:0; background:#fff; border-top:1px solid #e2e8f0;
      padding:10px clamp(10px,3vw,16px) calc(10px + env(safe-area-inset-bottom)) clamp(10px,3vw,16px);
      display:grid; grid-template-columns:1fr; gap:10px;
    }
    #textInput{
      width:100%; padding:12px 14px; font-size:16px; border:1px solid #cbd5e1; border-radius:12px; outline:0;
      transition:border .15s, box-shadow .15s; min-height:48px; background:#fff; color:#0f172a;
    }
    #textInput:focus{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(37,99,235,.2); }
    .buttons{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    #sendBtn{ background:#22c55e; }
    #speakBtn{ background:#0ea5e9; }
    #stopBtn{ background:#ef4444; }

    @media (min-width: 720px){
      #controls{ display:flex; align-items:center; gap:10px; padding-bottom:12px; }
      #textInput{ flex:1; }
      .buttons{ display:flex; gap:10px; }
    }

    /* Overlay lecciones */
    #lessonsOverlay{ position:fixed; inset:0; background:var(--overlay); display:none; align-items:center; justify-content:center; z-index:50; }
    #lessonsCard{
      width:min(820px,94vw); background:#fff; border-radius:16px; padding:16px; box-shadow:0 16px 40px rgba(2,8,23,.35);
      display:flex; flex-direction:column; gap:12px;
    }
    #lessonsCard h3{ margin:0; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row input[type="number"], .row input[type="text"]{ flex:1; min-width:220px; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; outline:0; }
    .row input:focus{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(37,99,235,.2); }
    .btn-go{ background:#0ea5e9; color:#fff; border:0; padding:10px 12px; border-radius:10px; }
    .btn-close{ background:#334155; color:#fff; border:0; padding:10px 12px; border-radius:10px; }
    .pager{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .page-btn{ background:#fff; color:#0f172a; border:1px solid #cbd5e1; padding:6px 10px; border-radius:999px; cursor:pointer; }
    .page-btn.active{ background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(90px,1fr)); gap:8px; max-height:340px; overflow:auto; padding:4px; }
    .chip{ background:var(--chip); border:1px solid var(--chip-border); color:var(--chip-ink); padding:8px 10px; border-radius:999px;
           box-shadow:0 2px 4px rgba(2,8,23,.06); cursor:pointer; font-weight:700; text-align:center; user-select:none; outline:none; }
    .chip:hover, .chip:focus-visible{ border-color:#0ea5e9; box-shadow:0 0 0 3px rgba(14,165,233,.2); }
    .note{ font-size:14px; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <div>St. Mary‚Äôs College ‚Äì English Leveling Bot (v2.2)</div>
    <div class="right">
      <button class="btn btn-lessons" id="openLessonsBtn">üìö Lessons</button>
      <!-- (Stop arriba eliminado) -->
    </div>
  </header>

  <main id="chat"></main>

  <!-- Controls -->
  <div id="controls">
    <input id="textInput" type="text" placeholder="Type or say your message‚Ä¶ e.g., ‚ÄúLesson 7‚Äù" autocomplete="off"/>
    <div class="buttons">
      <button id="sendBtn"  class="btn">Send</button>
      <button id="speakBtn" class="btn">üé§ Speak</button>
      <button id="stopBtn"  class="btn">‚èπ Stop</button>
    </div>
  </div>

  <!-- Overlay Lecciones -->
  <div id="lessonsOverlay" role="dialog" aria-modal="true">
    <div id="lessonsCard">
      <h3>Select a lesson</h3>
      <div class="note" id="rangeNote">Loading available lessons‚Ä¶</div>
      <div class="row">
        <input id="numInput" type="number" min="1" max="270" placeholder="Go to lesson # (e.g., 12)"/>
        <input id="wordsInput" type="text" placeholder="Or type in words (e.g., twenty three)"/>
        <button class="btn-go" id="goBtn">Go</button>
        <button class="btn-close" id="closeLessonsBtn">Close</button>
      </div>
      <div class="pager" id="pager"></div>
      <div class="grid"  id="grid"></div>
      <div class="note">Tip: you can also type <span class="kbd">Lesson 12</span> in the chat.</div>
    </div>
  </div>

  <script>
    /* ================= EN-only guard (fuerte) ================= */
    const EN_ONLY = true;
    const SPANISH_RE = /[√°√©√≠√≥√∫√±√º¬ø¬°]|(?:\b(?:el|la|los|las|de|del|al|y|o|pero|porque|con|sin|para|por|un|una|unos|unas|es|est√°|hola|gracias|buenos|buenas|tardes|noches|por favor|c√≥mo|qu√©|d√≥nde|cu√°ndo|lecci√≥n|leccion)\b)/i;
    const SP_HINTS_RE = /\b(hola|buenos|buenas|noches|tardes|usted(?:es)?|gracias|por\s+favor|porque|c√≥mo|qu√©|d√≥nde|cu√°ndo|lecci√≥n|leccion)\b/i;
    const SP_STOP = new Set(["de","la","que","el","en","y","a","los","del","se","las","por","un","para","con","no","una","su","al","lo","como","m√°s","o","pero","sus","le","ya","este","s√≠","porque","esta","entre","cuando","muy","sin","sobre","tambi√©n","me","hasta"]);

    function looksSpanish(text){
      const s = (text||"").toLowerCase();
      if (SPANISH_RE.test(s) || SP_HINTS_RE.test(s)) return true;
      const tokens = s.replace(/[^a-z\s]/g," ").split(/\s+/).filter(Boolean);
      if (!tokens.length) return false;
      let hits=0; for(const t of tokens){ if(SP_STOP.has(t)) hits++; }
      return hits / tokens.length > 0.25;
    }

    /* ================= UI helpers ================= */
    const chat=document.getElementById("chat");
    const input=document.getElementById("textInput");
    const sendBtn=document.getElementById("sendBtn");
    const speakBtn=document.getElementById("speakBtn");
    const stopBtn=document.getElementById("stopBtn");

    function addMessage(html, role="bot"){
      if(role==="bot"){
        const plain = html.replace(/<[^>]*>/g," ");
        if(looksSpanish(plain)){
          html = "English-only mode is active. Content was blocked because it appears to be Spanish.";
        }
      }
      const el=document.createElement("div");
      el.className=`bubble ${role}`;
      el.innerHTML=html;
      chat.appendChild(el);
      chat.scrollTop=chat.scrollHeight;
    }
    function addSystem(text){
      const el=document.createElement("div");
      el.className="bubble sys";
      el.innerText=text;
      chat.appendChild(el);
      chat.scrollTop=chat.scrollHeight;
    }

    /* ================= TTS limpio ================= */
    function sanitizeForSpeech(text){
      let t = String(text||"");
      t = t.replace(/<[^>]*>/g,' ');
      t = t.replace(/\bhttps?:\/\/\S+/gi,' ');
      t = t.replace(/&[a-z]+;/gi,' ');
      try{ t = t.replace(/\p{Extended_Pictographic}/gu,''); }catch{ t = t.replace(/[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}]/gu,''); }
      try{ t = t.replace(/[^\p{L}\p{N}\.\,\:\;\?\!\s]/gu,' '); }catch{ t = t.replace(/[^A-Za-z0-9\.\,\:\;\?\!\s]/g,' '); }
      t = t.replace(/\s{2,}/g,' ').trim();
      return t;
    }
    function speakSafe(text, lang="en-US"){
      try{
        const plain = sanitizeForSpeech(text);
        if(!plain) return;
        if(looksSpanish(plain)) return;
        speechSynthesis.cancel();
        const u=new SpeechSynthesisUtterance(plain);
        u.lang=lang; speechSynthesis.speak(u);
      }catch{}
    }
    function stopAll(){ try{ if(recognition) recognition.stop(); speechSynthesis.cancel(); }catch{} }

    /* ================= Parse 'Lesson N' ================= */
    function wordsToNumber(phrase){
      const ones={zero:0,one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9};
      const teens={ten:10,eleven:11,twelve:12,thirteen:13,fourteen:14,fifteen:15,sixteen:16,seventeen:17,eighteen:18,nineteen:19};
      const tens={twenty:20,thirty:30,forty:40,fifty:50,sixty:60,seventy:70,eighty:80,ninety:90};
      let s=phrase.toLowerCase().replace(/-/g,' ').replace(/[^a-z\s]/g,' ').replace(/\s+/g,' ').trim();
      if(!s) return null;
      if(ones[s]!==undefined) return ones[s]; if(teens[s]!==undefined) return teens[s]; if(tens[s]!==undefined) return tens[s];
      const tokens=s.split(' '); let total=0,current=0;
      for(const w of tokens){
        if(ones[w]!==undefined){ current+=ones[w]; continue; }
        if(teens[w]!==undefined){ current+=teens[w]; continue; }
        if(tens[w]!==undefined){ current+=tens[w]; continue; }
        if(w==="hundred"){ if(current===0) current=1; current*=100; total+=current; current=0; continue; }
        if(w==="and"){ continue; }
        return null;
      }
      total+=current; return total||null;
    }
    function parseLessonNumberFromText(text){
      const s=text.toLowerCase();
      const mDigits=s.match(/lesson\s+(\d{1,3})\b/); if(mDigits){ const n=parseInt(mDigits[1],10); if(n>=1 && n<=270) return n; }
      const mWords=s.match(/lesson\s+([a-z][a-z\s-]{1,60})$/i) || s.match(/lesson\s+([a-z][a-z\s-]{1,60})\b/i);
      if(mWords){ const n=wordsToNumber(mWords[1]); if(n && n>=1 && n<=270) return n; }
      return null;
    }

    /* ================= State & index ================= */
    let currentLesson=null, lessonData=null, availableLessons=[];
    let quizActive=false, quizIndex=0, quizCorrect=0, quizQuestions=[];
    let sessionLocked=false;
    let pendingLessonNum=null, pendingLessonData=null;

    async function fetchAvailableLessons(){
      try{
        const r=await fetch("https://www.leccion.datafast.pw/lessons/index.json",{cache:"no-store"});
        if(!r.ok) throw new Error("index not found");
        const idx=await r.json();
        const list=Array.isArray(idx.available)?idx.available:[];
        availableLessons=list.map(n=>parseInt(n,10)).filter(n=>!isNaN(n)).sort((a,b)=>a-b); return availableLessons;
      }catch{ availableLessons=[]; return []; }
    }
    async function fetchLessonJSON(num){
      const url=`https://www.leccion.datafast.pw/lessons/lesson${num}.json`;
      const res=await fetch(url,{cache:"no-store"});
      if(!res.ok) return {ok:false, error:"not-found"};
      const data=await res.json();
      const buf=[]; if(data.title) buf.push(data.title); if(data.theory) buf.push(data.theory);
      (data.objectives||[]).forEach(x=>buf.push(x)); (data.topics||[]).forEach(x=>buf.push(x));
      (data.content||[]).forEach(c=>{ if(c.question) buf.push(c.question); if(c.answer) buf.push(c.answer); });
      if(EN_ONLY && looksSpanish(buf.join(" "))) return {ok:false, error:"spanish"};
      return {ok:true, data};
    }

    /* ================= Quiz Gate ================= */
    const QUIZ_MIN=5, QUIZ_MAX=10, QUIZ_PASS=0.90;

    function normalize(s){
      return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();
    }
    function splitVariants(ans){ return ans.split(/\/| or | \| /i).map(a=>normalize(a)); }
    function isAnswerCorrect(user, expected){
      const U=normalize(user); const variants=splitVariants(expected);
      for(const v of variants){
        if(!v) continue;
        if(U.includes(v)) return true;
        const vt=v.split(" "); const uSet=new Set(U.split(" "));
        const hits=vt.filter(t=>uSet.has(t)).length;
        if(vt.length>=3 && hits/vt.length>=0.8) return true;
        if(vt.length<=2 && hits===vt.length) return true;
      }
      return false;
    }
    function askNextQuiz(){
      if(quizIndex>=quizQuestions.length){
        const total=quizQuestions.length; const score=Math.round((quizCorrect/total)*100);
        const passed=score>=Math.ceil(QUIZ_PASS*100);
        addMessage(`Quiz finished. Score: <b>${quizCorrect}/${total}</b> = <b>${score}%</b>.`,"bot");
        if(passed){
          addMessage("‚úÖ Passed. Access granted to the selected lesson. Opening now‚Ä¶","bot");
          speakSafe("You passed. Opening the lesson.","en-US");
          lessonData=pendingLessonData; currentLesson=pendingLessonNum; localStorage.setItem("lastLesson", String(currentLesson));
          const intro=`
            <b>Welcome to Lesson ${currentLesson}: ${lessonData.title}</b><br><br>
            <b>Theory:</b> ${lessonData.theory || "This lesson will guide you through the basics."}<br><br>
            <b>Objectives:</b><br>- ${lessonData.objectives.join("<br>- ")}<br><br>
            <b>Topics:</b><br>- ${lessonData.topics.join("<br>- ")}<br><br>
            Ask me anything about this lesson and I will explain, correct, and reinforce.
          `;
          addMessage(intro,"bot");
          quizActive=false; quizQuestions=[]; quizIndex=0; quizCorrect=0;
          input.disabled=false; sendBtn.disabled=false; speakBtn.disabled=false;
        }else{
          addMessage("‚ùå You did not reach 90%. Please review the previous lesson carefully before advancing. Your session has ended. Thank you.","bot");
          speakSafe("You did not reach ninety percent. Please review the previous lesson. This session has ended.","en-US");
          quizActive=false; sessionLocked=true; input.disabled=true; sendBtn.disabled=true; speakBtn.disabled=true;
        }
        return;
      }
      const q=quizQuestions[quizIndex].q;
      addMessage(`(${quizIndex+1}/${quizQuestions.length}) <b>${q}</b>`,"bot");
      speakSafe(q,"en-US");
    }
    async function startQuizGate(targetNum, targetData){
      if(targetNum===1){
        // Sin quiz para L1
        sessionLocked=false; input.disabled=false; sendBtn.disabled=false; speakBtn.disabled=false;
        lessonData=targetData; currentLesson=1; localStorage.setItem("lastLesson","1");
        const intro=`
          <b>Welcome to Lesson 1: ${lessonData.title}</b><br><br>
          <b>Theory:</b> ${lessonData.theory || "This lesson will guide you through the basics."}<br><br>
          <b>Objectives:</b><br>- ${lessonData.objectives.join("<br>- ")}<br><br>
          <b>Topics:</b><br>- ${lessonData.topics.join("<br>- ")}<br><br>
          Ask me anything about this lesson and I will explain, correct, and reinforce.
        `;
        addMessage(intro,"bot"); speakSafe("Lesson one is open.","en-US"); return;
      }
      const prevNum=targetNum-1;
      const prev=await fetchLessonJSON(prevNum);
      if(!prev.ok){
        const msg = prev.error==="spanish"
          ? `We cannot start the quiz because Lesson ${prevNum} appears to be Spanish. Please upload the English-only version.`
          : `We cannot start the quiz because Lesson ${prevNum} is unavailable.`;
        addMessage(msg,"bot"); return;
      }
      const items = Array.isArray(prev.data.content) ? prev.data.content.filter(c=>c && c.question && c.answer) : [];
      if(items.length<QUIZ_MIN){
        addMessage(`The previous lesson (${prevNum}) does not have enough questions to build a quiz (found ${items.length}). Please complete that lesson's content first.`,"bot");
        return;
      }
      const shuffled=[...items].sort(()=>Math.random()-0.5);
      const count=Math.min(QUIZ_MAX, Math.max(QUIZ_MIN, shuffled.length));
      quizQuestions = shuffled.slice(0,count).map(c=>({ q:c.question, a:c.answer }));
      quizActive=true; quizIndex=0; quizCorrect=0; pendingLessonNum=targetNum; pendingLessonData=targetData;
      sessionLocked=false; input.disabled=false; sendBtn.disabled=false; speakBtn.disabled=false;
      addMessage(`To access <b>Lesson ${targetNum}: ${targetData.title}</b>, please answer these questions from <b>Lesson ${prevNum}</b>. You must score <b>‚â• 90%</b>.`,"bot");
      askNextQuiz();
    }
    async function beginLessonSelection(n){
      const target=await fetchLessonJSON(n);
      if(!target.ok){
        const msg = target.error==="spanish"
          ? `Lesson ${n} contains Spanish text. Please upload the English-only version.`
          : `Could not load Lesson ${n}.`;
        addMessage(msg,"bot"); return;
      }
      addMessage(`Lesson ${n} selected: <b>${target.data.title}</b>.`,"bot");
      if(n>1){ addMessage(`Before we begin, I will ask you some questions from <b>Lesson ${n-1}</b> to verify mastery.`, "bot"); }
      await startQuizGate(n, target.data);
    }

    /* ================= Teacher (JSON-first; Groq fallback EN-only) ================= */
    async function teacherResponse(userText){
      if(looksSpanish(userText)){
        const msg="Please write in English. English-only mode is active.";
        addMessage(msg,"bot"); speakSafe(msg,"en-US"); return;
      }
      const q=userText.toLowerCase(); let local="";
      if(lessonData){
        if(/objective|goal/.test(q)){ local="Objectives:\n- "+lessonData.objectives.join("\n- "); }
        else if(/topic|point|content list/.test(q)){ local="Topics:\n- "+lessonData.topics.join("\n- "); }
        else if(/example|exercise|question/.test(q) && Array.isArray(lessonData.content) && lessonData.content.length){
          const qs=lessonData.content.map(c=>"‚Ä¢ "+c.question).join("\n"); local="Sample questions:\n"+qs;
        }
      }
      if(local){ addMessage(local.replace(/\n/g,"<br>"),"bot"); speakSafe("Here you are.","en-US"); return; }

      const offTopic=["soccer","football","cooking","politics","history","chemistry","physics"];
      if(offTopic.some(k=>q.includes(k))){ const msg="Let's stay focused. We are practicing the current lesson topic."; addMessage(msg,"bot"); speakSafe(msg,"en-US"); return; }

      let answer="";
      try{
        const response=await fetch("https://bot-maestro-proxy.kast-mercadeo.workers.dev/",{
          method:"POST", headers:{"Content-Type":"application/json"},
          body:JSON.stringify({ text:`ROLE: You are an English teacher at St. Mary's College.
HARD RULES: Always respond STRICTLY in English. Never use Spanish. If the student writes in Spanish, reply in English and ask them to switch to English.
CONTEXT: Current lesson = ${lessonData ? lessonData.title : "current lesson (JSON)"}.
TASKS:
1) If the student's sentence has grammar or pronunciation issues, first show a corrected version.
2) Then answer clearly with 2‚Äì3 short examples.
3) Stay strictly on the current lesson theme.
4) Encourage politely and, if relevant, suggest a short practice line to repeat.

Student says: "${userText}"`})
        });
        const data=await response.json(); answer=data.reply||"(no reply)";
      }catch{
        const alternatives=[
          "We say 'Good morning' until noon. 'Good night' is a farewell, not a greeting.",
          "Formal greetings show respect, like 'Good morning'. Informal ones include 'Hi' or 'Hey'.",
          "Use 'There is' for singular and 'There are' for plural; questions: 'Is there‚Ä¶?' / 'Are there‚Ä¶?'."
        ];
        answer=alternatives[Math.floor(Math.random()*alternatives.length)];
      }
      if(looksSpanish(answer)){ answer="(Blocked non-English output). Please keep the conversation in English."; }
      addMessage(answer.replace(/\n/g,"<br>"),"bot"); speakSafe(answer,"en-US");
    }

    /* ================= Input handling (incluye Quiz) ================= */
    async function handleUserMessage(text){
      if(!text) return;
      addMessage(text,"user");
      if(sessionLocked){ addMessage("This session has ended. Please review the previous lesson and start again.","bot"); return; }

      if(quizActive){
        const expected=quizQuestions[quizIndex].a;
        if(isAnswerCorrect(text, expected)){ quizCorrect++; addMessage("‚úÖ Correct.","bot"); }
        else{ addMessage(`‚ùå Incorrect. Expected: <b>${expected}</b>`, "bot"); }
        quizIndex++; askNextQuiz(); return;
      }

      const n=parseLessonNumberFromText(text);
      if(n){ await beginLessonSelection(n); return; }

      if(lessonData){ await teacherResponse(text); }
      else { addMessage(`Welcome! Please choose a lesson first (e.g., <span class="kbd">Lesson 1</span>).`, "bot"); }
    }

    function sendMessage(){ const text=input.value.trim(); input.value=""; handleUserMessage(text); }
    sendBtn.onclick=sendMessage;
    input.addEventListener("keydown", e=>{ if(e.key==="Enter") sendMessage(); });

    /* ================= Speech Recognition ================= */
    let recognition;
    if("webkitSpeechRecognition" in window){
      recognition=new webkitSpeechRecognition();
      recognition.lang="en-US"; recognition.interimResults=false; recognition.maxAlternatives=1;
      recognition.onresult=e=>{ const t=e.results[0][0].transcript; handleUserMessage(t); };
    }
    speakBtn.onclick=()=> recognition && recognition.start();
    stopBtn.onclick=stopAll;

    /* ================= Overlay Lecciones (paginado) ================= */
    const lessonsOverlay=document.getElementById("lessonsOverlay");
    const openLessonsBtn=document.getElementById("openLessonsBtn");
    const closeLessonsBtn=document.getElementById("closeLessonsBtn");
    const numInput=document.getElementById("numInput");
    const wordsInput=document.getElementById("wordsInput");
    const goBtn=document.getElementById("goBtn");
    const rangeNote=document.getElementById("rangeNote");
    const pager=document.getElementById("pager");
    const grid=document.getElementById("grid");

    const PAGE_SIZE=30; let pages=[], currentPage=0;
    function makePages(list){ const out=[]; for(let i=0;i<list.length;i+=PAGE_SIZE) out.push(list.slice(i,i+PAGE_SIZE)); return out; }
    function renderPager(){
      pager.innerHTML=""; if(pages.length<=1) return;
      pages.forEach((_,i)=>{ const start=pages[i][0], end=pages[i][pages[i].length-1];
        const b=document.createElement("button"); b.className="page-btn"+(i===currentPage?" active":"");
        b.textContent=`${start}‚Äì${end}`; b.onclick=()=>{ currentPage=i; renderGrid(); renderPager(); }; pager.appendChild(b);
      });
    }
    function renderGrid(){
      grid.innerHTML=""; if(!pages.length){ grid.innerHTML="<div class='note'>No lessons found. Create /lessons/index.json</div>"; return; }
      pages[currentPage].forEach(n=>{
        const c=document.createElement("div"); c.className="chip"; c.textContent=`Lesson ${n}`; c.onclick=()=> beginLessonSelection(n); grid.appendChild(c);
      });
    }
    async function prepareLessonsOverlay(){
      await fetchAvailableLessons();
      const list=availableLessons.length?availableLessons:Array.from({length:270},(_,i)=>i+1);
      pages=makePages(list); currentPage=0; renderPager(); renderGrid();
      if(availableLessons.length){
        const min=availableLessons[0], max=availableLessons[availableLessons.length-1];
        rangeNote.textContent=`Available range: Lesson ${min} to Lesson ${max} (${availableLessons.length} lessons).`;
      }else{
        rangeNote.textContent=`No index found. Showing 1‚Äì270 (full range). Create /lessons/index.json to control availability.`;
      }
    }
    function openLessonsOverlay(){ lessonsOverlay.style.display="flex"; numInput.focus(); }
    function closeLessonsOverlay(){ lessonsOverlay.style.display="none"; numInput.value=""; wordsInput.value=""; }
    function goFromOverlay(){
      let n=parseInt(numInput.value,10);
      if(!n && wordsInput.value.trim()){ const w=wordsToNumber(wordsInput.value.trim()); if(w) n=w; }
      if(!n || n<1 || n>270){ addSystem("Please type a valid lesson number (1‚Äì270)."); return; }
      beginLessonSelection(n);
    }
    openLessonsBtn.onclick=()=>{ prepareLessonsOverlay().then(openLessonsOverlay); };
    closeLessonsBtn.onclick=closeLessonsOverlay;
    goBtn.onclick=goFromOverlay;
    numInput.addEventListener("keydown", e=>{ if(e.key==="Enter") goFromOverlay(); });
    wordsInput.addEventListener("keydown", e=>{ if(e.key==="Enter") goFromOverlay(); });
    lessonsOverlay.addEventListener("click", e=>{ if(e.target===lessonsOverlay) closeLessonsOverlay(); });

    /* ================= Boot (saludo) ================= */
    (async function init(){
      // asegurar entrada activa
      sessionLocked=false; input.disabled=false; sendBtn.disabled=false; speakBtn.disabled=false;

      await fetchAvailableLessons();
      const last=parseInt(localStorage.getItem("lastLesson")||"0",10);
      if(availableLessons.length){
        const min=availableLessons[0], max=availableLessons[availableLessons.length-1];
        addMessage(`Welcome! Tell me which lesson you want to review (e.g., <span class="kbd">Lesson 1</span>). Available range now: Lesson ${min} to Lesson ${max}.`,"bot");
      }else{
        addMessage(`Welcome! Tell me which lesson you want to review (e.g., <span class="kbd">Lesson 1</span>). Tip: create <span class="kbd">/lessons/index.json</span> to control availability.`,"bot");
      }
      if(last && (!availableLessons.length || availableLessons.includes(last))){
        addSystem(`Last time you studied Lesson ${last}. Type <Lesson ${last}> or tap ‚Äúüìö Lessons‚Äù.`);
      }
    })();
  </script>
</body>
</html>
