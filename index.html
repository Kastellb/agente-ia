<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>St. Mary‚Äôs College ‚Äì English Leveling Bot (v1.9.2)</title>
  <style>
    :root{
      --bg:#f5f7fa; --ink:#0f172a; --bot:#0ea5e9; --user:#22c55e; --card:#ffffff; --muted:#64748b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--ink);
      display:flex; flex-direction:column; min-height:100vh;
    }
    header{
      background:#0b3b71; color:#fff; padding:12px 16px; text-align:center; font-weight:700;
    }
    #chat{ flex:1; max-width:900px; width:100%; margin:16px auto; padding:0 12px; }
    .bubble{
      max-width:75%; padding:12px 14px; margin:8px 0; border-radius:14px; line-height:1.45;
      box-shadow:0 4px 12px rgba(2,8,23,.08);
    }
    .bot{ background:var(--bot); color:#fff; border-bottom-left-radius:4px; }
    .user{ background:var(--user); color:#fff; margin-left:auto; border-bottom-right-radius:4px; }
    .sys{ background:#e2e8f0; color:#0f172a; margin:16px auto; border-radius:10px; }
    .muted{ color:var(--muted); font-size:14px; }
    #controls{
      display:flex; gap:8px; padding:12px; background:#fff; border-top:1px solid #e2e8f0;
      position:sticky; bottom:0;
    }
    #controls > *{ border-radius:10px; }
    #textInput{
      flex:1; padding:12px 14px; font-size:16px; border:1px solid #cbd5e1;
    }
    button{
      border:0; padding:12px 14px; font-weight:600; cursor:pointer;
      box-shadow:0 2px 6px rgba(2,8,23,.08);
    }
    #sendBtn{ background:#22c55e; color:#fff; }
    #speakBtn{ background:#0ea5e9; color:#fff; }
    #stopBtn{ background:#ef4444; color:#fff; }
    a.link{ color:#0ea5e9; text-decoration:none; }
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#e2e8f0; padding:1px 6px; border-radius:6px;}
  </style>
</head>
<body>
  <header>St. Mary‚Äôs College ‚Äì English Leveling Bot (v1.9.2)</header>

  <main id="chat"></main>

  <div id="controls">
    <input id="textInput" type="text" placeholder="Type or say your message‚Ä¶ e.g., ‚ÄúLesson 1‚Äù or a question about the lesson" autocomplete="off"/>
    <button id="sendBtn">Send</button>
    <button id="speakBtn">üé§ Speak</button>
    <button id="stopBtn">‚èπ Stop</button>
  </div>

  <script>
    // =============================
    // UI helpers
    // =============================
    const chat = document.getElementById("chat");
    const input = document.getElementById("textInput");
    const sendBtn = document.getElementById("sendBtn");
    const speakBtn = document.getElementById("speakBtn");
    const stopBtn  = document.getElementById("stopBtn");

    function addMessage(html, role="bot"){
      const b = document.createElement("div");
      b.className = `bubble ${role}`;
      b.innerHTML = html;
      chat.appendChild(b);
      chat.scrollTop = chat.scrollHeight;
    }

    function addSystem(text){
      const b = document.createElement("div");
      b.className = "bubble sys";
      b.innerText = text;
      chat.appendChild(b);
      chat.scrollTop = chat.scrollHeight;
    }

    // =============================
    // Speech Synthesis (TTS)
    // =============================
    function speak(text, lang="en-US"){
      try {
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = lang;
        speechSynthesis.speak(u);
      } catch {}
    }

    // =============================
    // Lesson number parser (1..270) from digits or words
    // =============================
    function wordsToNumber(phrase) {
      const ones = {zero:0, one:1, two:2, three:3, four:4, five:5, six:6, seven:7, eight:8, nine:9};
      const teens = {ten:10, eleven:11, twelve:12, thirteen:13, fourteen:14, fifteen:15, sixteen:16, seventeen:17, eighteen:18, nineteen:19};
      const tens = {twenty:20, thirty:30, forty:40, fifty:50, sixty:60, seventy:70, eighty:80, ninety:90};

      let s = phrase.toLowerCase().replace(/-/g,' ').replace(/[^a-z\s]/g,' ').replace(/\s+/g,' ').trim();
      if(!s) return null;

      if(ones[s]!==undefined) return ones[s];
      if(teens[s]!==undefined) return teens[s];
      if(tens[s]!==undefined) return tens[s];

      const tokens = s.split(' ');
      let total = 0, current = 0;

      for(const w of tokens){
        if(ones[w]!==undefined){ current += ones[w]; continue; }
        if(teens[w]!==undefined){ current += teens[w]; continue; }
        if(tens[w]!==undefined){ current += tens[w]; continue; }
        if(w==="hundred"){ if(current===0) current=1; current*=100; total+=current; current=0; continue; }
        if(w==="and"){ continue; }
        return null; // unknown word
      }
      total += current;
      return total || null;
    }

    function parseLessonNumberFromText(text){
      const s = text.toLowerCase();

      // digits: "lesson 123"
      const mDigits = s.match(/lesson\s+(\d{1,3})\b/);
      if(mDigits){
        const n = parseInt(mDigits[1],10);
        if(n>=1 && n<=270) return n;
      }
      // words: "lesson twenty one", "lesson two hundred fifteen"
      const mWords = s.match(/lesson\s+([a-z][a-z\s-]{1,60})$/i) || s.match(/lesson\s+([a-z][a-z\s-]{1,60})\b/i);
      if(mWords){
        const n = wordsToNumber(mWords[1]);
        if(n && n>=1 && n<=270) return n;
      }
      return null;
    }

    // =============================
    // State
    // =============================
    let currentLesson = null;
    let lessonData = null;

    // =============================
    // Lessons index helper
    // =============================
    async function fetchAvailableLessons(){
      try{
        const r = await fetch("https://www.leccion.datafast.pw/lessons/index.json",{cache:"no-store"});
        if(!r.ok) throw new Error("index not found");
        const idx = await r.json();
        const list = Array.isArray(idx.available) ? idx.available : [];
        return list;
      }catch{ return []; }
    }

    function formatLessonList(list, max=30){
      if(!list.length) return "(no index.json or empty)";
      const compact = list.slice(0, max).join(", ") + (list.length>max ? "‚Ä¶" : "");
      return compact;
    }

    // =============================
    // Load lesson
    // =============================
    async function loadLesson(num){
      try{
        const url = `https://www.leccion.datafast.pw/lessons/lesson${num}.json`;
        const res = await fetch(url, {cache:"no-store"});
        if(!res.ok) throw new Error("Lesson not found");
        lessonData = await res.json();
        currentLesson = num;
        localStorage.setItem("lastLesson", String(num));

        const intro = `
          <b>Welcome to Lesson ${num}: ${lessonData.title}</b><br><br>
          <b>Theory:</b> ${lessonData.theory || "This lesson will guide you through the basics."}<br><br>
          <b>Objectives:</b><br>- ${lessonData.objectives.join("<br>- ")}<br><br>
          <b>Topics:</b><br>- ${lessonData.topics.join("<br>- ")}<br><br>
          Ask me anything about this lesson and I will explain, correct, and reinforce.
        `;
        addMessage(intro, "bot");
        speak(`Welcome to Lesson ${num}: ${lessonData.title}. You can now ask me questions about this lesson.`, "en-US");
      }catch(e){
        addMessage(`Could not load Lesson ${num}. It may not be uploaded yet.`, "bot");
        const avail = await fetchAvailableLessons();
        if(avail.length){
          addMessage(`Available lessons now: ${formatLessonList(avail)}<br><span class="muted">Upload more at /lessons and update index.json when ready.</span>`, "bot");
        }else{
          addMessage(`No index was found at <span class="kbd">lessons/index.json</span>. Consider creating it like <span class="kbd">{"available":[1,2,3]}</span>.`, "bot");
        }
      }
    }

    // =============================
    // Teacher response (JSON-first; Groq fallback)
    // =============================
    async function teacherResponse(userText){
      const q = userText.toLowerCase();
      let local = "";

      if(lessonData){
        if(/objective|goal/.test(q)){
          local = "Objectives:\n- " + lessonData.objectives.join("\n- ");
        }else if(/topic|point|content list/.test(q)){
          local = "Topics:\n- " + lessonData.topics.join("\n- ");
        }else if(/example|exercise|question/.test(q) && Array.isArray(lessonData.content) && lessonData.content.length){
          const qs = lessonData.content.map(c => "‚Ä¢ " + c.question).join("\n");
          local = "Sample questions:\n" + qs;
        }
      }

      if(local){
        addMessage(local.replace(/\n/g,"<br>"), "bot");
        speak("Here you are.", "en-US");
        return;
      }

      // Off-topic hard block (very general)
      const offTopic = ["soccer","football","cooking","politics","history","chemistry","physics"];
      if(offTopic.some(k => q.includes(k))){
        const msg = "Let's stay focused. We are practicing the current lesson topic.";
        addMessage(msg, "bot");
        speak(msg, "en-US");
        return;
      }

      // Groq fallback via Worker ‚Üí Apps Script
      let answer = "";
      try{
        const response = await fetch("https://bot-maestro-proxy.kast-mercadeo.workers.dev/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            text: `You are an English teacher at St. Mary's College.
The student asked: "${userText}".
1) If the student's sentence has grammar errors, first show a corrected version.
2) Then answer clearly in English with 2-3 short examples.
3) Stay strictly on the current lesson theme: ${lessonData ? lessonData.title : "current lesson"}.
4) Encourage politely and, if relevant, suggest a short practice line to repeat.`
          })
        });
        const data = await response.json();
        answer = data.reply || "(no reply)";
      }catch{
        const alternatives = [
          "We say 'Good morning' until noon. 'Good night' is a farewell, not a greeting.",
          "Formal greetings show respect, like 'Good morning'. Informal ones include 'Hi' or 'Hey'.",
          "Use 'There is' for singular and 'There are' for plural; questions: 'Is there‚Ä¶?' / 'Are there‚Ä¶?'."
        ];
        answer = alternatives[Math.floor(Math.random()*alternatives.length)];
      }

      addMessage(answer.replace(/\n/g,"<br>"), "bot");
      speak(answer, "en-US");
    }

    // =============================
    // Send / input handling
    // =============================
    async function handleUserMessage(text){
      if(!text) return;
      addMessage(text, "user");

      // Quick command: list available lessons
      if(/^available lessons?$/i.test(text.trim())){
        const avail = await fetchAvailableLessons();
        if(avail.length){
          addMessage(`Available lessons: ${formatLessonList(avail, 60)}`, "bot");
        }else{
          addMessage(`No index found. Create <span class="kbd">lessons/index.json</span> like {"available":[1,2,3]}.`, "bot");
        }
        return;
      }

      // Parse lesson from text
      const n = parseLessonNumberFromText(text);
      if(n){
        await loadLesson(n);
        return;
      }

      // If lesson loaded ‚Üí teacher mode
      if(lessonData){
        await teacherResponse(text);
      }else{
        addMessage(`Please choose a lesson first (e.g., ‚ÄúLesson 1‚Äù or ‚ÄúLesson twenty one‚Äù).`, "bot");
      }
    }

    function sendMessage(){
      const text = input.value.trim();
      input.value = "";
      handleUserMessage(text);
    }

    sendBtn.onclick = sendMessage;
    input.addEventListener("keydown", e => {
      if(e.key === "Enter") sendMessage();
    });

    // =============================
    // Speech Recognition (STT)
    // =============================
    let recognition;
    if("webkitSpeechRecognition" in window){
      recognition = new webkitSpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onresult = e => {
        const transcript = e.results[0][0].transcript;
        handleUserMessage(transcript);
      };
      recognition.onerror = () => {};
    }

    speakBtn.onclick = () => recognition && recognition.start();
    stopBtn.onclick  = () => { if(recognition) recognition.stop(); speechSynthesis.cancel(); };

    // =============================
    // Boot
    // =============================
    (function init(){
      addMessage(`Welcome! Tell me which lesson you want to review (e.g., <span class="kbd">Lesson 1</span> or <span class="kbd">Lesson twenty three</span>). Then ask anything about that lesson ‚Äî I will explain, correct, and reinforce.`, "bot");

      const last = parseInt(localStorage.getItem("lastLesson") || "0", 10);
      if(last && last>=1 && last<=270){
        addSystem(`Last time you studied Lesson ${last}. Type <Lesson ${last}> to continue or pick another lesson.`);
      }
    })();
  </script>
</body>
</html>
