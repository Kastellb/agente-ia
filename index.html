<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bot Maestro ‚Äì English Instructor</title>
  <style>
    body { font-family: Arial, sans-serif; background: #1e3c72; margin:0; display:flex; flex-direction:column; height:100vh; }
    header { text-align:center; color:white; padding:10px; font-size:18px; background:#0d2b57; }
    #chat { flex:1; background:#f9f9f9; padding:10px; overflow-y:auto; display:flex; flex-direction:column; }
    .bubble { padding:10px; margin:5px; border-radius:10px; max-width:75%; line-height:1.4; }
    .user { background:#4CAF50; color:#fff; align-self:flex-end; }
    .bot { background:#2196F3; color:#fff; align-self:flex-start; white-space:pre-line; }
    #controls { display:flex; background:#fff; padding:10px; }
    #textInput { flex:1; padding:10px; border:1px solid #ccc; border-radius:5px; }
    button { margin-left:5px; padding:10px; border:none; border-radius:5px; cursor:pointer; }
    #sendBtn { background:#4CAF50; color:white; }
    #talkBtn { background:#2196F3; color:white; }
    #stopBtn { background:#f44336; color:white; }
    @media (max-width:600px) {
      header { font-size:16px; }
      #textInput { font-size:14px; }
      button { padding:8px; font-size:14px; }
    }
  </style>
</head>
<body>
  <header>ü§ñ Bot Maestro ‚Äì English Instructor</header>
  <div id="chat"></div>
  <div id="controls">
    <input type="text" id="textInput" placeholder="Type your message...">
    <button id="sendBtn">Send</button>
    <button id="talkBtn">Speak</button>
    <button id="stopBtn">Stop</button>
  </div>

  <script>
    const WORKER_URL = "https://bot-maestro-proxy.kast-mercadeo.workers.dev/"; 
    const chat = document.getElementById("chat");
    const textInput = document.getElementById("textInput");
    const synth = window.speechSynthesis;
    let currentLesson = null;

    // üéì Welcome message
    window.onload = () => {
      addMessage("üëã Welcome to St. Mary‚Äôs College! I am your English instructor. Please tell me which lesson you want to review (e.g., 'Lesson 1').", "bot");
      speak("Welcome to St. Mary‚Äôs College! I am your English instructor. Please tell me which lesson you want to review, for example Lesson 1.", "en-US");
    };

    // ‚úÖ Add message to chat
    function addMessage(text, sender) {
      const div = document.createElement("div");
      div.className = `bubble ${sender}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // ‚úÖ Main message handler
    async function sendMessage(text) {
      if (!text) return;
      addMessage(text, "user");
      textInput.value = "";

      // Lesson detection
      if (/lesson\s*\d+/i.test(text)) {
        const lessonNumber = parseInt(text.match(/\d+/)[0]);
        currentLesson = lessonNumber;

        if (lessonNumber === 1) {
          addMessage("üìò Welcome to Lesson 1: Greetings and Introductions.", "bot");
          speak("Welcome to Lesson 1: Greetings and Introductions.", "en-US");
          addMessage("What do you want to review: Vocabulary, Grammar, Exercises, or Pronunciation?", "bot");
          speak("What do you want to review: Vocabulary, Grammar, Exercises, or Pronunciation?", "en-US");
        } else {
          await evaluateLesson(lessonNumber - 1);
        }
        return;
      }

      // Lesson areas
      if (currentLesson && /(vocabulary|grammar|exercises|pronunciation)/i.test(text)) {
        const area = text.toLowerCase();
        await loadLesson(currentLesson, area);
        return;
      }

      // Free questions: only if related
      if (currentLesson) {
        const related = /(vocabulary|grammar|exercise|pronunciation|rule|example|sentence)/i;
        if (related.test(text)) {
          // Related ‚Üí Groq explanation
          try {
            const res = await fetch(WORKER_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ text })
            });
            const data = await res.json();
            let reply = data.reply || "‚ùå No response.";
            reply = cleanResponse(reply);
            addMessage(reply, "bot");
            speak(reply, "en-US");
          } catch {
            addMessage("‚ö†Ô∏è Connection error.", "bot");
          }
        } else {
          // Not related ‚Üí block politely
          addMessage(`üôè Sorry, we are only focusing on Lesson ${currentLesson}. Please ask about Vocabulary, Grammar, Exercises, or Pronunciation.`, "bot");
          speak(`Sorry, we are only focusing on Lesson ${currentLesson}. Please ask about Vocabulary, Grammar, Exercises, or Pronunciation.`, "en-US");
        }
        return;
      }

      // If no lesson yet
      addMessage("Please choose a lesson first (e.g., Lesson 1).", "bot");
      speak("Please choose a lesson first, for example Lesson 1.", "en-US");
    }

    // ‚úÖ Clean Groq responses (remove emojis, symbols)
    function cleanResponse(text) {
      return text
        .replace(/[\u{1F600}-\u{1F6FF}]/gu, "")  // emojis
        .replace(/\*+/g, "")                     // asterisks
        .trim();
    }

    // ‚úÖ Speak function
    function speak(text, lang) {
      synth.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = lang;
      synth.speak(utter);
    }

    // ‚úÖ Speech recognition
    function startListening() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "en-US";
      recognition.start();
      recognition.onresult = (e) => {
        const text = e.results[0][0].transcript;
        sendMessage(text);
      };
      recognition.onerror = () => addMessage("‚ö†Ô∏è Speech not detected.", "bot");
    }

    // ‚úÖ Load lesson JSON by area
    async function loadLesson(lessonNumber, area) {
      try {
        const res = await fetch(`/lessons/lesson${lessonNumber}.json`);
        const lesson = await res.json();

        if (area.includes("vocabulary")) {
          addMessage(`üìñ Vocabulary for Lesson ${lessonNumber}:\n${lesson.areas.vocabulary}`, "bot");
          speak("Here is the vocabulary for this lesson.", "en-US");
        } else if (area.includes("grammar")) {
          addMessage(`üìñ Grammar for Lesson ${lessonNumber}:\n${lesson.areas.grammar}`, "bot");
          speak("Here is the grammar explanation.", "en-US");
        } else if (area.includes("exercises")) {
          addMessage("üìù Let's practice! Answer these exercises:", "bot");
          lesson.areas.exercises.forEach(ex => {
            addMessage(ex.q, "bot");
          });
          speak("Let's practice some exercises.", "en-US");
        } else if (area.includes("pronunciation")) {
          addMessage(`üîä Pronunciation tips:\n${lesson.areas.pronunciation}`, "bot");
          speak("Here are the pronunciation tips.", "en-US");
        }
      } catch {
        addMessage("‚ö†Ô∏è Lesson not found.", "bot");
      }
    }

    // ‚úÖ Evaluate previous lesson
    async function evaluateLesson(prevLesson) {
      if (prevLesson <= 0) {
        addMessage("This is the first lesson, no previous evaluation required.", "bot");
        speak("This is the first lesson, no previous evaluation required.", "en-US");
        return;
      }

      try {
        const res = await fetch(`/lessons/lesson${prevLesson}.json`);
        const lesson = await res.json();

        const ex = lesson.areas.exercises[Math.floor(Math.random() * lesson.areas.exercises.length)];
        addMessage(`Before Lesson ${currentLesson}, answer from Lesson ${prevLesson}:\n${ex.q}`, "bot");
        speak("Before moving to the next lesson, answer this question from the previous one.", "en-US");
      } catch {
        addMessage("‚ö†Ô∏è Could not load previous lesson.", "bot");
      }
    }

    // ‚úÖ Buttons
    document.getElementById("sendBtn").onclick = () => sendMessage(textInput.value);
    document.getElementById("talkBtn").onclick = () => startListening();
    document.getElementById("stopBtn").onclick = () => synth.cancel();
  </script>
</body>
</html>
