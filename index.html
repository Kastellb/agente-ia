<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>St. Mary‚Äôs College ‚Äî English Leveler v2.5</title>
<style>
:root {
  --brand: #0b3b71;
  --brand-light: #1e4e8d;
  --bg: #eef2f7;
  --bot: #0b88e6;
  --user: #12b886;
  --success: #22c55e;
  --warning: #f59e0b;
  --error: #ef4444;
  --gray-100: #f7f9fc;
  --gray-200: #e2e8f0;
  --gray-300: #cbd5e1;
  --gray-600: #475569;
  --gray-700: #334155;
  --gray-800: #1e293b;
  --shadow-sm: 0 4px 12px rgba(2,6,23,.06);
  --shadow-md: 0 12px 28px rgba(2,6,23,.08);
  --shadow-lg: 0 12px 28px rgba(2,6,23,.12);
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  height: 100%;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color: var(--gray-800);
  background: var(--bg);
}

body {
  display: flex;
  flex-direction: column;
  line-height: 1.5;
}

/* Header Styles */
header {
  background: var(--brand);
  color: white;
  padding: 14px 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  box-shadow: var(--shadow-md);
  position: relative;
  z-index: 10;
}

h1 {
  margin: 0;
  font-size: 18px;
  font-weight: 800;
}

.badge {
  font-size: 13px;
  opacity: 0.85;
  background: rgba(255, 255, 255, 0.15);
  padding: 4px 10px;
  border-radius: 20px;
}

/* Main Content */
main {
  flex: 1;
  display: flex;
  justify-content: center;
  padding: 20px 0;
}

.wrap {
  width: min(1000px, 100%);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* Toolbar */
.toolbar {
  background: white;
  border-radius: var(--radius-md);
  padding: 14px;
  display: flex;
  gap: 14px;
  align-items: center;
  flex-wrap: wrap;
  box-shadow: var(--shadow-md);
  transition: all 0.3s ease;
}

.label {
  font-weight: 700;
  color: var(--gray-700);
  font-size: 14px;
}

select, button, input {
  font-family: inherit;
  font-size: 14px;
  font-weight: 600;
}

#lessonInput {
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--gray-300);
  background: var(--gray-100);
  min-width: 280px;
  transition: all 0.2s ease;
}

#lessonInput:focus {
  outline: none;
  border-color: var(--bot);
  box-shadow: 0 0 0 3px rgba(11, 136, 230, 0.15);
}

.status {
  font-size: 13px;
  color: var(--gray-700);
  background: rgba(11, 59, 113, 0.06);
  border: 1px dashed rgba(11, 59, 113, 0.2);
  padding: 8px 14px;
  border-radius: var(--radius-sm);
  min-height: 38px;
  display: flex;
  align-items: center;
  flex: 1;
  transition: all 0.3s ease;
}

.status.loading {
  color: var(--brand);
  background: rgba(11, 59, 113, 0.1);
}

.status.error {
  color: var(--error);
  background: rgba(239, 68, 68, 0.08);
  border-color: rgba(239, 68, 68, 0.3);
}

.status.success {
  color: var(--success);
  background: rgba(34, 197, 94, 0.08);
  border-color: rgba(34, 197, 94, 0.3);
}

/* Chat Area */
#chat {
  background: white;
  border-radius: var(--radius-lg);
  padding: 16px;
  min-height: 60vh;
  max-height: 60vh;
  overflow: auto;
  box-shadow: var(--shadow-lg);
  display: flex;
  flex-direction: column;
  gap: 12px;
  transition: all 0.3s ease;
}

.msg {
  max-width: min(720px, 92%);
  padding: 12px 16px;
  border-radius: var(--radius-md);
  margin: 4px 0;
  line-height: 1.5;
  white-space: pre-wrap;
  word-wrap: break-word;
  animation: fadeIn 0.3s ease;
}

.msg.bot {
  background: var(--bot);
  color: white;
  border-bottom-left-radius: 4px;
}

.msg.user {
  background: var(--user);
  color: white;
  border-bottom-right-radius: 4px;
  margin-left: auto;
}

.msg.system {
  background: var(--gray-200);
  color: var(--gray-700);
  font-style: italic;
  font-size: 14px;
  text-align: center;
  margin: 8px auto;
  max-width: 80%;
}

.msg-content {
  margin-bottom: 8px;
}

.msg-controls {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 8px;
}

.msg-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 12px;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: background 0.2s;
}

.msg-btn:hover {
  background: rgba(255, 255, 255, 0.3);
}

.thinking {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--gray-600);
  font-size: 14px;
  padding: 8px 0;
}

.thinking .dot {
  width: 8px;
  height: 8px;
  background: var(--gray-300);
  border-radius: 50%;
  animation: pulse 1.5s infinite ease-in-out;
}

.thinking .dot:nth-child(2) {
  animation-delay: 0.3s;
}

.thinking .dot:nth-child(3) {
  animation-delay: 0.6s;
}

/* Composer */
.composer {
  background: white;
  border-radius: var(--radius-md);
  padding: 14px;
  box-shadow: var(--shadow-md);
  display: flex;
  flex-direction: column;
  gap: 12px;
}

#text {
  width: 100%;
  border: 1px solid var(--gray-300);
  outline: none;
  font-size: 16px;
  padding: 14px;
  border-radius: var(--radius-sm);
  background: var(--gray-100);
  transition: all 0.2s ease;
  resize: vertical;
  min-height: 50px;
  max-height: 150px;
}

#text:focus {
  border-color: var(--bot);
  box-shadow: 0 0 0 3px rgba(11, 136, 230, 0.15);
}

.btnrow {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.btn {
  border: 0;
  border-radius: var(--radius-md);
  padding: 12px 18px;
  font-weight: 700;
  color: white;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

.btn:active {
  transform: translateY(0);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

#send {
  background: var(--success);
}

#mic {
  background: var(--bot);
}

#stop {
  background: var(--error);
}

#loadLesson {
  background: var(--warning);
}

/* Recording indicator */
.recording-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--error);
  font-weight: 600;
  font-size: 14px;
  padding: 8px 12px;
  background: rgba(239, 68, 68, 0.1);
  border-radius: var(--radius-sm);
  margin-top: 8px;
  animation: pulse 2s infinite;
}

.recording-dot {
  width: 10px;
  height: 10px;
  background: var(--error);
  border-radius: 50%;
}

/* Mobile tweaks */
@media (max-width: 768px) {
  header {
    padding: 12px 16px;
  }
  
  h1 {
    font-size: 16px;
  }
  
  .badge {
    font-size: 12px;
    padding: 3px 8px;
  }
  
  .wrap {
    padding: 12px;
  }
  
  .toolbar {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  #lessonInput {
    min-width: 100%;
  }
  
  .status {
    min-height: unset;
    width: 100%;
  }
  
  .msg {
    max-width: 96%;
    padding: 10px 14px;
  }
  
  .btn {
    padding: 10px 14px;
    flex: 1;
    justify-content: center;
  }
  
  .btnrow {
    width: 100%;
  }
}

@media (max-width: 480px) {
  h1 {
    font-size: 15px;
  }
  
  .badge {
    font-size: 11px;
  }
  
  #chat {
    min-height: 55vh;
    max-height: 55vh;
    padding: 12px;
  }
  
  .composer {
    padding: 12px;
  }
  
  #text {
    padding: 12px;
    font-size: 15px;
  }
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

/* Scrollbar styling */
#chat::-webkit-scrollbar {
  width: 8px;
}

#chat::-webkit-scrollbar-track {
  background: var(--gray-200);
  border-radius: 4px;
}

#chat::-webkit-scrollbar-thumb {
  background: var(--gray-300);
  border-radius: 4px;
}

#chat::-webkit-scrollbar-thumb:hover {
  background: var(--gray-400);
}
</style>
</head>
<body>
<header>
  <h1>St. Mary‚Äôs College ‚Äî English Leveler v2.5</h1>
  <span class="badge">Voice + Text ‚Ä¢ EN only ‚Ä¢ JSON-driven (1‚Äì13)</span>
</header>

<main>
  <div class="wrap">

    <div class="toolbar">
      <span class="label">Enter lesson:</span>
      <input type="text" id="lessonInput" placeholder="e.g. 'lesson 1' or 'one'" aria-label="Enter lesson number or name">
      <button id="loadLesson" class="btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2V6M12 18V22M4 12H2M6.31412 6.31412L4.8999 4.8999M17.6858 6.31412L19.1 4.8999M6.31412 17.69L4.8999 19.1042M17.6858 17.69L19.1 19.1042M22 12H20M17 12C17 14.7614 14.7614 17 12 17C9.23858 17 7 14.7614 7 12C7 9.23858 9.23858 7 12 7C14.7614 7 17 9.23858 17 12Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Load Lesson
      </button>
      <span id="status" class="status">Welcome! Please enter a lesson number or name (e.g. 'lesson 1' or 'one')</span>
    </div>

    <div id="chat" aria-live="polite"></div>

    <div class="composer">
      <textarea id="text" placeholder="Type your message and press Enter‚Ä¶" autocomplete="off" rows="1"></textarea>
      <div class="btnrow">
        <button id="send" class="btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Send
        </button>
        <button id="mic" class="btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 1C10.9391 1 9.92172 1.42143 9.17157 2.17157C8.42143 2.92172 8 3.93913 8 5V11C8 12.0609 8.42143 13.0783 9.17157 13.8284C9.92172 14.5786 10.9391 15 12 15C13.0609 15 14.0783 14.5786 14.8284 13.8284C15.5786 13.0783 16 12.0609 16 11V5C16 3.93913 15.5786 2.92172 14.8284 2.17157C14.0783 1.42143 13.0609 1 12 1Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19 10V11C19 13.9174 17.5362 16.5223 15.2426 18.2426C12.949 19.963 9.94904 20.4467 7.17158 19.5711C4.39412 18.6955 2.1532 16.5675 1.22183 13.8338C0.290455 11.1002 0.774135 8.00893 2.51472 5.60571C4.2553 3.20249 7.03848 1.75 10 1.75" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 19V23" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 23H16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Speak
        </button>
        <button id="stop" class="btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="6" y="6" width="12" height="12" rx="1" stroke="white" stroke-width="2"/>
            <path d="M10 10H14V14H10V10Z" fill="white"/>
          </svg>
          Stop
        </button>
      </div>
    </div>

  </div>
</main>

<script>
/* ===== CONFIG ===== */
const WORKER_URL = "https://bot-maestro-proxy.kast-mercadeo.workers.dev/"; // tu Worker
const JSON_BASE  = "https://www.leccion.datafast.pw/lessons/";             // carpeta de JSON
const JSON_COUNT = 13;                                                      // tenemos 13 JSON

/* ===== Estado ===== */
const chat   = document.getElementById('chat');
const input  = document.getElementById('text');
const send   = document.getElementById('send');
const mic    = document.getElementById('mic');
const stopBtn= document.getElementById('stop');
const lessonInput = document.getElementById('lessonInput');
const loadLessonBtn = document.getElementById('loadLesson');
const statusEl  = document.getElementById('status');

let currentLesson = 1;
let lessonData = null;       // JSON de la lecci√≥n actual
let prevLessonData = null;   // JSON de la lecci√≥n anterior (para quiz)
let isThinking = false;      // Para mostrar indicador de pensamiento
let isRecording = false;     // Para controlar estado de grabaci√≥n

// Mapa de n√∫meros en texto a n√∫meros
const numberWords = {
  'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5,
  'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'ten': 10,
  'eleven': 11, 'twelve': 12, 'thirteen': 13, 'fourteen': 14, 'fifteen': 15,
  'sixteen': 16, 'seventeen': 17, 'eighteen': 18, 'nineteen': 19, 'twenty': 20
};

/* ===== Utilidades visuales y TTS ===== */
function addMsg(text, who="bot", isSystem=false){
  const clean = cleanDisplay(String(text||''));
  const d = document.createElement('div');
  d.className = `msg ${isSystem ? 'system' : who}`;
  
  const contentDiv = document.createElement('div');
  contentDiv.className = 'msg-content';
  contentDiv.textContent = clean;
  d.appendChild(contentDiv);
  
  // A√±adir controles de voz
  const controlsDiv = document.createElement('div');
  controlsDiv.className = 'msg-controls';
  
  const speakBtn = document.createElement('button');
  speakBtn.className = 'msg-btn';
  speakBtn.innerHTML = `
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 4L12 12M12 12L9.5 9.5M12 12L14.5 9.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M3.5 11.5C3.5 9.51088 4.29018 7.60322 5.6967 6.1967C7.10322 4.79018 9.01088 4 11 4C12.9891 4 14.8968 4.79018 16.3033 6.1967C17.7098 7.60322 18.5 9.51088 18.5 11.5C18.5 13.4891 17.7098 15.3968 16.3033 16.8033C14.8968 18.2098 12.9891 19 11 19C9.01088 19 7.10322 18.2098 5.6967 16.8033C4.29018 15.3968 3.5 13.4891 3.5 11.5Z" stroke="white" stroke-width="2"/>
      <path d="M19.5 7.5C20.4192 8.85817 20.9297 10.4585 20.9297 12.125C20.9297 13.7915 20.4192 15.3918 19.5 16.75" stroke="white" stroke-width="2" stroke-linecap="round"/>
      <path d="M21.5 5C22.886 6.81329 23.6596 9.03089 23.6596 11.375C23.6596 13.7191 22.886 15.9367 21.5 17.75" stroke="white" stroke-width="2" stroke-linecap="round"/>
    </svg>
    Speak
  `;
  speakBtn.addEventListener('click', () => speak(clean));
  
  const stopBtn = document.createElement('button');
  stopBtn.className = 'msg-btn';
  stopBtn.innerHTML = `
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="6" y="6" width="12" height="12" rx="1" stroke="white" stroke-width="2"/>
      <path d="M10 10H14V14H10V10Z" fill="white"/>
    </svg>
    Stop
  `;
  stopBtn.addEventListener('click', () => stopSpeech());
  
  controlsDiv.appendChild(speakBtn);
  controlsDiv.appendChild(stopBtn);
  d.appendChild(controlsDiv);
  
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

function showThinking() {
  if (isThinking) return;
  isThinking = true;
  
  const thinkingEl = document.createElement('div');
  thinkingEl.className = 'thinking';
  thinkingEl.id = 'thinking-indicator';
  thinkingEl.innerHTML = `
    Thinking 
    <span class="dot"></span>
    <span class="dot"></span>
    <span class="dot"></span>
  `;
  
  chat.appendChild(thinkingEl);
  chat.scrollTop = chat.scrollHeight;
}

function hideThinking() {
  isThinking = false;
  const thinkingEl = document.getElementById('thinking-indicator');
  if (thinkingEl) {
    thinkingEl.remove();
  }
}

function showRecordingIndicator() {
  if (document.getElementById('recording-indicator')) return;
  
  const indicator = document.createElement('div');
  indicator.className = 'recording-indicator';
  indicator.id = 'recording-indicator';
  indicator.innerHTML = `
    <span class="recording-dot"></span>
    Recording in progress... Click Stop when finished
  `;
  
  const composer = document.querySelector('.composer');
  composer.appendChild(indicator);
}

function hideRecordingIndicator() {
  const indicator = document.getElementById('recording-indicator');
  if (indicator) {
    indicator.remove();
  }
}

function sanitizeSpeak(s){
  return (s||"")
    .replace(/https?:\/\/\S+/g,'')
    .replace(/[`*_~#>\[\]\(\){}|\\]/g,' ')
    .replace(/[‚Ä¢‚ñ™Ô∏é‚óè‚ó¶\-\u2022]\s+/g,' ')
    .replace(/[\u2190-\u21FF]/g,' ')
    .replace(/[\u2460-\u24FF]/g,' ')
    .replace(/[\u2500-\u25FF]/g,' ')
    .replace(/[\u2600-\u27BF]/g,' ')
    .replace(/[\u{1F000}-\u{1FAFF}]/gu,' ')
    .replace(/\s{2,}/g,' ').trim();
}

function cleanDisplay(s){
  return (s||"")
    .replace(/[*_~`#>|]/g,'')
    .replace(/\s{2,}/g,' ')
    .trim();
}

function pickEnglishVoice(){
  const voices = window.speechSynthesis.getVoices() || [];
  const en = voices.find(v => /^en(-|_)/i.test(v.lang)) || voices[0];
  return en || null;
}

function speak(text){
  try{
    const t = sanitizeSpeak(String(text||''));
    if(!t) return;
    const u = new SpeechSynthesisUtterance(t);
    const v = pickEnglishVoice();
    if(v) u.voice = v;
    u.rate = 0.9; // Velocidad ligeramente reducida para mejor comprensi√≥n
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }catch(e){
    console.error("Error with speech synthesis:", e);
  }
}

function stopSpeech() {
  try {
    window.speechSynthesis.cancel();
  } catch(e) {
    console.error("Error stopping speech synthesis:", e);
  }
}

// Inicializar voces
if (window.speechSynthesis) {
  window.speechSynthesis.addEventListener('voiceschanged', () => {});
}

/* ===== STT (ingl√©s) ===== */
let rec = null;

function sttStart(){
  if(isRecording) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ 
    addMsg("Voice recognition is not supported in your browser. Please type your message.", "bot"); 
    return; 
  }
  
  try {
    rec = new SR();
    rec.lang = 'en-US'; 
    rec.continuous = false; 
    rec.interimResults = false;
    
    rec.onresult = (e) => {
      const t = e.results?.[0]?.[0]?.transcript || "";
      if(t){ 
        input.value = t; 
        sendMsg(); 
      }
    };
    
    rec.onstart = () => { 
      isRecording = true;
      mic.disabled = true;
      showRecordingIndicator();
      speak("Listening"); 
    };
    
    rec.onerror = (e) => { 
      console.error("Speech recognition error:", e.error);
      isRecording = false;
      mic.disabled = false;
      hideRecordingIndicator();
      addMsg("Speech recognition error. Please try again or type your message.", "bot");
    };
    
    rec.onend = () => {
      isRecording = false;
      mic.disabled = false;
      hideRecordingIndicator();
    };
    
    rec.start();
  } catch (e) {
    console.error("Error initializing speech recognition:", e);
    addMsg("Error initializing voice recognition. Please check your microphone permissions.", "bot");
  }
}

function stopAll(){ 
  try {
    window.speechSynthesis.cancel();
  } catch(e) {
    console.error("Error stopping speech synthesis:", e);
  }
  
  try {
    if (rec && isRecording) {
      rec.stop();
    }
  } catch(e) {
    console.error("Error stopping recognition:", e);
  }
  
  isRecording = false;
  mic.disabled = false;
  hideRecordingIndicator();
}

/* ===== Procesamiento de entrada de lecci√≥n ===== */
function parseLessonInput(input) {
  // Limpiar y normalizar la entrada
  const cleanInput = input.toLowerCase().trim();
  
  // Si est√° vac√≠o
  if (!cleanInput) return null;
  
  // Verificar si es un n√∫mero directo
  if (/^\d+$/.test(cleanInput)) {
    const num = parseInt(cleanInput, 10);
    return num >= 1 && num <= 270 ? num : null;
  }
  
  // Verificar si es "lesson X" o "lecci√≥n X"
  const lessonMatch = cleanInput.match(/^(lesson|lecci√≥n)\s+(\d+|[a-z]+)$/);
  if (lessonMatch) {
    const lessonValue = lessonMatch[2];
    // Si es un n√∫mero
    if (/^\d+$/.test(lessonValue)) {
      const num = parseInt(lessonValue, 10);
      return num >= 1 && num <= 270 ? num : null;
    }
    // Si es un n√∫mero en palabras
    if (numberWords[lessonValue]) {
      return numberWords[lessonValue];
    }
  }
  
  // Verificar si es solo un n√∫mero en palabras
  if (numberWords[cleanInput]) {
    return numberWords[cleanInput];
  }
  
  // Si no coincide con ning√∫n formato reconocido
  return null;
}

/* ===== Carga de JSON ===== */
async function fetchJSON(url){
  try {
    const r = await fetch(url, { cache: 'no-store' });
    if(!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
    return await r.json();
  } catch (e) {
    console.error(`Error fetching ${url}:`, e);
    throw e;
  }
}

async function loadLesson(n){
  // Validar n√∫mero de lecci√≥n
  if (n < 1 || n > 270) {
    addMsg("Please enter a lesson between 1 and 270.", "bot");
    statusEl.textContent = "Error: Please enter a lesson between 1 and 270.";
    statusEl.className = 'status error';
    return;
  }
  
  currentLesson = n;
  localStorage.setItem('smc.lesson', String(n));
  lessonData = null; 
  prevLessonData = null;
  
  // Actualizar UI
  statusEl.textContent = `Loading Lesson ${n}‚Ä¶`;
  statusEl.className = 'status loading';
  lessonInput.disabled = true;
  loadLessonBtn.disabled = true;
  
  try {
    // Cargar lecci√≥n actual
    if(n <= JSON_COUNT){
      lessonData = await fetchJSON(`${JSON_BASE}lesson${n}.json`);
    }
    
    // Cargar lecci√≥n previa si es necesario
    if(n > 1 && (n-1) <= JSON_COUNT){
      try {
        prevLessonData = await fetchJSON(`${JSON_BASE}lesson${n-1}.json`);
      } catch(e) { 
        // No cr√≠tico si falla
        console.warn(`Could not load previous lesson ${n-1}:`, e);
      }
    }
    
    // L√≠nea de estado
    const titleTxt = lessonData?.title ? `Lesson ${n} ‚Äî ${lessonData.title}` : `Lesson ${n}`;
    statusEl.textContent = (n <= 1)
      ? `${titleTxt}. You can start now. Ask about any concept you want to reinforce.`
      : `${titleTxt}. First, a short review of Lesson ${n-1} (need ‚â• 90% to unlock).`;
    
    statusEl.className = 'status success';
    
    // Presentaci√≥n pedag√≥gica desde el JSON (teor√≠a + objetivos + temas)
    addMsg(`--- Lesson ${n} Loaded ---`, "bot", true);
    
    if(lessonData){
      const t = lessonData.theory ? `Theory ‚Äî ${lessonData.title}\n${lessonData.theory}` : `Lesson ${n}`;
      addMsg(t, "bot");
      
      if(Array.isArray(lessonData.objectives) && lessonData.objectives.length){
        addMsg("Objectives:\n" + lessonData.objectives.map((x,i) => `${i+1}. ${x}`).join('\n'), "bot");
      }
      
      if(Array.isArray(lessonData.topics) && lessonData.topics.length){
        addMsg("Topics:\n" + lessonData.topics.map((x,i) => `${i+1}. ${x}`).join('\n'), "bot");
      }
    } else {
      addMsg(`Lesson ${n} selected. Ask what you would like to reinforce.`, "bot");
    }
    
  } catch(e) {
    console.error("Error loading lesson:", e);
    statusEl.textContent = `Error loading lesson ${n}. Using minimal context.`;
    statusEl.className = 'status error';
    addMsg(`Lesson ${n} data could not be loaded. Proceeding with minimal context.`, "bot");
  } finally {
    lessonInput.disabled = false;
    loadLessonBtn.disabled = false;
  }
}

/* ===== Prompt estricto basado en JSON ===== */
function buildPrompt(userText){
  const n = currentLesson;
  const title = lessonData?.title || `Lesson ${n}`;
  const theory = lessonData?.theory || "";
  const objectives = Array.isArray(lessonData?.objectives) ? lessonData.objectives : [];
  const topics = Array.isArray(lessonData?.topics) ? lessonData.topics : [];

  const prevQuiz = Array.isArray(lessonData?.quizPrevious) && lessonData.quizPrevious.length
    ? lessonData.quizPrevious
    : (Array.isArray(prevLessonData?.quizPrevious) ? prevLessonData.quizPrevious : []);

  const rules =
`ROLE: You are the English leveling instructor for St. Mary's College.
LANGUAGE: Reply in ENGLISH ONLY.
FORMAT: Plain text. No markdown, no asterisks, no emojis, no decorative symbols.
TONE: Clear, concise, encouraging. Natural phrasing. Use minimal IPA or simple syllable hints only when essential.
SCOPE: Strictly about Lesson ${n} ‚Äî ${title}. If the user asks off-topic, provide a SHORT helpful note and redirect to Lesson ${n}.
TEACHING: First, briefly explain the what/why/how based on the lesson JSON; then answer. Correct grammar and suggest natural phrasing.
PRONUNCIATION: Avoid characters that TTS reads awkwardly. No bullets or decorative marks.
QUIZ-GATE: If Lesson ${n} > 1, start with a short 4-question diagnostic of Lesson ${n-1}. Use the provided 'quizPrevious' items if present; otherwise, derive from the previous lesson's theory/topics. Require ‚â• 90% to continue. If below, ask the student to review Lesson ${n-1} and politely end the session.`;

  const jsonContext =
`JSON_TITLE: ${title}
JSON_THEORY: ${theory}
JSON_OBJECTIVES:
${objectives.map((x,i) => `${i+1}. ${x}`).join('\n')}
JSON_TOPICS:
${topics.map((x,i) => `${i+1}. ${x}`).join('\n')}
JSON_QUIZ_PREVIOUS:
${prevQuiz.map((q,i) => `${i+1}. Q: ${q.question} | A: ${q.answer}`).join('\n')}`;

  return `LESSON=${n}\n${rules}\n${jsonContext}\nUSER: ${userText}`;
}

/* ===== Backend ===== */
async function askInstructor(text){
  showThinking();
  send.disabled = true;
  
  try {
    const r = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: buildPrompt(text), lang: "en-US" })
    });
    
    if(!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
    
    const data = await r.json().catch(() => ({ reply: "Connection error." }));
    return String(data.reply || "Sorry, I couldn't process that request.");
    
  } catch(e) {
    console.error("Error asking instructor:", e);
    throw e;
  } finally {
    hideThinking();
    send.disabled = false;
  }
}

/* ===== Env√≠o ===== */
async function sendMsg(){
  const t = (input.value || "").trim();
  if(!t) return;
  
  input.value = "";
  addMsg(t, "user");
  
  try {
    const reply = await askInstructor(t);
    addMsg(reply, "bot"); 
    speak(reply);
  } catch(e) {
    addMsg("Sorry, there was an error connecting to the server. Please try again.", "bot");
    console.error("Send message error:", e);
  }
}

/* ===== Eventos UI ===== */
send.addEventListener('click', sendMsg);

input.addEventListener('keydown', e => {
  if(e.key === "Enter" && !e.shiftKey){ 
    e.preventDefault(); 
    sendMsg(); 
  }
});

// Auto-resize textarea
input.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = (this.scrollHeight) + 'px';
});

mic.addEventListener('click', sttStart);
stopBtn.addEventListener('click', stopAll);

loadLessonBtn.addEventListener('click', () => {
  const inputValue = lessonInput.value;
  const lessonNumber = parseLessonInput(inputValue);
  
  if (lessonNumber) {
    // Limpiar chat al cambiar de lecci√≥n
    chat.innerHTML = '';
    loadLesson(lessonNumber);
  } else {
    statusEl.textContent = "Invalid lesson. Please enter a number (1-270) or name (e.g. 'lesson 1' or 'one')";
    statusEl.className = 'status error';
    addMsg("Please enter a valid lesson number (1-270) or name (e.g. 'lesson 1' or 'one').", "bot");
  }
});

lessonInput.addEventListener('keydown', e => {
  if(e.key === "Enter"){ 
    e.preventDefault(); 
    loadLessonBtn.click(); 
  }
});

/* ===== Inicializaci√≥n ===== */
(async function initApp(){
  const saved = +localStorage.getItem('smc.lesson') || 1;
  currentLesson = saved;
  
  // Bienvenida
  addMsg("Welcome to St. Mary's College English Leveler! üëã", "bot");
  addMsg("Please enter a lesson number (1-270) or name to begin. For example, type 'lesson 1' or 'one' and click 'Load Lesson'.", "bot");
  addMsg("I will teach ONLY the selected lesson, using its official content. Ask what you need to reinforce.", "bot");

  // Cargar lecci√≥n guardada si existe
  if (saved) {
    lessonInput.value = `Lesson ${saved}`;
    await loadLesson(saved);
  }
})();

// Mejorar accesibilidad
document.addEventListener('keydown', (e) => {
  // Atajo Ctrl+Enter para enviar
  if (e.ctrlKey && e.key === 'Enter') {
    sendMsg();
  }
  
  // Atajo Ctrl+Space para grabar
  if (e.ctrlKey && e.key === ' ') {
    e.preventDefault();
    sttStart();
  }
});
</script>
</body>
</html>
