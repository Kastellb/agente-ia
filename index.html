<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>St. Mary‚Äôs College ‚Äì English Leveling Bot (v1.9.4)</title>
  <style>
    :root{
      --bg:#f5f7fa; --ink:#0f172a; --bot:#0ea5e9; --user:#22c55e; --card:#ffffff; --muted:#64748b;
      --focus:#2563eb; --select:#fde047; --select-ink:#111827;
      --overlay: rgba(15,23,42,.55);
    }
    *{box-sizing:border-box}
    ::selection{ background:var(--select); color:var(--select-ink); }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--ink);
      display:flex; flex-direction:column; min-height:100vh;
    }
    header{
      background:#0b3b71; color:#fff; padding:12px 16px; display:flex; align-items:center; justify-content:space-between;
      font-weight:700;
    }
    header .right{ display:flex; gap:8px; }
    .btn{
      border:0; padding:10px 12px; font-weight:600; cursor:pointer; border-radius:10px; color:#fff;
      box-shadow:0 2px 6px rgba(2,8,23,.08);
    }
    .btn-picker{ background:#7c3aed; } /* Lesson Picker */
    .btn-stop{ background:#ef4444; }
    #chat{ flex:1; max-width:900px; width:100%; margin:16px auto; padding:0 12px; }
    .bubble{
      max-width:75%; padding:12px 14px; margin:8px 0; border-radius:14px; line-height:1.45;
      box-shadow:0 4px 12px rgba(2,8,23,.08);
    }
    .bot{ background:var(--bot); color:#fff; border-bottom-left-radius:4px; }
    .user{ background:var(--user); color:#fff; margin-left:auto; border-bottom-right-radius:4px; }
    .sys{ background:#e2e8f0; color:#0f172a; margin:16px auto; border-radius:10px; }
    .muted{ color:var(--muted); font-size:14px; }
    #controls{
      display:flex; gap:8px; padding:12px; background:#fff; border-top:1px solid #e2e8f0;
      position:sticky; bottom:0;
    }
    #controls > *{ border-radius:10px; }
    #textInput{
      flex:1; padding:12px 14px; font-size:16px; border:1px solid #cbd5e1; outline:0;
      transition:border .15s, box-shadow .15s;
    }
    #textInput:focus{
      border-color:var(--focus);
      box-shadow:0 0 0 3px rgba(37,99,235,.2);
    }
    #sendBtn{ background:#22c55e; }
    #speakBtn{ background:#0ea5e9; }
    #stopBtn{ background:#ef4444; }
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#e2e8f0; padding:1px 6px; border-radius:6px;}

    /* Picker (compacto, sin lista gigante) */
    #pickerOverlay{
      position:fixed; inset:0; background:var(--overlay); display:none; align-items:center; justify-content:center; z-index:50;
    }
    #pickerCard{
      width:min(560px, 92vw); background:#fff; border-radius:16px; padding:16px; box-shadow:0 16px 40px rgba(2,8,23,.35);
    }
    #pickerCard h3{ margin:0 0 10px 0; }
    .row{ display:flex; gap:10px; margin:10px 0; }
    .row input[type="number"], .row input[type="text"]{
      flex:1; padding:12px 14px; border:1px solid #cbd5e1; border-radius:10px; outline:0;
    }
    .row input:focus{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(37,99,235,.2); }
    .btn-go{ background:#0ea5e9; }
    .btn-close{ background:#334155; }

    .note{ font-size:14px; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <div>St. Mary‚Äôs College ‚Äì English Leveling Bot (v1.9.4)</div>
    <div class="right">
      <button class="btn btn-picker" id="openPickerBtn">üéØ Pick lesson</button>
      <button class="btn btn-stop" id="headerStopBtn">‚èπ Stop</button>
    </div>
  </header>

  <main id="chat"></main>

  <div id="controls">
    <input id="textInput" type="text" placeholder="Type or say your message‚Ä¶ e.g., ‚ÄúLesson 1‚Äù" autocomplete="off"/>
    <button id="sendBtn" class="btn">Send</button>
    <button id="speakBtn" class="btn">üé§ Speak</button>
    <button id="stopBtn"  class="btn">‚èπ Stop</button>
  </div>

  <!-- Picker overlay -->
  <div id="pickerOverlay" role="dialog" aria-modal="true">
    <div id="pickerCard">
      <h3>Pick a lesson</h3>
      <div class="note" id="pickerRangeNote">Loading available lessons‚Ä¶</div>
      <div class="row">
        <input id="pickerInput" type="number" min="1" max="270" placeholder="Type a lesson number (e.g., 12)"/>
        <button class="btn btn-go" id="pickerGoBtn">Go</button>
        <button class="btn btn-close" id="pickerCloseBtn">Close</button>
      </div>
      <div class="row">
        <input id="pickerWords" type="text" placeholder="Or type in words (e.g., twenty three)"/>
      </div>
      <div class="note">Tip: you can also type <span class="kbd">Lesson 12</span> directly in the chat.</div>
    </div>
  </div>

  <script>
    // ========= UI helpers =========
    const chat = document.getElementById("chat");
    const input = document.getElementById("textInput");
    const sendBtn = document.getElementById("sendBtn");
    const speakBtn = document.getElementById("speakBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const headerStopBtn = document.getElementById("headerStopBtn");

    function addMessage(html, role="bot"){
      const el = document.createElement("div");
      el.className = `bubble ${role}`;
      el.innerHTML = html;
      chat.appendChild(el);
      chat.scrollTop = chat.scrollHeight;
    }
    function addSystem(text){
      const el = document.createElement("div");
      el.className = "bubble sys";
      el.innerText = text;
      chat.appendChild(el);
      chat.scrollTop = chat.scrollHeight;
    }

    // ========= Speech (TTS) =========
    function speak(text, lang="en-US"){
      try{
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = lang;
        speechSynthesis.speak(u);
      }catch{}
    }

    // ========= Parse lesson number (1..270) =========
    function wordsToNumber(phrase) {
      const ones = {zero:0, one:1, two:2, three:3, four:4, five:5, six:6, seven:7, eight:8, nine:9};
      const teens = {ten:10, eleven:11, twelve:12, thirteen:13, fourteen:14, fifteen:15, sixteen:16, seventeen:17, eighteen:18, nineteen:19};
      const tens = {twenty:20, thirty:30, forty:40, fifty:50, sixty:60, seventy:70, eighty:80, ninety:90};
      let s = phrase.toLowerCase().replace(/-/g,' ').replace(/[^a-z\s]/g,' ').replace(/\s+/g,' ').trim();
      if(!s) return null;
      if(ones[s]!==undefined) return ones[s];
      if(teens[s]!==undefined) return teens[s];
      if(tens[s]!==undefined) return tens[s];
      const tokens = s.split(' ');
      let total=0, current=0;
      for(const w of tokens){
        if(ones[w]!==undefined){ current+=ones[w]; continue; }
        if(teens[w]!==undefined){ current+=teens[w]; continue; }
        if(tens[w]!==undefined){ current+=tens[w]; continue; }
        if(w==="hundred"){ if(current===0) current=1; current*=100; total+=current; current=0; continue; }
        if(w==="and"){ continue; }
        return null;
      }
      total+=current;
      return total||null;
    }
    function parseLessonNumberFromText(text){
      const s = text.toLowerCase();
      const mDigits = s.match(/lesson\s+(\d{1,3})\b/);
      if(mDigits){
        const n = parseInt(mDigits[1],10);
        if(n>=1 && n<=270) return n;
      }
      const mWords = s.match(/lesson\s+([a-z][a-z\s-]{1,60})$/i) || s.match(/lesson\s+([a-z][a-z\s-]{1,60})\b/i);
      if(mWords){
        const n = wordsToNumber(mWords[1]);
        if(n && n>=1 && n<=270) return n;
      }
      return null;
    }

    // ========= State =========
    let currentLesson = null;
    let lessonData = null;
    let availableLessons = []; // control estricto por index.json

    // ========= Lessons index =========
    async function fetchAvailableLessons(){
      try{
        const r = await fetch("https://www.leccion.datafast.pw/lessons/index.json",{cache:"no-store"});
        if(!r.ok) throw new Error("index not found");
        const idx = await r.json();
        const list = Array.isArray(idx.available) ? idx.available : [];
        availableLessons = list.map(n => parseInt(n,10)).filter(n=>!isNaN(n)).sort((a,b)=>a-b);
        return availableLessons;
      }catch{
        availableLessons = []; // sin √≠ndice ‚Üí no restringimos (pero avisamos)
        return [];
      }
    }

    // ========= Load lesson (respeta index.json) =========
    async function loadLesson(num){
      if(availableLessons.length && !availableLessons.includes(num)){
        addMessage(`Lesson ${num} is not available yet. Type a lesson from the available range.`, "bot");
        return;
      }
      try{
        const url = `https://www.leccion.datafast.pw/lessons/lesson${num}.json`;
        const res = await fetch(url, {cache:"no-store"});
        if(!res.ok) throw new Error("Lesson not found");
        lessonData = await res.json();
        currentLesson = num;
        localStorage.setItem("lastLesson", String(num));
        const intro = `
          <b>Welcome to Lesson ${num}: ${lessonData.title}</b><br><br>
          <b>Theory:</b> ${lessonData.theory || "This lesson will guide you through the basics."}<br><br>
          <b>Objectives:</b><br>- ${lessonData.objectives.join("<br>- ")}<br><br>
          <b>Topics:</b><br>- ${lessonData.topics.join("<br>- ")}<br><br>
          Ask me anything about this lesson and I will explain, correct, and reinforce.
        `;
        addMessage(intro, "bot");
        speak(`Welcome to Lesson ${num}: ${lessonData.title}. You can now ask me questions about this lesson.`, "en-US");
      }catch(e){
        addMessage(`Could not load Lesson ${num}.`, "bot");
      }
    }

    // ========= Teacher (JSON-first; Groq fallback) =========
    async function teacherResponse(userText){
      const q = userText.toLowerCase();
      let local = "";
      if(lessonData){
        if(/objective|goal/.test(q)){
          local = "Objectives:\n- " + lessonData.objectives.join("\n- ");
        }else if(/topic|point|content list/.test(q)){
          local = "Topics:\n- " + lessonData.topics.join("\n- ");
        }else if(/example|exercise|question/.test(q) && Array.isArray(lessonData.content) && lessonData.content.length){
          const qs = lessonData.content.map(c => "‚Ä¢ " + c.question).join("\n");
          local = "Sample questions:\n" + qs;
        }
      }
      if(local){
        addMessage(local.replace(/\n/g,"<br>"), "bot"); speak("Here you are.","en-US"); return;
      }
      const offTopic = ["soccer","football","cooking","politics","history","chemistry","physics"];
      if(offTopic.some(k => q.includes(k))){
        const msg = "Let's stay focused. We are practicing the current lesson topic.";
        addMessage(msg, "bot"); speak(msg,"en-US"); return;
      }
      let answer = "";
      try{
        const response = await fetch("https://bot-maestro-proxy.kast-mercadeo.workers.dev/", {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            text: `You are an English teacher at St. Mary's College.
The student asked: "${userText}".
1) If the student's sentence has grammar errors, first show a corrected version.
2) Then answer clearly in English with 2-3 short examples.
3) Stay strictly on the current lesson theme: ${lessonData ? lessonData.title : "current lesson"}.
4) Encourage politely and, if relevant, suggest a short practice line to repeat.` })
        });
        const data = await response.json();
        answer = data.reply || "(no reply)";
      }catch{
        const alternatives = [
          "We say 'Good morning' until noon. 'Good night' is a farewell, not a greeting.",
          "Formal greetings show respect, like 'Good morning'. Informal ones include 'Hi' or 'Hey'.",
          "Use 'There is' for singular and 'There are' for plural; questions: 'Is there‚Ä¶?' / 'Are there‚Ä¶?'."
        ];
        answer = alternatives[Math.floor(Math.random()*alternatives.length)];
      }
      addMessage(answer.replace(/\n/g,"<br>"), "bot"); speak(answer,"en-US");
    }

    // ========= Input handling =========
    async function handleUserMessage(text){
      if(!text) return;
      addMessage(text, "user");

      // Parse lesson from text
      const n = parseLessonNumberFromText(text);
      if(n){ await loadLesson(n); return; }

      if(lessonData){ await teacherResponse(text); }
      else { addMessage(`Please choose a lesson first (e.g., ‚ÄúLesson 1‚Äù).`, "bot"); }
    }
    function sendMessage(){
      const text = input.value.trim();
      input.value = "";
      handleUserMessage(text);
    }
    sendBtn.onclick = sendMessage;
    input.addEventListener("keydown", e => { if(e.key==="Enter") sendMessage(); });

    // ========= Speech Recognition =========
    let recognition;
    if("webkitSpeechRecognition" in window){
      recognition = new webkitSpeechRecognition();
      recognition.lang = "en-US"; recognition.interimResults = false; recognition.maxAlternatives = 1;
      recognition.onresult = e => { const t = e.results[0][0].transcript; handleUserMessage(t); };
    }
    speakBtn.onclick = () => recognition && recognition.start();
    function stopAll(){ if(recognition) recognition.stop(); speechSynthesis.cancel(); }
    stopBtn.onclick  = stopAll;
    headerStopBtn.onclick = stopAll;

    // ========= Picker (compacto) =========
    const pickerOverlay = document.getElementById("pickerOverlay");
    const openPickerBtn = document.getElementById("openPickerBtn");
    const pickerCloseBtn= document.getElementById("pickerCloseBtn");
    const pickerGoBtn   = document.getElementById("pickerGoBtn");
    const pickerInput   = document.getElementById("pickerInput");
    const pickerWords   = document.getElementById("pickerWords");
    const pickerRangeNote = document.getElementById("pickerRangeNote");

    function openPicker(){
      pickerOverlay.style.display = "flex";
      pickerInput.focus();
    }
    function closePicker(){
      pickerOverlay.style.display = "none";
      pickerInput.value = "";
      pickerWords.value = "";
    }
    async function goFromPicker(){
      let n = parseInt(pickerInput.value,10);
      if(!n && pickerWords.value.trim()){
        const w = wordsToNumber(pickerWords.value.trim());
        if(w) n = w;
      }
      if(!n){ addSystem("Please type a valid lesson number."); return; }
      if(availableLessons.length && !availableLessons.includes(n)){
        addSystem(`Lesson ${n} is not available. Choose a number within the available range.`);
        return;
      }
      closePicker();
      await loadLesson(n);
    }

    openPickerBtn.onclick = openPicker;
    pickerCloseBtn.onclick= closePicker;
    pickerGoBtn.onclick   = goFromPicker;
    pickerInput.addEventListener("keydown", e => { if(e.key==="Enter") goFromPicker(); });
    pickerWords.addEventListener("keydown", e => { if(e.key==="Enter") goFromPicker(); });
    pickerOverlay.addEventListener("click", e => { if(e.target===pickerOverlay) closePicker(); });

    // ========= Boot =========
    (async function init(){
      await fetchAvailableLessons();
      // Nota de rango disponible
      if(availableLessons.length){
        const min = availableLessons[0], max = availableLessons[availableLessons.length-1];
        pickerRangeNote.textContent = `Available range: Lesson ${min} to Lesson ${max} (${availableLessons.length} lessons).`;
        addMessage(`Welcome! Tell me which lesson you want to review (e.g., <span class="kbd">Lesson 1</span>). Available range now: Lesson ${min} to Lesson ${max}.`, "bot");
      }else{
        pickerRangeNote.textContent = `No index found. Create /lessons/index.json like {"available":[1,2,3]}.`;
        addMessage(`Welcome! Tell me which lesson you want to review (e.g., <span class="kbd">Lesson 1</span>). Tip: create <span class="kbd">/lessons/index.json</span> to control availability.`, "bot");
      }

      const last = parseInt(localStorage.getItem("lastLesson")||"0",10);
      if(last && (!availableLessons.length || availableLessons.includes(last))){
        addSystem(`Last time you studied Lesson ${last}. Type <Lesson ${last}> or press ‚ÄúüéØ Pick lesson‚Äù.`);
      }
    })();
  </script>
</body>
</html>


